<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ticket Manager â€” Tomoca Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- Add Supabase client library -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  /* All CSS styles remain the same as before */
  :root {
    --primary: #4e2b18;
    --secondary: #d4a373;
    --light: #f8f5f2;
    --dark: #2c1810;
    --card: #ffffff;
    --muted: #6b7280;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
    --info: #3b82f6;
    --border: #e5e7eb;
    --radius: 12px;
    --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    --shadow-hover: 0 8px 30px rgba(0, 0, 0, 0.12);
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  html, body {
    height: 100%;
    font-family: 'Poppins', system-ui, -apple-system, sans-serif;
    background: linear-gradient(135deg, var(--light) 0%, #f0ebe6 100%);
    color: var(--dark);
    line-height: 1.6;
  }

  body {
    padding: 24px;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    min-height: 100vh;
  }

  .container {
    width: 100%;
    max-width: 1400px;
  }

  /* Header */
  .header {
    background: var(--card);
    border-radius: var(--radius);
    padding: 28px 32px;
    margin-bottom: 24px;
    box-shadow: var(--shadow);
    border-left: 6px solid var(--primary);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 20px;
  }

  .header-content h1 {
    font-size: 26px;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .header-content p {
    color: var(--muted);
    font-size: 14px;
    max-width: 700px;
  }

  .header-actions {
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
  }

  /* Button Styles */
  .btn {
    padding: 12px 20px;
    border-radius: 10px;
    border: none;
    font-family: 'Poppins', sans-serif;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    white-space: nowrap;
  }

  .btn-primary {
    background: linear-gradient(135deg, var(--primary), #6b3920);
    color: white;
  }

  .btn-primary:hover {
    background: linear-gradient(135deg, #6b3920, var(--primary));
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(78, 43, 24, 0.25);
  }

  .btn-secondary {
    background: var(--light);
    color: var(--dark);
    border: 1px solid var(--border);
  }

  .btn-secondary:hover {
    background: white;
    transform: translateY(-2px);
    box-shadow: var(--shadow);
  }

  .btn-success {
    background: linear-gradient(135deg, var(--success), #34d399);
    color: white;
  }

  .btn-danger {
    background: linear-gradient(135deg, var(--danger), #ef4444);
    color: white;
  }

  .btn-warning {
    background: linear-gradient(135deg, var(--warning), #fbbf24);
    color: white;
  }

  .btn-sm {
    padding: 8px 14px;
    font-size: 13px;
  }

  /* Stats Bar */
  .stats-bar {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    margin-bottom: 24px;
  }

  .stat-item {
    background: var(--card);
    border-radius: var(--radius);
    padding: 16px;
    flex: 1;
    min-width: 160px;
    display: flex;
    align-items: center;
    gap: 12px;
    box-shadow: var(--shadow);
    border-top: 4px solid var(--primary);
  }

  .stat-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white;
  }

  .stat-info h3 {
    font-size: 24px;
    font-weight: 700;
    line-height: 1;
    margin-bottom: 4px;
  }

  .stat-info p {
    color: var(--muted);
    font-size: 13px;
    font-weight: 500;
  }

  /* Filters Card */
  .filters-card {
    background: var(--card);
    border-radius: var(--radius);
    padding: 24px;
    margin-bottom: 24px;
    box-shadow: var(--shadow);
  }

  .filters-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 16px;
  }

  .filters-header h2 {
    font-size: 18px;
    color: var(--primary);
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .filters-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 16px;
  }

  .filter-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .filter-group label {
    font-size: 13px;
    font-weight: 600;
    color: var(--dark);
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .form-control {
    padding: 12px 16px;
    border-radius: 10px;
    border: 2px solid var(--border);
    font-family: 'Poppins', sans-serif;
    font-size: 14px;
    background: white;
    color: var(--dark);
    transition: all 0.3s ease;
  }

  .form-control:focus {
    outline: none;
    border-color: var(--secondary);
    box-shadow: 0 0 0 3px rgba(212, 163, 115, 0.2);
  }

  .search-container {
    position: relative;
    width: 100%;
  }

  .search-box {
    width: 100%;
    padding: 14px 20px 14px 48px;
    border-radius: 10px;
    border: 2px solid var(--border);
    font-size: 14px;
    background: white;
    transition: all 0.3s ease;
  }

  .search-box:focus {
    border-color: var(--secondary);
    box-shadow: 0 0 0 3px rgba(212, 163, 115, 0.2);
  }

  .search-icon {
    position: absolute;
    left: 16px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--muted);
  }

  /* Main Table Card */
  .table-card {
    background: var(--card);
    border-radius: var(--radius);
    overflow: hidden;
    box-shadow: var(--shadow);
    margin-bottom: 24px;
  }

  .table-header {
    padding: 24px;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 16px;
  }

  .table-header h2 {
    font-size: 18px;
    color: var(--primary);
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .table-tools {
    display: flex;
    gap: 12px;
    align-items: center;
  }

  .table-wrapper {
    overflow-x: auto;
  }

  .tickets-table {
    width: 100%;
    border-collapse: collapse;
    min-width: 1000px;
  }

  .tickets-table thead {
    background: linear-gradient(135deg, var(--primary), #5a3315);
    color: white;
  }

  .tickets-table th {
    padding: 16px 20px;
    text-align: left;
    font-weight: 600;
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    white-space: nowrap;
  }

  .tickets-table th i {
    margin-right: 8px;
  }

  .tickets-table tbody tr {
    border-bottom: 1px solid var(--border);
    transition: background-color 0.2s ease;
  }

  .tickets-table tbody tr:hover {
    background-color: rgba(248, 245, 242, 0.6);
  }

  .tickets-table tbody tr.selected {
    background: linear-gradient(90deg, rgba(139, 69, 19, 0.06), transparent);
  }

  .tickets-table td {
    padding: 18px 20px;
    vertical-align: middle;
  }

  .ticket-id {
    font-family: 'Courier New', monospace;
    font-weight: 600;
    color: var(--primary);
  }

  .ticket-user {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--secondary), var(--primary));
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 14px;
    flex-shrink: 0;
  }

  .user-info h4 {
    font-size: 14px;
    font-weight: 600;
    color: var(--dark);
    margin-bottom: 2px;
  }

  .user-info p {
    font-size: 12px;
    color: var(--muted);
  }

  /* Status Badges */
  .badge {
    padding: 8px 14px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  .badge-open {
    background-color: #ffedd5;
    color: #c2410c;
  }

  .badge-in_progress {
    background-color: #dbeafe;
    color: #1d4ed8;
  }

  .badge-resolved {
    background-color: #d1fae5;
    color: #065f46;
  }

  /* Urgency Indicators */
  .urgency {
    padding: 8px 14px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  .urgency-low {
    background-color: #d1fae5;
    color: #065f46;
  }

  .urgency-medium {
    background-color: #fef3c7;
    color: #92400e;
  }

  .urgency-high {
    background-color: #fee2e2;
    color: #991b1b;
  }

  .action-buttons {
    display: flex;
    gap: 8px;
  }

  .action-btn {
    padding: 8px 14px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: white;
    color: var(--dark);
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 12px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .action-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow);
  }

  .action-btn.view {
    background: var(--info);
    color: white;
    border-color: var(--info);
  }

  .action-btn.assign {
    background: var(--warning);
    color: white;
    border-color: var(--warning);
  }

  .action-btn.resolve {
    background: var(--success);
    color: white;
    border-color: var(--success);
  }

  .checkbox-cell {
    width: 40px;
    padding-right: 0;
  }

  .checkbox-cell input[type="checkbox"] {
    width: 18px;
    height: 18px;
    border-radius: 4px;
    border: 2px solid var(--border);
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .checkbox-cell input[type="checkbox"]:checked {
    background-color: var(--primary);
    border-color: var(--primary);
  }

  /* Pagination */
  .pagination {
    padding: 20px 24px;
    border-top: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 16px;
  }

  .pagination-info {
    color: var(--muted);
    font-size: 14px;
  }

  .pagination-controls {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .page-btn {
    min-width: 40px;
    height: 40px;
    border-radius: 10px;
    border: 1px solid var(--border);
    background: white;
    color: var(--dark);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .page-btn:hover:not(:disabled) {
    background: var(--light);
    border-color: var(--secondary);
  }

  .page-btn.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
  }

  .page-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* Loading States */
  .loading-container {
    padding: 40px;
    text-align: center;
  }

  .loading-spinner {
    width: 50px;
    height: 50px;
    border: 4px solid var(--border);
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Modal */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 20px;
  }

  .modal-content {
    background: white;
    border-radius: var(--radius);
    width: 100%;
    max-width: 700px;
    max-height: 85vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  }

  .modal-header {
    padding: 24px;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .modal-header h3 {
    color: var(--primary);
    font-size: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .modal-close {
    background: none;
    border: none;
    font-size: 24px;
    color: var(--muted);
    cursor: pointer;
    transition: color 0.3s ease;
    width: 40px;
    height: 40px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .modal-close:hover {
    background: var(--light);
    color: var(--danger);
  }

  .modal-body {
    padding: 24px;
  }

  .ticket-details-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }

  .detail-group label {
    display: block;
    font-size: 12px;
    color: var(--muted);
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
  }

  .detail-group .value {
    font-size: 15px;
    color: var(--dark);
    font-weight: 500;
  }

  .message-box {
    background: var(--light);
    border-radius: 12px;
    padding: 20px;
    margin-top: 10px;
    margin-bottom: 24px;
  }

  .message-box pre {
    white-space: pre-wrap;
    font-family: 'Poppins', sans-serif;
    font-size: 14px;
    line-height: 1.6;
    color: var(--dark);
  }

  .modal-actions {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin-top: 20px;
  }

  /* Toast Notification */
  .toast {
    position: fixed;
    right: 24px;
    bottom: 24px;
    background: var(--dark);
    color: white;
    padding: 16px 20px;
    border-radius: 10px;
    box-shadow: var(--shadow-hover);
    display: none;
    align-items: center;
    gap: 12px;
    z-index: 1001;
    max-width: 400px;
    animation: slideIn 0.3s ease;
  }

  .toast.success {
    background: linear-gradient(135deg, var(--success), #34d399);
  }

  .toast.error {
    background: linear-gradient(135deg, var(--danger), #f87171);
  }

  .toast.warning {
    background: linear-gradient(135deg, var(--warning), #fbbf24);
  }

  @keyframes slideIn {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  /* Empty State */
  .empty-state {
    padding: 60px 20px;
    text-align: center;
    color: var(--muted);
  }

  .empty-state i {
    font-size: 60px;
    margin-bottom: 20px;
    color: var(--border);
  }

  .empty-state h3 {
    font-size: 18px;
    margin-bottom: 10px;
    color: var(--dark);
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .container {
      max-width: 100%;
    }
    
    .stats-bar {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 768px) {
    body {
      padding: 16px;
    }
    
    .header {
      padding: 20px;
      flex-direction: column;
      align-items: flex-start;
    }
    
    .header-actions {
      width: 100%;
      flex-direction: column;
    }
    
    .header-actions .btn {
      width: 100%;
      justify-content: center;
    }
    
    .filters-grid {
      grid-template-columns: 1fr;
    }
    
    .table-header {
      flex-direction: column;
      align-items: flex-start;
    }
    
    .table-tools {
      width: 100%;
      justify-content: space-between;
    }
    
    .pagination {
      flex-direction: column;
      text-align: center;
    }
    
    .modal-content {
      padding: 0;
    }
    
    .modal-actions {
      flex-direction: column;
    }
    
    .modal-actions .btn {
      width: 100%;
      justify-content: center;
    }
  }

  @media (max-width: 576px) {
    .stats-bar {
      grid-template-columns: 1fr;
    }
    
    .action-buttons {
      flex-direction: column;
    }
    
    .action-btn {
      width: 100%;
      justify-content: center;
    }
  }
</style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header class="header">
      <div class="header-content">
        <h1><i class="fas fa-ticket-alt"></i> Ticket Manager</h1>
        <p>Manage all customer support tickets from Supabase. Filter, assign, resolve, and export tickets.</p>
      </div>
      <div class="header-actions">
        <button class="btn btn-primary" id="refreshBtn">
          <i class="fas fa-sync-alt"></i> Refresh All
        </button>
        <button class="btn btn-success" id="exportCsv">
          <i class="fas fa-file-export"></i> Export CSV
        </button>
      </div>
    </header>

    <!-- Stats Bar -->
    <div class="stats-bar">
      <div class="stat-item">
        <div class="stat-icon">
          <i class="fas fa-clock"></i>
        </div>
        <div class="stat-info">
          <h3 id="statOpen">0</h3>
          <p>Open Tickets</p>
        </div>
      </div>
      <div class="stat-item">
        <div class="stat-icon">
          <i class="fas fa-spinner"></i>
        </div>
        <div class="stat-info">
          <h3 id="statInProgress">0</h3>
          <p>In Progress</p>
        </div>
      </div>
      <div class="stat-item">
        <div class="stat-icon">
          <i class="fas fa-check-circle"></i>
        </div>
        <div class="stat-info">
          <h3 id="statResolved">0</h3>
          <p>Resolved</p>
        </div>
      </div>
      <div class="stat-item">
        <div class="stat-icon">
          <i class="fas fa-list-alt"></i>
        </div>
        <div class="stat-info">
          <h3 id="statTotal">0</h3>
          <p>Total Tickets</p>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="filters-card">
      <div class="filters-header">
        <h2><i class="fas fa-filter"></i> Filters & Search</h2>
        <button class="btn btn-sm btn-secondary" id="clearFiltersBtn">
          <i class="fas fa-times"></i> Clear Filters
        </button>
      </div>
      
      <div class="filters-grid">
        <div class="filter-group">
          <label for="search"><i class="fas fa-search"></i> Search Tickets</label>
          <div class="search-container">
            <input type="search" id="search" class="search-box" placeholder="Search by ID, name, department, or issue...">
            <i class="fas fa-search search-icon"></i>
          </div>
        </div>
        
        <div class="filter-group">
          <label for="statusFilter"><i class="fas fa-tag"></i> Status</label>
          <select id="statusFilter" class="form-control">
            <option value="all">All Statuses</option>
            <option value="Open">Open</option>
            <option value="In Progress">In Progress</option>
            <option value="Resolved">Resolved</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label for="urgencyFilter"><i class="fas fa-exclamation-circle"></i> Urgency</label>
          <select id="urgencyFilter" class="form-control">
            <option value="all">All Urgencies</option>
            <option value="low">Low</option>
            <option value="medium">Medium</option>
            <option value="high">High</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label for="department"><i class="fas fa-building"></i> Department</label>
          <input type="text" id="department" class="form-control" placeholder="Filter by department...">
        </div>
      </div>
    </div>

    <!-- Main Table -->
    <div class="table-card">
      <div class="table-header">
        <h2><i class="fas fa-tickets"></i> All Tickets</h2>
        <div class="table-tools">
          <button class="btn btn-sm btn-success" id="bulkResolve">
            <i class="fas fa-check-double"></i> Resolve Selected
          </button>
          <button class="btn btn-sm btn-warning" id="bulkAssign">
            <i class="fas fa-user-tag"></i> Assign Selected
          </button>
        </div>
      </div>
      
      <div class="table-wrapper">
        <table class="tickets-table" id="ticketsTable">
          <thead>
            <tr>
              <th class="checkbox-cell">
                <input id="selectAll" type="checkbox" aria-label="Select all tickets">
              </th>
              <th><i class="fas fa-hashtag"></i> ID</th>
              <th><i class="fas fa-user"></i> Customer</th>
              <th><i class="fas fa-building"></i> Department</th>
              <th><i class="fas fa-exclamation-circle"></i> Urgency</th>
              <th><i class="fas fa-tag"></i> Status</th>
              <th><i class="fas fa-calendar"></i> Created</th>
              <th><i class="fas fa-cogs"></i> Actions</th>
            </tr>
          </thead>
          <tbody id="ticketsTableBody">
            <!-- Tickets will be loaded here -->
          </tbody>
        </table>
      </div>
      
      <div class="loading-container" id="loadingIndicator">
        <div class="loading-spinner"></div>
        <p>Loading all tickets from database...</p>
      </div>
      
      <div class="empty-state" id="emptyState" style="display: none;">
        <i class="fas fa-inbox"></i>
        <h3>No Tickets Found</h3>
        <p>No tickets match your current filters. Try adjusting your search criteria.</p>
      </div>
      
      <div class="pagination" id="paginationControls" style="display: none;">
        <div class="pagination-info" id="pageInfo"></div>
        <div class="pagination-controls">
          <button class="page-btn" id="prevPageBtn" disabled>
            <i class="fas fa-chevron-left"></i>
          </button>
          <div id="pageNumbers" style="display: flex; gap: 4px;">
            <!-- Page numbers will be inserted here -->
          </div>
          <button class="page-btn" id="nextPageBtn">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>
    </div>
    
    <div id="meta" style="color: var(--muted); font-size: 13px; text-align: center; margin-top: 8px;">
      <span id="lastUpdated">Last updated: --:--:--</span>
    </div>
  </div>

  <!-- Ticket Details Modal -->
  <div class="modal-overlay" id="ticketModal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle"><i class="fas fa-ticket-alt"></i> Ticket Details</h3>
        <button class="modal-close" id="closeModalBtn">&times;</button>
      </div>
      <div class="modal-body" id="modalBody">
        <!-- Ticket details will be loaded here -->
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div class="toast" id="toast"></div>

<script>
  (function() {
    // Supabase Configuration
    const SUPABASE_URL = 'https://zdxjvqmwblcpewogcxmd.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpkeGp2cW13YmxjcGV3b2djeG1kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5NjU0MjIsImV4cCI6MjA4MTU0MTQyMn0.JKvDcX9MTUESD1e3fAWN_SeUzojUaaez5ZXOwPU8psM';
    
    // Initialize Supabase client
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    // State
    let state = {
      allTickets: [],
      filteredTickets: [],
      currentPage: 1,
      ticketsPerPage: 20,
      totalPages: 1,
      selectedTickets: new Set(),
      lastFetchTime: null,
      isLoading: false,
      totalTickets: 0
    };
    
    // DOM Elements
    const elements = {
      // Stats
      statOpen: document.getElementById('statOpen'),
      statInProgress: document.getElementById('statInProgress'),
      statResolved: document.getElementById('statResolved'),
      statTotal: document.getElementById('statTotal'),
      
      // Table
      ticketsTableBody: document.getElementById('ticketsTableBody'),
      loadingIndicator: document.getElementById('loadingIndicator'),
      emptyState: document.getElementById('emptyState'),
      selectAll: document.getElementById('selectAll'),
      
      // Filters
      search: document.getElementById('search'),
      statusFilter: document.getElementById('statusFilter'),
      urgencyFilter: document.getElementById('urgencyFilter'),
      department: document.getElementById('department'),
      clearFiltersBtn: document.getElementById('clearFiltersBtn'),
      
      // Buttons
      refreshBtn: document.getElementById('refreshBtn'),
      exportCsv: document.getElementById('exportCsv'),
      bulkResolve: document.getElementById('bulkResolve'),
      bulkAssign: document.getElementById('bulkAssign'),
      
      // Modal
      ticketModal: document.getElementById('ticketModal'),
      closeModalBtn: document.getElementById('closeModalBtn'),
      modalTitle: document.getElementById('modalTitle'),
      modalBody: document.getElementById('modalBody'),
      
      // Pagination
      paginationControls: document.getElementById('paginationControls'),
      prevPageBtn: document.getElementById('prevPageBtn'),
      nextPageBtn: document.getElementById('nextPageBtn'),
      pageNumbers: document.getElementById('pageNumbers'),
      pageInfo: document.getElementById('pageInfo'),
      
      // Meta
      lastUpdated: document.getElementById('lastUpdated'),
      
      // Toast
      toast: document.getElementById('toast')
    };
    
    // Initialize
    document.addEventListener('DOMContentLoaded', init);
    
    async function init() {
      console.log('Initializing Ticket Manager with Supabase...');
      console.log('Supabase URL:', SUPABASE_URL);
      
      // Check if Supabase is accessible
      try {
        const { data, error } = await supabase.from('tickets').select('count', { count: 'exact', head: true });
        if (error) throw error;
        console.log('Connected to Supabase successfully');
      } catch (error) {
        console.error('Supabase connection error:', error);
        showToast('Error connecting to Supabase database', 'error');
      }
      
      attachEventListeners();
      await loadTickets();
      startAutoRefresh();
    }
    
    function attachEventListeners() {
      // Refresh button
      elements.refreshBtn.addEventListener('click', () => {
        elements.refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
        loadTickets().finally(() => {
          elements.refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh All';
        });
      });
      
      // Export CSV
      elements.exportCsv.addEventListener('click', exportToCSV);
      
      // Filter changes
      elements.search.addEventListener('input', debounce(applyFilters, 300));
      elements.statusFilter.addEventListener('change', applyFilters);
      elements.urgencyFilter.addEventListener('change', applyFilters);
      elements.department.addEventListener('input', debounce(applyFilters, 300));
      elements.clearFiltersBtn.addEventListener('click', clearFilters);
      
      // Bulk actions
      elements.bulkResolve.addEventListener('click', bulkResolveTickets);
      elements.bulkAssign.addEventListener('click', bulkAssignTickets);
      elements.selectAll.addEventListener('change', handleSelectAll);
      
      // Modal
      elements.closeModalBtn.addEventListener('click', closeModal);
      elements.ticketModal.addEventListener('click', (e) => {
        if (e.target === elements.ticketModal) closeModal();
      });
      
      // Pagination
      elements.prevPageBtn.addEventListener('click', () => changePage(state.currentPage - 1));
      elements.nextPageBtn.addEventListener('click', () => changePage(state.currentPage + 1));
      
      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeModal();
        if (e.key === 'r' && (e.ctrlKey || e.metaKey)) {
          e.preventDefault();
          loadTickets();
        }
        if (e.key === 'f' && document.activeElement !== elements.search) {
          e.preventDefault();
          elements.search.focus();
        }
      });
    }
    
    async function loadTickets() {
      if (state.isLoading) return;
      
      state.isLoading = true;
      showLoading(true);
      state.selectedTickets.clear();
      elements.selectAll.checked = false;
      
      try {
        console.log('Fetching tickets from Supabase...');
        
        // Build query
        let query = supabase
          .from('tickets')
          .select('*', { count: 'exact' });
        
        // Apply filters
        const status = elements.statusFilter.value;
        const urgency = elements.urgencyFilter.value;
        const department = elements.department.value;
        const search = elements.search.value;
        
        if (status && status !== 'all') {
          query = query.eq('status', status);
        }
        
        if (urgency && urgency !== 'all') {
          query = query.eq('urgency', urgency);
        }
        
        if (department) {
          query = query.ilike('department', `%${department}%`);
        }
        
        if (search) {
          query = query.or(`ticket_id.ilike.%${search}%,name.ilike.%${search}%,department.ilike.%${search}%,issue.ilike.%${search}%`);
        }
        
        // Apply pagination
        const from = (state.currentPage - 1) * state.ticketsPerPage;
        const to = from + state.ticketsPerPage - 1;
        query = query.range(from, to);
        
        // Order by created date (newest first)
        query = query.order('created_at', { ascending: false });
        
        // Execute query
        const { data: tickets, error, count } = await query;
        
        if (error) throw error;
        
        console.log(`Fetched ${tickets ? tickets.length : 0} tickets from Supabase`);
        
        if (tickets) {
          processTickets(tickets, count);
          state.lastFetchTime = new Date();
          updateLastUpdated();
          showToast(`Loaded ${tickets.length} tickets`, 'success');
        } else {
          processTickets([], 0);
          showToast('No tickets found', 'warning');
        }
        
      } catch (error) {
        console.error('Error loading tickets from Supabase:', error);
        showError(`Failed to load tickets: ${error.message}`);
        showToast('Failed to load tickets', 'error');
      } finally {
        state.isLoading = false;
        showLoading(false);
      }
    }
    
    function processTickets(tickets, total) {
      // Process and normalize ticket data
      state.allTickets = tickets.map(ticket => {
        // Normalize field names for consistency
        const ticketId = ticket.ticket_id || ticket.ticketId || ticket.id;
        const urgency = (ticket.urgency || 'medium').toLowerCase();
        const status = ticket.status || 'Open';
        
        return {
          id: ticket.id || ticket.ticketId || ticket.ticket_id,
          ticketId: ticketId,
          name: ticket.name || 'Anonymous',
          department: ticket.department || 'General',
          status: status,
          urgency: urgency,
          issue: ticket.issue || ticket.message || 'No description provided',
          message: ticket.issue || ticket.message || 'No description provided',
          createdAt: ticket.created_at || ticket.createdAt || ticket.timestamp || Date.now(),
          updatedAt: ticket.updated_at || ticket.updatedAt || ticket.created_at || Date.now(),
          contact: ticket.contact || 'N/A',
          telegramId: ticket.telegram_id || ticket.telegramId || '',
          assignedTo: ticket.assigned_to || ticket.assignedTo || '',
          rawData: ticket // Store raw data for reference
        };
      });
      
      state.totalTickets = total || state.allTickets.length;
      state.filteredTickets = [...state.allTickets];
      
      // Update stats
      updateStats();
      
      // Update pagination
      updatePagination();
      
      // Render current page
      renderCurrentPage();
      
      console.log(`Processed ${state.allTickets.length} tickets`);
    }
    
    function applyFilters() {
      // Reset to first page when filters change
      state.currentPage = 1;
      state.selectedTickets.clear();
      elements.selectAll.checked = false;
      
      // Load tickets with new filters
      loadTickets();
    }
    
    function clearFilters() {
      elements.search.value = '';
      elements.statusFilter.value = 'all';
      elements.urgencyFilter.value = 'all';
      elements.department.value = '';
      applyFilters();
    }
    
    function updateStats() {
      const stats = {
        Open: 0,
        'In Progress': 0,
        Resolved: 0,
        total: state.totalTickets
      };
      
      state.allTickets.forEach(ticket => {
        if (ticket.status === 'Open') stats.Open++;
        if (ticket.status === 'In Progress') stats['In Progress']++;
        if (ticket.status === 'Resolved') stats.Resolved++;
      });
      
      elements.statOpen.textContent = stats.Open;
      elements.statInProgress.textContent = stats['In Progress'];
      elements.statResolved.textContent = stats.Resolved;
      elements.statTotal.textContent = stats.total;
    }
    
    function updatePagination() {
      const totalFiltered = state.filteredTickets.length;
      state.totalPages = Math.ceil(state.totalTickets / state.ticketsPerPage) || 1;
      state.currentPage = Math.min(state.currentPage, state.totalPages);
      
      // Show/hide pagination
      if (state.totalPages > 1) {
        elements.paginationControls.style.display = 'flex';
      } else {
        elements.paginationControls.style.display = 'none';
      }
      
      // Update page info
      const start = (state.currentPage - 1) * state.ticketsPerPage + 1;
      const end = Math.min(state.currentPage * state.ticketsPerPage, state.totalTickets);
      elements.pageInfo.textContent = `Showing ${start}-${end} of ${state.totalTickets} tickets`;
      
      // Update pagination buttons
      elements.prevPageBtn.disabled = state.currentPage === 1;
      elements.nextPageBtn.disabled = state.currentPage === state.totalPages;
      
      // Update page number buttons
      updatePageNumbers();
    }
    
    function updatePageNumbers() {
      const pageNumbersContainer = elements.pageNumbers;
      pageNumbersContainer.innerHTML = '';
      
      // Always show first page
      addPageButton(1);
      
      // Calculate range of pages to show
      let startPage = Math.max(2, state.currentPage - 1);
      let endPage = Math.min(state.totalPages - 1, state.currentPage + 1);
      
      // Add ellipsis if needed
      if (startPage > 2) {
        pageNumbersContainer.innerHTML += '<span style="padding: 0 8px; color: var(--muted);">...</span>';
      }
      
      // Add middle pages
      for (let i = startPage; i <= endPage; i++) {
        if (i !== 1 && i !== state.totalPages) {
          addPageButton(i);
        }
      }
      
      // Add ellipsis if needed
      if (endPage < state.totalPages - 1) {
        pageNumbersContainer.innerHTML += '<span style="padding: 0 8px; color: var(--muted);">...</span>';
      }
      
      // Always show last page if there is more than one page
      if (state.totalPages > 1) {
        addPageButton(state.totalPages);
      }
    }
    
    function addPageButton(pageNumber) {
      const button = document.createElement('button');
      button.className = `page-btn ${pageNumber === state.currentPage ? 'active' : ''}`;
      button.textContent = pageNumber;
      button.dataset.page = pageNumber;
      button.addEventListener('click', () => changePage(pageNumber));
      elements.pageNumbers.appendChild(button);
    }
    
    function changePage(page) {
      if (page < 1 || page > state.totalPages) return;
      
      state.currentPage = page;
      loadTickets();
      
      // Scroll to top of table
      elements.ticketsTable.scrollIntoView({ behavior: 'smooth' });
    }
    
    function renderCurrentPage() {
      if (state.allTickets.length === 0) {
        elements.emptyState.style.display = 'block';
        elements.ticketsTableBody.innerHTML = '';
      } else {
        elements.emptyState.style.display = 'none';
        elements.ticketsTableBody.innerHTML = state.allTickets.map(renderTicketRow).join('');
        
        // Attach event listeners
        attachRowEventListeners();
      }
    }
    
    function renderTicketRow(ticket) {
      const formattedDate = formatDate(ticket.createdAt);
      const userName = ticket.name || 'Anonymous';
      const userInitials = userName.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
      const isSelected = state.selectedTickets.has(ticket.id);
      
      const statusClass = ticket.status.toLowerCase().replace(' ', '_');
      const urgencyClass = ticket.urgency.toLowerCase();
      
      return `
        <tr data-id="${escapeHtml(ticket.id)}" class="${isSelected ? 'selected' : ''}">
          <td class="checkbox-cell">
            <input type="checkbox" class="rowSelect" data-id="${escapeHtml(ticket.id)}" ${isSelected ? 'checked' : ''}>
          </td>
          <td><span class="ticket-id">${escapeHtml(ticket.ticketId)}</span></td>
          <td>
            <div class="ticket-user">
              <div class="user-avatar">${escapeHtml(userInitials)}</div>
              <div class="user-info">
                <h4>${escapeHtml(userName)}</h4>
                <p>${escapeHtml(ticket.contact)}</p>
              </div>
            </div>
          </td>
          <td>${escapeHtml(ticket.department)}</td>
          <td><span class="urgency urgency-${urgencyClass}">${escapeHtml(ticket.urgency)}</span></td>
          <td><span class="badge badge-${statusClass}">${escapeHtml(ticket.status)}</span></td>
          <td>${escapeHtml(formattedDate)}</td>
          <td>
            <div class="action-buttons">
              <button class="action-btn view" data-action="view" data-id="${escapeHtml(ticket.id)}" data-ticket-id="${escapeHtml(ticket.ticketId)}">
                <i class="fas fa-eye"></i> View
              </button>
              <button class="action-btn assign" data-action="assign" data-id="${escapeHtml(ticket.id)}" data-ticket-id="${escapeHtml(ticket.ticketId)}">
                <i class="fas fa-user-tag"></i> Assign
              </button>
              <button class="action-btn resolve" data-action="resolve" data-id="${escapeHtml(ticket.id)}" data-ticket-id="${escapeHtml(ticket.ticketId)}">
                <i class="fas fa-check"></i> Resolve
              </button>
            </div>
          </td>
        </tr>
      `;
    }
    
    function attachRowEventListeners() {
      // Row selection checkboxes
      document.querySelectorAll('.rowSelect').forEach(checkbox => {
        checkbox.addEventListener('change', (e) => {
          const ticketId = e.target.dataset.id;
          const row = e.target.closest('tr');
          
          if (e.target.checked) {
            state.selectedTickets.add(ticketId);
            row.classList.add('selected');
          } else {
            state.selectedTickets.delete(ticketId);
            row.classList.remove('selected');
          }
          
          // Update select all checkbox
          const allCheckboxes = document.querySelectorAll('.rowSelect');
          const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
          elements.selectAll.checked = allChecked && allCheckboxes.length > 0;
        });
      });
      
      // Action buttons
      document.querySelectorAll('[data-action]').forEach(button => {
        button.addEventListener('click', async (e) => {
          const action = e.target.closest('[data-action]').dataset.action;
          const ticketId = e.target.closest('[data-action]').dataset.id;
          const ticket = state.allTickets.find(t => t.id === ticketId);
          
          if (!ticket) return;
          
          switch (action) {
            case 'view':
              await viewTicketDetails(ticket);
              break;
            case 'assign':
              await assignTicket(ticket);
              break;
            case 'resolve':
              await resolveTicket(ticket);
              break;
          }
        });
      });
    }
    
    function handleSelectAll(e) {
      const isChecked = e.target.checked;
      const checkboxes = document.querySelectorAll('.rowSelect');
      
      checkboxes.forEach(checkbox => {
        checkbox.checked = isChecked;
        const ticketId = checkbox.dataset.id;
        const row = checkbox.closest('tr');
        
        if (isChecked) {
          state.selectedTickets.add(ticketId);
          row.classList.add('selected');
        } else {
          state.selectedTickets.delete(ticketId);
          row.classList.remove('selected');
        }
      });
    }
    
    async function viewTicketDetails(ticket) {
      try {
        // Fetch latest ticket data from Supabase
        const { data, error } = await supabase
          .from('tickets')
          .select('*')
          .eq('ticket_id', ticket.ticketId)
          .single();
        
        if (error) throw error;
        
        if (data) {
          // Update ticket with latest data
          ticket = {
            ...ticket,
            ...data,
            ticketId: data.ticket_id || data.ticketId,
            telegramId: data.telegram_id || data.telegramId,
            assignedTo: data.assigned_to || data.assignedTo,
            createdAt: data.created_at || data.createdAt,
            updatedAt: data.updated_at || data.updatedAt
          };
        }
      } catch (error) {
        console.error('Error fetching ticket details from Supabase:', error);
        // Continue with existing ticket data
      }
      
      const formattedDate = formatDate(ticket.createdAt);
      const updatedDate = formatDate(ticket.updatedAt);
      
      const statusClass = ticket.status.toLowerCase().replace(' ', '_');
      const urgencyClass = ticket.urgency.toLowerCase();
      
      elements.modalTitle.innerHTML = `<i class="fas fa-ticket-alt"></i> Ticket ${escapeHtml(ticket.ticketId)}`;
      elements.modalBody.innerHTML = `
        <div class="ticket-details-grid">
          <div class="detail-group">
            <label>Ticket ID</label>
            <div class="value"><code>${escapeHtml(ticket.ticketId)}</code></div>
          </div>
          <div class="detail-group">
            <label>Customer Name</label>
            <div class="value">${escapeHtml(ticket.name)}</div>
          </div>
          <div class="detail-group">
            <label>Contact Info</label>
            <div class="value">${escapeHtml(ticket.contact || 'Not provided')}</div>
          </div>
          <div class="detail-group">
            <label>Department</label>
            <div class="value">${escapeHtml(ticket.department)}</div>
          </div>
          <div class="detail-group">
            <label>Status</label>
            <div class="value"><span class="badge badge-${statusClass}">${escapeHtml(ticket.status)}</span></div>
          </div>
          <div class="detail-group">
            <label>Urgency</label>
            <div class="value"><span class="urgency urgency-${urgencyClass}">${escapeHtml(ticket.urgency)}</span></div>
          </div>
          <div class="detail-group">
            <label>Created</label>
            <div class="value">${escapeHtml(formattedDate)}</div>
          </div>
          <div class="detail-group">
            <label>Last Updated</label>
            <div class="value">${escapeHtml(updatedDate)}</div>
          </div>
          <div class="detail-group">
            <label>Telegram ID</label>
            <div class="value">${escapeHtml(ticket.telegramId || 'N/A')}</div>
          </div>
          <div class="detail-group">
            <label>Assigned To</label>
            <div class="value">${escapeHtml(ticket.assignedTo || 'Unassigned')}</div>
          </div>
        </div>
        
        <div class="detail-group" style="grid-column: 1 / -1;">
          <label>Issue / Message</label>
          <div class="message-box">
            <pre>${escapeHtml(ticket.issue)}</pre>
          </div>
        </div>
        
        <div class="modal-actions">
          <button class="btn btn-warning" onclick="window.assignTicketFromModal('${escapeHtml(ticket.ticketId)}')">
            <i class="fas fa-user-tag"></i> Assign to Me
          </button>
          <button class="btn btn-success" onclick="window.resolveTicketFromModal('${escapeHtml(ticket.ticketId)}')">
            <i class="fas fa-check-circle"></i> Mark Resolved
          </button>
          <button class="btn btn-primary" onclick="window.setInProgress('${escapeHtml(ticket.ticketId)}')">
            <i class="fas fa-spinner"></i> Set In Progress
          </button>
          <button class="btn btn-danger" onclick="window.deleteTicketFromModal('${escapeHtml(ticket.ticketId)}')">
            <i class="fas fa-trash"></i> Delete Ticket
          </button>
        </div>
      `;
      
      elements.ticketModal.style.display = 'flex';
      elements.ticketModal.setAttribute('aria-hidden', 'false');
    }
    
    function closeModal() {
      elements.ticketModal.style.display = 'none';
      elements.ticketModal.setAttribute('aria-hidden', 'true');
    }
    
    async function resolveTicket(ticket) {
      if (!confirm(`Are you sure you want to mark ticket ${ticket.ticketId} as resolved?`)) {
        return;
      }
      
      await updateTicketStatus(ticket.ticketId, 'Resolved');
    }
    
    async function assignTicket(ticket) {
      const assignee = prompt(`Assign ticket ${ticket.ticketId} to:`, 'IT Support');
      
      if (assignee === null || assignee.trim() === '') return;
      
      try {
        const { error } = await supabase
          .from('tickets')
          .update({ assigned_to: assignee.trim() })
          .eq('ticket_id', ticket.ticketId);
        
        if (error) throw error;
        
        showToast(`Ticket assigned to ${assignee}`, 'success');
        loadTickets();
      } catch (error) {
        console.error('Error assigning ticket in Supabase:', error);
        showToast(`Failed to assign ticket: ${error.message}`, 'error');
      }
    }
    
    async function updateTicketStatus(ticketId, status) {
      try {
        const { error } = await supabase
          .from('tickets')
          .update({ 
            status: status,
            updated_at: new Date().toISOString()
          })
          .eq('ticket_id', ticketId);
        
        if (error) throw error;
        
        showToast(`Ticket marked as ${status}`, 'success');
        closeModal();
        loadTickets();
      } catch (error) {
        console.error('Error updating ticket in Supabase:', error);
        showToast(`Failed to update ticket: ${error.message}`, 'error');
      }
    }
    
    async function deleteTicket(ticketId) {
      if (!confirm(`Are you sure you want to delete ticket ${ticketId}? This action cannot be undone.`)) {
        return;
      }
      
      try {
        const { error } = await supabase
          .from('tickets')
          .delete()
          .eq('ticket_id', ticketId);
        
        if (error) throw error;
        
        showToast(`Ticket deleted successfully`, 'success');
        closeModal();
        loadTickets();
      } catch (error) {
        console.error('Error deleting ticket from Supabase:', error);
        showToast(`Failed to delete ticket: ${error.message}`, 'error');
      }
    }
    
    async function bulkResolveTickets() {
      const selectedCount = state.selectedTickets.size;
      if (selectedCount === 0) {
        showToast('No tickets selected', 'warning');
        return;
      }
      
      if (!confirm(`Are you sure you want to mark ${selectedCount} ticket(s) as resolved?`)) {
        return;
      }
      
      const ticketIds = Array.from(state.selectedTickets);
      const ticketsToResolve = state.allTickets.filter(t => ticketIds.includes(t.id));
      
      let successCount = 0;
      let errorCount = 0;
      
      for (const ticket of ticketsToResolve) {
        try {
          const { error } = await supabase
            .from('tickets')
            .update({ 
              status: 'Resolved',
              updated_at: new Date().toISOString()
            })
            .eq('ticket_id', ticket.ticketId);
          
          if (error) throw error;
          successCount++;
        } catch (error) {
          console.error(`Error resolving ticket ${ticket.ticketId}:`, error);
          errorCount++;
        }
      }
      
      state.selectedTickets.clear();
      elements.selectAll.checked = false;
      
      // Reload tickets to reflect changes
      loadTickets();
      
      if (errorCount === 0) {
        showToast(`Resolved ${successCount} ticket(s)`, 'success');
      } else {
        showToast(`Resolved ${successCount} of ${selectedCount} ticket(s)`, 'warning');
      }
    }
    
    async function bulkAssignTickets() {
      const selectedCount = state.selectedTickets.size;
      if (selectedCount === 0) {
        showToast('No tickets selected', 'warning');
        return;
      }
      
      const assignee = prompt(`Assign ${selectedCount} ticket(s) to:`, 'IT Support');
      if (!assignee || assignee.trim() === '') return;
      
      const ticketIds = Array.from(state.selectedTickets);
      const ticketsToAssign = state.allTickets.filter(t => ticketIds.includes(t.id));
      
      let successCount = 0;
      let errorCount = 0;
      
      for (const ticket of ticketsToAssign) {
        try {
          const { error } = await supabase
            .from('tickets')
            .update({ 
              assigned_to: assignee.trim(),
              updated_at: new Date().toISOString()
            })
            .eq('ticket_id', ticket.ticketId);
          
          if (error) throw error;
          successCount++;
        } catch (error) {
          console.error(`Error assigning ticket ${ticket.ticketId}:`, error);
          errorCount++;
        }
      }
      
      // Update UI
      loadTickets();
      state.selectedTickets.clear();
      elements.selectAll.checked = false;
      
      if (errorCount === 0) {
        showToast(`Assigned ${successCount} ticket(s) to ${assignee}`, 'success');
      } else {
        showToast(`Assigned ${successCount} of ${selectedCount} ticket(s) to ${assignee}`, 'warning');
      }
    }
    
    function exportToCSV() {
      if (state.allTickets.length === 0) {
        showToast('No tickets to export', 'warning');
        return;
      }
      
      // Create CSV content
      const headers = ['Ticket ID', 'Customer Name', 'Department', 'Status', 'Urgency', 'Issue', 'Created', 'Contact', 'Telegram ID', 'Assigned To'];
      const csvRows = [];
      
      // Add headers
      csvRows.push(headers.join(','));
      
      // Add data rows
      state.allTickets.forEach(ticket => {
        const row = [
          `"${ticket.ticketId}"`,
          `"${ticket.name}"`,
          `"${ticket.department}"`,
          `"${ticket.status}"`,
          `"${ticket.urgency}"`,
          `"${(ticket.issue || '').replace(/"/g, '""')}"`,
          `"${new Date(ticket.createdAt).toISOString()}"`,
          `"${ticket.contact || ''}"`,
          `"${ticket.telegramId || ''}"`,
          `"${ticket.assignedTo || ''}"`
        ];
        csvRows.push(row.join(','));
      });
      
      const csvContent = csvRows.join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.setAttribute('href', url);
      link.setAttribute('download', `tomoca_tickets_${new Date().toISOString().split('T')[0]}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showToast(`Exported ${state.allTickets.length} tickets to CSV`, 'success');
    }
    
    function updateLastUpdated() {
      if (!state.lastFetchTime) return;
      
      const now = new Date();
      const diffMs = now - state.lastFetchTime;
      const diffSec = Math.floor(diffMs / 1000);
      const diffMin = Math.floor(diffSec / 60);
      
      let text = 'Last updated: ';
      if (diffSec < 60) {
        text += `${diffSec} second${diffSec !== 1 ? 's' : ''} ago`;
      } else if (diffMin < 60) {
        text += `${diffMin} minute${diffMin !== 1 ? 's' : ''} ago`;
      } else {
        text += state.lastFetchTime.toLocaleTimeString();
      }
      
      elements.lastUpdated.textContent = text;
    }
    
    function startAutoRefresh() {
      // Auto-refresh every 3 minutes
      setInterval(() => {
        if (!state.isLoading && document.visibilityState === 'visible') {
          loadTickets();
        }
      }, 180000); // 3 minutes
      
      // Update "last updated" every minute
      setInterval(updateLastUpdated, 60000);
    }
    
    function showLoading(show) {
      elements.loadingIndicator.style.display = show ? 'block' : 'none';
      if (show) {
        elements.ticketsTableBody.innerHTML = '';
      }
    }
    
    function showError(message) {
      elements.ticketsTableBody.innerHTML = `
        <tr>
          <td colspan="8" style="text-align: center; padding: 40px; color: var(--danger);">
            <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 16px;"></i>
            <h3 style="margin-bottom: 16px;">Error Loading Tickets</h3>
            <p style="margin-bottom: 16px;">${escapeHtml(message)}</p>
            <div style="display: flex; gap: 10px; justify-content: center;">
              <button class="btn btn-primary" onclick="window.loadTickets()">
                <i class="fas fa-redo"></i> Try Again
              </button>
            </div>
          </td>
        </tr>
      `;
    }
    
    function showToast(message, type = 'default') {
      const toast = elements.toast;
      toast.textContent = message;
      toast.className = 'toast';
      toast.classList.add(type);
      toast.style.display = 'flex';
      
      setTimeout(() => {
        toast.style.display = 'none';
      }, 4000);
    }
    
    // Utility functions
    function escapeHtml(str) {
      if (str === null || str === undefined) return '';
      return String(str).replace(/[&<>"']/g, s => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
      })[s]);
    }
    
    function formatDate(dateString) {
      try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) {
          return 'Invalid Date';
        }
        return date.toLocaleString('en-US', {
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      } catch (error) {
        return 'Invalid Date';
      }
    }
    
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
    
    // Make functions available globally for modal buttons
    window.assignTicketFromModal = async function(ticketId) {
      const ticket = state.allTickets.find(t => t.ticketId === ticketId);
      if (ticket) await assignTicket(ticket);
    };
    
    window.resolveTicketFromModal = async function(ticketId) {
      await updateTicketStatus(ticketId, 'Resolved');
    };
    
    window.setInProgress = async function(ticketId) {
      await updateTicketStatus(ticketId, 'In Progress');
    };
    
    window.deleteTicketFromModal = async function(ticketId) {
      await deleteTicket(ticketId);
    };
    
    // Expose loadTickets for error retry
    window.loadTickets = loadTickets;
    
  })();
</script>
</body>
</html>