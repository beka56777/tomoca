<!-- frontend/dashboard.html -->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<meta name="description" content="Tomoca Admin Dashboard - Manage all support tickets and users"/>
<title>Admin Dashboard — Tomoca Coffee Support</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  :root {
    --primary: #4e2b18;
    --secondary: #d4a373;
    --light: #f8f5f2;
    --dark: #2c1810;
    --card: #ffffff;
    --muted: #7d7d7d;
    --accent: #8B4513;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
    --info: #3b82f6;
    --border: #e5e7eb;
    --radius: 16px;
    --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    --shadow-hover: 0 8px 30px rgba(0, 0, 0, 0.12);
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  html, body {
    height: 100%;
    font-family: 'Poppins', sans-serif;
    color: var(--dark);
    background: linear-gradient(135deg, var(--light) 0%, #f0ebe6 100%);
    overflow-x: hidden;
  }

  body {
    min-height: 100vh;
    padding: 24px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  /* Navigation Bar */
  .admin-nav {
    background: var(--card);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 0;
    width: 100%;
    max-width: 1400px;
    margin-bottom: 24px;
    border-left: 4px solid var(--primary);
  }

  .nav-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 24px;
    height: 70px;
  }

  .nav-brand {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .nav-brand h2 {
    font-size: 20px;
    font-weight: 600;
    color: var(--primary);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .nav-brand h2 i {
    color: var(--secondary);
  }

  .nav-links {
    display: flex;
    list-style: none;
    gap: 8px;
    margin: 0;
    padding: 0;
  }

  .nav-links li {
    position: relative;
  }

  .nav-links a {
    color: var(--dark);
    text-decoration: none;
    font-weight: 500;
    font-size: 14px;
    padding: 12px 20px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: all 0.3s ease;
    white-space: nowrap;
  }

  .nav-links a i {
    font-size: 16px;
    width: 20px;
    text-align: center;
  }

  .nav-links a:hover {
    background: var(--light);
    color: var(--primary);
    transform: translateY(-2px);
  }

  .nav-links a.active {
    background: linear-gradient(135deg, var(--primary), #6b3920);
    color: white;
    box-shadow: 0 4px 15px rgba(78, 43, 24, 0.2);
  }

  .nav-links a.active:hover {
    background: linear-gradient(135deg, #6b3920, var(--primary));
  }

  .nav-links a.logout {
    background: var(--light);
    color: var(--danger);
    border: 1px solid var(--border);
  }

  .nav-links a.logout:hover {
    background: var(--danger);
    color: white;
    transform: translateY(-2px);
  }

  .nav-links a.logout i {
    color: var(--danger);
  }

  .nav-links a.logout:hover i {
    color: white;
  }

  .mobile-menu-btn {
    display: none;
    background: none;
    border: none;
    font-size: 24px;
    color: var(--primary);
    cursor: pointer;
    padding: 8px;
  }

  /* Main Container */
  .container {
    width: 100%;
    max-width: 1400px;
    display: flex;
    flex-direction: column;
    gap: 24px;
  }

  /* Header */
  .header {
    background: var(--card);
    border-radius: var(--radius);
    padding: 28px 32px;
    box-shadow: var(--shadow);
    border-left: 6px solid var(--primary);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 20px;
  }

  .header-content h1 {
    font-size: 28px;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .header-content h1 i {
    color: var(--secondary);
  }

  .header-content p {
    color: var(--muted);
    font-size: 15px;
    max-width: 700px;
  }

  .header-actions {
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
  }

  /* Tab Navigation */
  .tab-nav {
    display: flex;
    background: var(--card);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow: hidden;
    margin-bottom: 0;
  }

  .tab-btn {
    flex: 1;
    padding: 18px 24px;
    background: none;
    border: none;
    font-family: 'Poppins', sans-serif;
    font-weight: 600;
    font-size: 15px;
    color: var(--muted);
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    border-bottom: 3px solid transparent;
  }

  .tab-btn:hover {
    color: var(--primary);
    background: var(--light);
  }

  .tab-btn.active {
    color: var(--primary);
    border-bottom: 3px solid var(--primary);
    background: linear-gradient(to bottom, rgba(78, 43, 24, 0.05), transparent);
  }

  .tab-btn .badge {
    background: var(--primary);
    color: white;
    font-size: 12px;
    padding: 2px 8px;
    border-radius: 10px;
    min-width: 24px;
    text-align: center;
  }

  .tab-btn:not(.active) .badge {
    background: var(--muted);
  }

  /* Tab Content */
  .tab-content {
    display: none;
  }

  .tab-content.active {
    display: block;
  }

  /* Button Styles */
  .btn {
    padding: 12px 24px;
    border-radius: 12px;
    border: none;
    font-family: 'Poppins', sans-serif;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    white-space: nowrap;
  }

  .btn-primary {
    background: linear-gradient(135deg, var(--primary), #6b3920);
    color: white;
  }

  .btn-primary:hover {
    background: linear-gradient(135deg, #6b3920, var(--primary));
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(78, 43, 24, 0.25);
  }

  .btn-secondary {
    background: var(--light);
    color: var(--dark);
    border: 1px solid var(--border);
  }

  .btn-secondary:hover {
    background: white;
    transform: translateY(-2px);
    box-shadow: var(--shadow);
  }

  .btn-success {
    background: var(--success);
    color: white;
  }

  .btn-danger {
    background: var(--danger);
    color: white;
  }

  .btn-warning {
    background: var(--warning);
    color: white;
  }

  .btn-info {
    background: var(--info);
    color: white;
  }

  .btn-small {
    padding: 8px 16px;
    font-size: 13px;
  }

  /* Stats Grid */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 20px;
  }

  .stat-card {
    background: var(--card);
    border-radius: var(--radius);
    padding: 24px;
    box-shadow: var(--shadow);
    display: flex;
    align-items: center;
    gap: 20px;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .stat-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-hover);
  }

  .stat-icon {
    width: 60px;
    height: 60px;
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: white;
  }

  .stat-icon.open { background: linear-gradient(135deg, #f97316, #fb923c); }
  .stat-icon.progress { background: linear-gradient(135deg, #3b82f6, #60a5fa); }
  .stat-icon.resolved { background: linear-gradient(135deg, #10b981, #34d399); }
  .stat-icon.total { background: linear-gradient(135deg, #8b5cf6, #a78bfa); }
  .stat-icon.users { background: linear-gradient(135deg, #ec4899, #f472b6); }
  .stat-icon.active-users { background: linear-gradient(135deg, #10b981, #34d399); }
  .stat-icon.new-users { background: linear-gradient(135deg, #3b82f6, #60a5fa); }
  .stat-icon.task-log { background: linear-gradient(135deg, #8b5cf6, #a78bfa); }
  .stat-icon.pending-tasks { background: linear-gradient(135deg, #f59e0b, #fbbf24); }
  .stat-icon.completed-tasks { background: linear-gradient(135deg, #10b981, #34d399); }
  .stat-icon.avg-resolution { background: linear-gradient(135deg, #3b82f6, #60a5fa); }

  .stat-info h3 {
    font-size: 32px;
    font-weight: 700;
    color: var(--dark);
    line-height: 1;
    margin-bottom: 4px;
  }

  .stat-info p {
    color: var(--muted);
    font-size: 14px;
    font-weight: 500;
  }

  /* Controls Card */
  .controls-card {
    background: var(--card);
    border-radius: var(--radius);
    padding: 24px;
    box-shadow: var(--shadow);
  }

  .controls-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 16px;
  }

  .controls-header h2 {
    font-size: 20px;
    color: var(--primary);
    display: flex;
    align-items: center;
    gap: 10px;
  }

  /* Filters */
  .filters-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 20px;
  }

  .filter-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .filter-group label {
    font-size: 14px;
    font-weight: 600;
    color: var(--dark);
  }

  .form-control {
    padding: 12px 16px;
    border-radius: 10px;
    border: 2px solid var(--border);
    font-family: 'Poppins', sans-serif;
    font-size: 14px;
    background: white;
    color: var(--dark);
    transition: all 0.3s ease;
  }

  .form-control:focus {
    outline: none;
    border-color: var(--secondary);
    box-shadow: 0 0 0 3px rgba(212, 163, 115, 0.2);
  }

  /* Search Box */
  .search-container {
    position: relative;
    width: 100%;
  }

  .search-box {
    width: 100%;
    padding: 14px 20px 14px 48px;
    border-radius: 12px;
    border: 2px solid var(--border);
    font-size: 15px;
    background: white;
    transition: all 0.3s ease;
  }

  .search-box:focus {
    border-color: var(--secondary);
    box-shadow: 0 0 0 3px rgba(212, 163, 115, 0.2);
  }

  .search-icon {
    position: absolute;
    left: 16px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--muted);
  }

  /* Tickets Table */
  .tickets-table-container,
  .users-table-container,
  .task-log-container {
    background: var(--card);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow: hidden;
  }

  .table-header {
    padding: 24px;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 16px;
  }

  .table-header h2 {
    font-size: 20px;
    color: var(--primary);
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .table-tools {
    display: flex;
    gap: 12px;
    align-items: center;
  }

  .table-wrapper {
    overflow-x: auto;
  }

  .tickets-table,
  .users-table,
  .task-log-table {
    width: 100%;
    border-collapse: collapse;
    min-width: 1000px;
  }

  .tickets-table thead,
  .users-table thead,
  .task-log-table thead {
    background: linear-gradient(135deg, var(--primary), #5a3315);
    color: white;
  }

  .tickets-table th,
  .users-table th,
  .task-log-table th {
    padding: 18px 20px;
    text-align: left;
    font-weight: 600;
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .tickets-table th i,
  .users-table th i,
  .task-log-table th i {
    margin-right: 8px;
  }

  .tickets-table tbody tr,
  .users-table tbody tr,
  .task-log-table tbody tr {
    border-bottom: 1px solid var(--border);
    transition: background-color 0.2s ease;
  }

  .tickets-table tbody tr:hover,
  .users-table tbody tr:hover,
  .task-log-table tbody tr:hover {
    background-color: rgba(248, 245, 242, 0.6);
  }

  .tickets-table td,
  .users-table td,
  .task-log-table td {
    padding: 20px;
    vertical-align: middle;
  }

  .ticket-id {
    font-family: 'Courier New', monospace;
    font-weight: 600;
    color: var(--primary);
  }

  .ticket-user,
  .user-info-cell {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .user-avatar {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--secondary), var(--primary));
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 16px;
    flex-shrink: 0;
  }

  .user-info h4 {
    font-size: 15px;
    font-weight: 600;
    color: var(--dark);
  }

  .user-info p {
    font-size: 13px;
    color: var(--muted);
  }

  /* Status Badges */
  .badge {
    padding: 8px 14px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  .badge-open {
    background-color: #ffedd5;
    color: #c2410c;
  }

  .badge-in-progress {
    background-color: #dbeafe;
    color: #1d4ed8;
  }

  .badge-resolved {
    background-color: #d1fae5;
    color: #065f46;
  }

  /* User Status Badges */
  .badge-active {
    background-color: #d1fae5;
    color: #065f46;
  }

  .badge-inactive {
    background-color: #f3f4f6;
    color: #6b7280;
  }

  .badge-banned {
    background-color: #fee2e2;
    color: #991b1b;
  }

  .badge-admin {
    background-color: #e0e7ff;
    color: #3730a3;
  }

  /* Urgency Indicators */
  .urgency {
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  .urgency-low {
    background-color: #d1fae5;
    color: #065f46;
  }

  .urgency-medium {
    background-color: #fef3c7;
    color: #92400e;
  }

  .urgency-high {
    background-color: #fee2e2;
    color: #991b1b;
  }

  .ticket-actions,
  .user-actions,
  .task-actions {
    display: flex;
    gap: 8px;
  }

  .action-btn {
    width: 36px;
    height: 36px;
    border-radius: 10px;
    border: none;
    background: var(--light);
    color: var(--muted);
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .action-btn:hover {
    background: var(--secondary);
    color: white;
    transform: translateY(-2px);
  }

  .action-btn-danger:hover {
    background: var(--danger);
  }

  .action-btn-warning:hover {
    background: var(--warning);
  }

  .action-btn-success:hover {
    background: var(--success);
  }

  /* Pagination */
  .pagination {
    padding: 24px;
    border-top: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 16px;
  }

  .pagination-info {
    color: var(--muted);
    font-size: 14px;
  }

  .pagination-controls {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .page-btn {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    border: 1px solid var(--border);
    background: white;
    color: var(--dark);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .page-btn:hover:not(:disabled) {
    background: var(--light);
    border-color: var(--secondary);
  }

  .page-btn.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
  }

  .page-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* Loading States */
  .loading {
    padding: 40px;
    text-align: center;
    color: var(--muted);
  }

  .loading-spinner {
    width: 50px;
    height: 50px;
    border: 4px solid var(--border);
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Modal */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 20px;
  }

  .modal-content {
    background: white;
    border-radius: var(--radius);
    width: 100%;
    max-width: 800px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  }

  .modal-header {
    padding: 24px;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .modal-header h3 {
    color: var(--primary);
    font-size: 22px;
  }

  .modal-close {
    background: none;
    border: none;
    font-size: 24px;
    color: var(--muted);
    cursor: pointer;
    transition: color 0.3s ease;
  }

  .modal-close:hover {
    color: var(--danger);
  }

  .modal-body {
    padding: 24px;
  }

  .ticket-details-grid,
  .user-details-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }

  .detail-group label {
    display: block;
    font-size: 13px;
    color: var(--muted);
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
  }

  .detail-group .value {
    font-size: 16px;
    color: var(--dark);
    font-weight: 500;
  }

  .message-box {
    background: var(--light);
    border-radius: 12px;
    padding: 20px;
    margin-top: 10px;
  }

  .message-box p {
    line-height: 1.6;
    color: var(--dark);
  }

  /* User Details Specific */
  .user-avatar-large {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--secondary), var(--primary));
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 32px;
    margin: 0 auto 20px;
  }

  /* Footer */
  .footer {
    text-align: center;
    padding: 20px;
    color: var(--muted);
    font-size: 14px;
    width: 100%;
  }

  /* Task Form */
  .task-form-container {
    background: var(--card);
    border-radius: var(--radius);
    padding: 24px;
    box-shadow: var(--shadow);
    margin-bottom: 24px;
  }

  .task-form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 20px;
  }

  .form-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
  }

  /* Task Status Badges */
  .badge-pending {
    background-color: #fef3c7;
    color: #92400e;
  }

  .badge-in-progress {
    background-color: #dbeafe;
    color: #1d4ed8;
  }

  .badge-completed {
    background-color: #d1fae5;
    color: #065f46;
  }

  /* Priority Badges */
  .priority-high {
    background-color: #fee2e2;
    color: #991b1b;
  }

  .priority-medium {
    background-color: #fef3c7;
    color: #92400e;
  }

  .priority-low {
    background-color: #d1fae5;
    color: #065f46;
  }

  /* Ticket Assignee */
  .assignee-info {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .assignee-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--secondary), var(--primary));
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 12px;
    flex-shrink: 0;
  }

  /* Responsive */
  @media (max-width: 1200px) {
    .container {
      max-width: 100%;
    }
  }

  @media (max-width: 992px) {
    .mobile-menu-btn {
      display: block;
    }
    
    .nav-links {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow-hover);
      flex-direction: column;
      padding: 16px;
      gap: 8px;
      display: none;
      z-index: 100;
      margin-top: 10px;
    }
    
    .nav-links.active {
      display: flex;
    }
    
    .nav-links a {
      justify-content: space-between;
      padding: 16px 20px;
    }
    
    .nav-container {
      padding: 0 16px;
    }
  }

  @media (max-width: 768px) {
    body {
      padding: 16px;
    }
    
    .header {
      padding: 20px;
    }
    
    .header-content h1 {
      font-size: 24px;
    }
    
    .stats-grid {
      grid-template-columns: repeat(2, 1fr);
    }
    
    .tickets-table th,
    .tickets-table td,
    .users-table th,
    .users-table td,
    .task-log-table th,
    .task-log-table td {
      padding: 12px;
    }
    
    .nav-brand h2 {
      font-size: 18px;
    }
    
    .tab-btn {
      padding: 14px 16px;
      font-size: 14px;
    }
    
    .task-form-grid {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 576px) {
    .stats-grid {
      grid-template-columns: 1fr;
    }
    
    .filters-grid {
      grid-template-columns: 1fr;
    }
    
    .header-actions {
      flex-direction: column;
      width: 100%;
    }
    
    .header-actions .btn {
      width: 100%;
      justify-content: center;
    }
    
    .pagination {
      flex-direction: column;
      text-align: center;
    }
    
    .nav-container {
      height: 60px;
    }
    
    .nav-brand h2 {
      font-size: 16px;
    }
    
    .tab-nav {
      flex-direction: column;
    }
    
    .tab-btn {
      border-bottom: none;
      border-right: 3px solid transparent;
      justify-content: flex-start;
    }
    
    .tab-btn.active {
      border-bottom: none;
      border-right: 3px solid var(--primary);
    }
  }

  /* Empty State */
  .empty-state {
    padding: 60px 20px;
    text-align: center;
    color: var(--muted);
  }

  .empty-state i {
    font-size: 60px;
    margin-bottom: 20px;
    color: var(--border);
  }

  .empty-state h3 {
    font-size: 20px;
    margin-bottom: 10px;
    color: var(--dark);
  }
</style>
</head>
<body>
  <!-- Navigation Bar -->
  <nav class="admin-nav">
    <div class="nav-container">
      <div class="nav-brand">
        <h2><i class="fas fa-coffee"></i> Tomoca Admin</h2>
      </div>
      
      <button class="mobile-menu-btn" id="mobileMenuBtn">
        <i class="fas fa-bars"></i>
      </button>
      
      <ul class="nav-links" id="navLinks">
        <li>
          <a href="track.html" id="trackLink">
            <i class="fas fa-search"></i>
            <span>Track Ticket</span>
          </a>
        </li>
        <li>
          <a href="tickets.html" id="ticketsLink">
            <i class="fas fa-ticket-alt"></i>
            <span>All Tickets</span>
          </a>
        </li>
        <li>
          <a href="dashboard.html" class="active" id="dashboardLink">
            <i class="fas fa-chart-line"></i>
            <span>Dashboard</span>
          </a>
        </li>
        <li>
          <a href="history.html" id="historyLink">
            <i class="fas fa-history"></i>
            <span>History</span>
          </a>
        </li>
        <li>
          <a href="user-management.html" id="userManagementLink">
            <i class="fas fa-users"></i>
            <span>User Management</span>
          </a>
        </li>
        <li>
          <a href="#" class="logout" id="logoutLink">
            <i class="fas fa-sign-out-alt"></i>
            <span>Logout</span>
          </a>
        </li>
      </ul>
    </div>
  </nav>

  <!-- Main Container -->
  <div class="container">
    <!-- Header -->
    <header class="header">
      <div class="header-content">
        <h1><i class="fas fa-coffee"></i> Tomoca Coffee Support Dashboard</h1>
        <p>Manage all customer support tickets and users from Telegram. Monitor, filter, and update in real-time.</p>
      </div>
      <div class="header-actions">
        <button class="btn btn-primary" id="refreshBtn">
          <i class="fas fa-sync-alt"></i> Refresh Data
        </button>
        <a href="tickets.html?admin=" class="btn btn-secondary" id="managerLink">
          <i class="fas fa-ticket-alt"></i> Ticket Manager
        </a>
        <button class="btn btn-success" id="exportBtn">
          <i class="fas fa-download"></i> Export CSV
        </button>
      </div>
    </header>

    <!-- Tab Navigation -->
    <div class="tab-nav">
      <button class="tab-btn active" id="ticketsTab" data-tab="tickets">
        <i class="fas fa-ticket-alt"></i> Tickets
        <span class="badge" id="ticketsCount">0</span>
      </button>
      <button class="tab-btn" id="usersTab" data-tab="users">
        <i class="fas fa-users"></i> Users
        <span class="badge" id="usersCount">0</span>
      </button>
      <button class="tab-btn" id="taskLogTab" data-tab="taskLog">
        <i class="fas fa-tasks"></i> Task Log
        <span class="badge" id="taskLogCount">0</span>
      </button>
    </div>

    <!-- Tickets Tab Content -->
    <div class="tab-content active" id="ticketsTabContent">
      <!-- Stats Grid -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon open">
            <i class="fas fa-clock"></i>
          </div>
          <div class="stat-info">
            <h3 id="stat-open">0</h3>
            <p>Open Tickets</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon progress">
            <i class="fas fa-spinner"></i>
          </div>
          <div class="stat-info">
            <h3 id="stat-inprogress">0</h3>
            <p>In Progress</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon resolved">
            <i class="fas fa-check-circle"></i>
          </div>
          <div class="stat-info">
            <h3 id="stat-resolved">0</h3>
            <p>Resolved</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon avg-resolution">
            <i class="fas fa-hourglass-half"></i>
          </div>
          <div class="stat-info">
            <h3 id="stat-avg-resolution">0h</h3>
            <p>Avg. Resolution Time</p>
          </div>
        </div>
      </div>

      <!-- Filters -->
      <div class="controls-card">
        <div class="controls-header">
          <h2><i class="fas fa-filter"></i> Ticket Filters & Search</h2>
          <div class="table-tools">
            <button class="btn btn-secondary" id="clearFiltersBtn">
              <i class="fas fa-times"></i> Clear Filters
            </button>
            <button class="btn btn-info" id="assignToMeBtn">
              <i class="fas fa-user-plus"></i> Assign to Me
            </button>
          </div>
        </div>
        
        <div class="filters-grid">
          <div class="filter-group">
            <label for="searchInput"><i class="fas fa-search"></i> Search Tickets</label>
            <div class="search-container">
              <input type="text" id="searchInput" class="search-box" placeholder="Search by name, ID, department, or message...">
              <i class="fas fa-search search-icon"></i>
            </div>
          </div>
          
          <div class="filter-group">
            <label for="statusFilter"><i class="fas fa-tag"></i> Status</label>
            <select id="statusFilter" class="form-control">
              <option value="all">All Statuses</option>
              <option value="open">Open</option>
              <option value="in_progress">In Progress</option>
              <option value="resolved">Resolved</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label for="urgencyFilter"><i class="fas fa-exclamation-circle"></i> Urgency</label>
            <select id="urgencyFilter" class="form-control">
              <option value="all">All Urgency Levels</option>
              <option value="low">Low</option>
              <option value="medium">Medium</option>
              <option value="high">High</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label for="assigneeFilter"><i class="fas fa-user-tie"></i> Assignee</label>
            <select id="assigneeFilter" class="form-control">
              <option value="all">All Assignees</option>
              <option value="unassigned">Unassigned</option>
              <option value="me">Assigned to Me</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Tickets Table -->
      <div class="tickets-table-container">
        <div class="table-header">
          <h2><i class="fas fa-tickets"></i> All Tickets</h2>
          <div class="table-tools">
            <span class="pagination-info" id="tableInfo">Loading tickets...</span>
          </div>
        </div>
        
        <div class="table-wrapper">
          <table class="tickets-table" id="ticketsTable">
            <thead>
              <tr>
                <th><i class="fas fa-hashtag"></i> Ticket ID</th>
                <th><i class="fas fa-user"></i> Customer</th>
                <th><i class="fas fa-building"></i> Department</th>
                <th><i class="fas fa-tag"></i> Status</th>
                <th><i class="fas fa-exclamation-circle"></i> Urgency</th>
                <th><i class="fas fa-user-tie"></i> Assignee</th>
                <th><i class="fas fa-calendar"></i> Created</th>
                <th><i class="fas fa-ellipsis-h"></i> Actions</th>
              </tr>
            </thead>
            <tbody id="ticketsTableBody">
              <!-- Tickets will be loaded here -->
            </tbody>
          </table>
        </div>
        
        <div class="loading" id="ticketsLoading">
          <div class="loading-spinner"></div>
          <p>Loading all tickets from all sources...</p>
        </div>
        
        <div class="empty-state" id="ticketsEmptyState" style="display: none;">
          <i class="fas fa-inbox"></i>
          <h3>No Tickets Found</h3>
          <p>No tickets match your current filters. Try changing your search criteria.</p>
        </div>
        
        <div class="pagination" id="ticketsPagination" style="display: none;">
          <div class="pagination-info" id="ticketsPageInfo"></div>
          <div class="pagination-controls">
            <button class="page-btn" id="ticketsPrevPageBtn" disabled>
              <i class="fas fa-chevron-left"></i>
            </button>
            <button class="page-btn" id="ticketsPage1Btn" data-page="1">1</button>
            <button class="page-btn" id="ticketsPage2Btn" data-page="2">2</button>
            <button class="page-btn" id="ticketsPage3Btn" data-page="3">3</button>
            <span>...</span>
            <button class="page-btn" id="ticketsNextPageBtn">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Users Tab Content -->
    <div class="tab-content" id="usersTabContent">
      <!-- User Stats Grid -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon users">
            <i class="fas fa-users"></i>
          </div>
          <div class="stat-info">
            <h3 id="stat-total-users">0</h3>
            <p>Total Users</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon active-users">
            <i class="fas fa-user-check"></i>
          </div>
          <div class="stat-info">
            <h3 id="stat-active-users">0</h3>
            <p>Active Users</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon new-users">
            <i class="fas fa-user-plus"></i>
          </div>
          <div class="stat-info">
            <h3 id="stat-new-users-today">0</h3>
            <p>New Today</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon total">
            <i class="fas fa-ticket-alt"></i>
          </div>
          <div class="stat-info">
            <h3 id="stat-avg-tickets">0</h3>
            <p>Avg. Tickets/User</p>
          </div>
        </div>
      </div>

      <!-- User Filters -->
      <div class="controls-card">
        <div class="controls-header">
          <h2><i class="fas fa-filter"></i> User Filters & Search</h2>
          <div class="table-tools">
            <button class="btn btn-secondary" id="clearUserFiltersBtn">
              <i class="fas fa-times"></i> Clear Filters
            </button>
            <button class="btn btn-primary" id="refreshUsersBtn">
              <i class="fas fa-sync-alt"></i> Refresh Users
            </button>
          </div>
        </div>
        
        <div class="filters-grid">
          <div class="filter-group">
            <label for="userSearchInput"><i class="fas fa-search"></i> Search Users</label>
            <div class="search-container">
              <input type="text" id="userSearchInput" class="search-box" placeholder="Search by name, email, or ID...">
              <i class="fas fa-search search-icon"></i>
            </div>
          </div>
          
          <div class="filter-group">
            <label for="userStatusFilter"><i class="fas fa-user-tag"></i> Status</label>
            <select id="userStatusFilter" class="form-control">
              <option value="all">All Statuses</option>
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
              <option value="banned">Banned</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label for="userRoleFilter"><i class="fas fa-user-shield"></i> Role</label>
            <select id="userRoleFilter" class="form-control">
              <option value="all">All Roles</option>
              <option value="user">User</option>
              <option value="admin">Admin</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label for="userSortFilter"><i class="fas fa-sort"></i> Sort By</label>
            <select id="userSortFilter" class="form-control">
              <option value="newest">Newest First</option>
              <option value="oldest">Oldest First</option>
              <option value="name_asc">Name (A-Z)</option>
              <option value="name_desc">Name (Z-A)</option>
              <option value="tickets_desc">Most Tickets</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Users Table -->
      <div class="users-table-container">
        <div class="table-header">
          <h2><i class="fas fa-users"></i> All Users</h2>
          <div class="table-tools">
            <span class="pagination-info" id="usersTableInfo">Loading users...</span>
          </div>
        </div>
        
        <div class="table-wrapper">
          <table class="users-table" id="usersTable">
            <thead>
              <tr>
                <th><i class="fas fa-user"></i> User</th>
                <th><i class="fas fa-envelope"></i> Email</th>
                <th><i class="fas fa-shield-alt"></i> Role</th>
                <th><i class="fas fa-ticket-alt"></i> Tickets</th>
                <th><i class="fas fa-calendar"></i> Joined</th>
                <th><i class="fas fa-signal"></i> Status</th>
                <th><i class="fas fa-ellipsis-h"></i> Actions</th>
              </tr>
            </thead>
            <tbody id="usersTableBody">
              <!-- Users will be loaded here -->
            </tbody>
          </table>
        </div>
        
        <div class="loading" id="usersLoading">
          <div class="loading-spinner"></div>
          <p>Loading users from database...</p>
        </div>
        
        <div class="empty-state" id="usersEmptyState" style="display: none;">
          <i class="fas fa-users-slash"></i>
          <h3>No Users Found</h3>
          <p>No users match your current filters. Try changing your search criteria.</p>
        </div>
        
        <div class="pagination" id="usersPagination" style="display: none;">
          <div class="pagination-info" id="usersPageInfo"></div>
          <div class="pagination-controls">
            <button class="page-btn" id="usersPrevPageBtn" disabled>
              <i class="fas fa-chevron-left"></i>
            </button>
            <button class="page-btn" id="usersPage1Btn" data-page="1">1</button>
            <button class="page-btn" id="usersPage2Btn" data-page="2">2</button>
            <button class="page-btn" id="usersPage3Btn" data-page="3">3</button>
            <span>...</span>
            <button class="page-btn" id="usersNextPageBtn">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Task Log Tab Content -->
    <div class="tab-content" id="taskLogTabContent">
      <!-- Task Log Stats -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon task-log">
            <i class="fas fa-tasks"></i>
          </div>
          <div class="stat-info">
            <h3 id="stat-total-tasks">0</h3>
            <p>Total Tasks</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon pending-tasks">
            <i class="fas fa-clock"></i>
          </div>
          <div class="stat-info">
            <h3 id="stat-pending-tasks">0</h3>
            <p>Pending Tasks</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon completed-tasks">
            <i class="fas fa-check-circle"></i>
          </div>
          <div class="stat-info">
            <h3 id="stat-completed-tasks">0</h3>
            <p>Completed Today</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon avg-resolution">
            <i class="fas fa-hourglass-half"></i>
          </div>
          <div class="stat-info">
            <h3 id="stat-avg-task-duration">0h</h3>
            <p>Avg. Task Duration</p>
          </div>
        </div>
      </div>

      <!-- Task Log Form -->
      <div class="task-form-container">
        <div class="controls-header">
          <h2><i class="fas fa-plus-circle"></i> TOMOCA IT Department - Daily Task Log</h2>
          <button class="btn btn-primary" id="addTaskBtn">
            <i class="fas fa-plus"></i> Add Task
          </button>
        </div>
        
        <form id="taskForm">
          <div class="task-form-grid">
            <div class="filter-group">
              <label for="taskDate"><i class="fas fa-calendar"></i> Date</label>
              <input type="date" id="taskDate" class="form-control" required>
            </div>
            
            <div class="filter-group">
              <label for="taskPriority"><i class="fas fa-flag"></i> Priority</label>
              <select id="taskPriority" class="form-control" required>
                <option value="high">High</option>
                <option value="medium" selected>Medium</option>
                <option value="low">Low</option>
              </select>
            </div>
            
            <div class="filter-group">
              <label for="taskTicketId"><i class="fas fa-ticket-alt"></i> Ticket ID</label>
              <input type="text" id="taskTicketId" class="form-control" placeholder="Optional">
            </div>
            
            <div class="filter-group">
              <label for="taskDescription"><i class="fas fa-align-left"></i> Task Description</label>
              <textarea id="taskDescription" class="form-control" rows="2" placeholder="Describe the task..." required></textarea>
            </div>
            
            <div class="filter-group">
              <label for="taskStartTime"><i class="fas fa-play"></i> Start Time</label>
              <input type="time" id="taskStartTime" class="form-control" required>
            </div>
            
            <div class="filter-group">
              <label for="taskEndTime"><i class="fas fa-stop"></i> End Time</label>
              <input type="time" id="taskEndTime" class="form-control" required>
            </div>
            
            <div class="filter-group">
              <label for="taskDuration"><i class="fas fa-hourglass"></i> Duration (hours)</label>
              <input type="number" id="taskDuration" class="form-control" step="0.5" min="0" placeholder="Calculated automatically" readonly>
            </div>
            
            <div class="filter-group">
              <label for="taskStatus"><i class="fas fa-tag"></i> Status</label>
              <select id="taskStatus" class="form-control" required>
                <option value="pending">Pending</option>
                <option value="in_progress">In Progress</option>
                <option value="completed">Completed</option>
              </select>
            </div>
          </div>
          
          <div class="filter-group">
            <label for="taskNotes"><i class="fas fa-sticky-note"></i> Notes/Comments</label>
            <textarea id="taskNotes" class="form-control" rows="3" placeholder="Additional notes or comments..."></textarea>
          </div>
          
          <div class="form-actions">
            <button type="button" class="btn btn-secondary" id="cancelTaskBtn">
              <i class="fas fa-times"></i> Cancel
            </button>
            <button type="submit" class="btn btn-success" id="saveTaskBtn">
              <i class="fas fa-save"></i> Save Task
            </button>
          </div>
        </form>
      </div>

      <!-- Task Log Table -->
      <div class="task-log-container">
        <div class="table-header">
          <h2><i class="fas fa-tasks"></i> Daily Task Log</h2>
          <div class="table-tools">
            <span class="pagination-info" id="taskLogTableInfo">Loading tasks...</span>
            <button class="btn btn-info" id="exportTaskLogBtn">
              <i class="fas fa-download"></i> Export Task Log
            </button>
          </div>
        </div>
        
        <div class="table-wrapper">
          <table class="task-log-table" id="taskLogTable">
            <thead>
              <tr>
                <th><i class="fas fa-calendar"></i> Date</th>
                <th><i class="fas fa-flag"></i> Priority</th>
                <th><i class="fas fa-ticket-alt"></i> Ticket ID</th>
                <th><i class="fas fa-align-left"></i> Task Description</th>
                <th><i class="fas fa-play"></i> Start Time</th>
                <th><i class="fas fa-stop"></i> End Time</th>
                <th><i class="fas fa-hourglass"></i> Duration</th>
                <th><i class="fas fa-tag"></i> Status</th>
                <th><i class="fas fa-user-tie"></i> Assigned To</th>
                <th><i class="fas fa-sticky-note"></i> Notes</th>
                <th><i class="fas fa-ellipsis-h"></i> Actions</th>
              </tr>
            </thead>
            <tbody id="taskLogTableBody">
              <!-- Task log entries will be loaded here -->
            </tbody>
          </table>
        </div>
        
        <div class="loading" id="taskLogLoading">
          <div class="loading-spinner"></div>
          <p>Loading task log entries...</p>
        </div>
        
        <div class="empty-state" id="taskLogEmptyState" style="display: none;">
          <i class="fas fa-clipboard-list"></i>
          <h3>No Task Log Entries</h3>
          <p>Start by adding your first task log entry using the form above.</p>
        </div>
        
        <div class="pagination" id="taskLogPagination" style="display: none;">
          <div class="pagination-info" id="taskLogPageInfo"></div>
          <div class="pagination-controls">
            <button class="page-btn" id="taskLogPrevPageBtn" disabled>
              <i class="fas fa-chevron-left"></i>
            </button>
            <button class="page-btn" id="taskLogPage1Btn" data-page="1">1</button>
            <button class="page-btn" id="taskLogPage2Btn" data-page="2">2</button>
            <button class="page-btn" id="taskLogPage3Btn" data-page="3">3</button>
            <span>...</span>
            <button class="page-btn" id="taskLogNextPageBtn">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
      <p>Tomoca Coffee Support System • <span id="lastUpdated">Last updated: --:--:--</span></p>
      <p class="small" style="font-size: 12px; margin-top: 5px;">
        Connected to Telegram Bot & Supabase • All data is fetched in real-time
      </p>
    </footer>
  </div>

  <!-- Ticket Details Modal -->
  <div class="modal-overlay" id="ticketModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">Ticket Details</h3>
        <button class="modal-close" id="closeModalBtn">&times;</button>
      </div>
      <div class="modal-body" id="modalBody">
        <!-- Ticket details will be loaded here -->
      </div>
    </div>
  </div>

  <!-- User Details Modal -->
  <div class="modal-overlay" id="userModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="userModalTitle">User Details</h3>
        <button class="modal-close" id="closeUserModalBtn">&times;</button>
      </div>
      <div class="modal-body" id="userModalBody">
        <!-- User details will be loaded here -->
      </div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div class="modal-overlay" id="confirmModal">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h3 id="confirmModalTitle">Confirm Action</h3>
        <button class="modal-close" id="closeConfirmModalBtn">&times;</button>
      </div>
      <div class="modal-body" id="confirmModalBody">
        <!-- Confirmation message will be loaded here -->
      </div>
      <div class="modal-footer" style="padding: 20px; display: flex; gap: 12px; justify-content: flex-end; border-top: 1px solid var(--border);">
        <button class="btn btn-secondary" id="cancelConfirmBtn">Cancel</button>
        <button class="btn btn-danger" id="confirmActionBtn">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Assign Ticket Modal -->
  <div class="modal-overlay" id="assignModal">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h3>Assign Ticket</h3>
        <button class="modal-close" id="closeAssignModalBtn">&times;</button>
      </div>
      <div class="modal-body">
        <div class="filter-group">
          <label for="assignToUser"><i class="fas fa-user-tie"></i> Assign To</label>
          <select id="assignToUser" class="form-control">
            <option value="">Select admin...</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="assignNotes"><i class="fas fa-sticky-note"></i> Notes (Optional)</label>
          <textarea id="assignNotes" class="form-control" rows="3" placeholder="Add assignment notes..."></textarea>
        </div>
      </div>
      <div class="modal-footer" style="padding: 20px; display: flex; gap: 12px; justify-content: flex-end; border-top: 1px solid var(--border);">
        <button class="btn btn-secondary" id="cancelAssignBtn">Cancel</button>
        <button class="btn btn-primary" id="confirmAssignBtn">Assign</button>
      </div>
    </div>
  </div>

<script src="js/utils.js"></script>
<script src="js/admin.js"></script>
<!-- Include Supabase JS for proper logout -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  (function() {
    // IMPORTANT: These should match the credentials in index.html
    const SUPABASE_URL = 'https://zdxjvqmwblcpewogcxmd.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpkeGp2cW13YmxjcGV3b2djeG1kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5NjU0MjIsImV4cCI6MjA4MTU0MTQyMn0.JKvDcX9MTUESD1e3fAWN_SeUzojUaaez5ZXOwPU8psM';
    
    // Initialize Supabase
    let supabase;
    try {
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      console.log('Supabase initialized successfully for dashboard');
    } catch (error) {
      console.error('Failed to initialize Supabase:', error);
    }
    
    // DOM Elements
    const elements = {
      // Navigation
      mobileMenuBtn: document.getElementById('mobileMenuBtn'),
      navLinks: document.getElementById('navLinks'),
      trackLink: document.getElementById('trackLink'),
      ticketsLink: document.getElementById('ticketsLink'),
      dashboardLink: document.getElementById('dashboardLink'),
      historyLink: document.getElementById('historyLink'),
      userManagementLink: document.getElementById('userManagementLink'),
      logoutLink: document.getElementById('logoutLink'),
      
      // Tab Navigation
      ticketsTab: document.getElementById('ticketsTab'),
      usersTab: document.getElementById('usersTab'),
      taskLogTab: document.getElementById('taskLogTab'),
      ticketsTabContent: document.getElementById('ticketsTabContent'),
      usersTabContent: document.getElementById('usersTabContent'),
      taskLogTabContent: document.getElementById('taskLogTabContent'),
      ticketsCount: document.getElementById('ticketsCount'),
      usersCount: document.getElementById('usersCount'),
      taskLogCount: document.getElementById('taskLogCount'),
      
      // Tickets Stats
      statOpen: document.getElementById('stat-open'),
      statInProgress: document.getElementById('stat-inprogress'),
      statResolved: document.getElementById('stat-resolved'),
      statAvgResolution: document.getElementById('stat-avg-resolution'),
      
      // Users Stats
      statTotalUsers: document.getElementById('stat-total-users'),
      statActiveUsers: document.getElementById('stat-active-users'),
      statNewUsersToday: document.getElementById('stat-new-users-today'),
      statAvgTickets: document.getElementById('stat-avg-tickets'),
      
      // Task Log Stats
      statTotalTasks: document.getElementById('stat-total-tasks'),
      statPendingTasks: document.getElementById('stat-pending-tasks'),
      statCompletedTasks: document.getElementById('stat-completed-tasks'),
      statAvgTaskDuration: document.getElementById('stat-avg-task-duration'),
      
      // Tickets Table
      ticketsTableBody: document.getElementById('ticketsTableBody'),
      ticketsLoading: document.getElementById('ticketsLoading'),
      ticketsEmptyState: document.getElementById('ticketsEmptyState'),
      tableInfo: document.getElementById('tableInfo'),
      
      // Users Table
      usersTableBody: document.getElementById('usersTableBody'),
      usersLoading: document.getElementById('usersLoading'),
      usersEmptyState: document.getElementById('usersEmptyState'),
      usersTableInfo: document.getElementById('usersTableInfo'),
      
      // Task Log Table
      taskLogTableBody: document.getElementById('taskLogTableBody'),
      taskLogLoading: document.getElementById('taskLogLoading'),
      taskLogEmptyState: document.getElementById('taskLogEmptyState'),
      taskLogTableInfo: document.getElementById('taskLogTableInfo'),
      
      // Tickets Filters
      searchInput: document.getElementById('searchInput'),
      statusFilter: document.getElementById('statusFilter'),
      urgencyFilter: document.getElementById('urgencyFilter'),
      assigneeFilter: document.getElementById('assigneeFilter'),
      clearFiltersBtn: document.getElementById('clearFiltersBtn'),
      assignToMeBtn: document.getElementById('assignToMeBtn'),
      
      // Users Filters
      userSearchInput: document.getElementById('userSearchInput'),
      userStatusFilter: document.getElementById('userStatusFilter'),
      userRoleFilter: document.getElementById('userRoleFilter'),
      userSortFilter: document.getElementById('userSortFilter'),
      clearUserFiltersBtn: document.getElementById('clearUserFiltersBtn'),
      refreshUsersBtn: document.getElementById('refreshUsersBtn'),
      
      // Task Log Form
      taskForm: document.getElementById('taskForm'),
      taskDate: document.getElementById('taskDate'),
      taskPriority: document.getElementById('taskPriority'),
      taskTicketId: document.getElementById('taskTicketId'),
      taskDescription: document.getElementById('taskDescription'),
      taskStartTime: document.getElementById('taskStartTime'),
      taskEndTime: document.getElementById('taskEndTime'),
      taskDuration: document.getElementById('taskDuration'),
      taskStatus: document.getElementById('taskStatus'),
      taskNotes: document.getElementById('taskNotes'),
      addTaskBtn: document.getElementById('addTaskBtn'),
      cancelTaskBtn: document.getElementById('cancelTaskBtn'),
      saveTaskBtn: document.getElementById('saveTaskBtn'),
      exportTaskLogBtn: document.getElementById('exportTaskLogBtn'),
      
      // Buttons
      refreshBtn: document.getElementById('refreshBtn'),
      exportBtn: document.getElementById('exportBtn'),
      managerLink: document.getElementById('managerLink'),
      
      // Modals
      ticketModal: document.getElementById('ticketModal'),
      closeModalBtn: document.getElementById('closeModalBtn'),
      modalTitle: document.getElementById('modalTitle'),
      modalBody: document.getElementById('modalBody'),
      
      userModal: document.getElementById('userModal'),
      closeUserModalBtn: document.getElementById('closeUserModalBtn'),
      userModalTitle: document.getElementById('userModalTitle'),
      userModalBody: document.getElementById('userModalBody'),
      
      confirmModal: document.getElementById('confirmModal'),
      closeConfirmModalBtn: document.getElementById('closeConfirmModalBtn'),
      confirmModalTitle: document.getElementById('confirmModalTitle'),
      confirmModalBody: document.getElementById('confirmModalBody'),
      cancelConfirmBtn: document.getElementById('cancelConfirmBtn'),
      confirmActionBtn: document.getElementById('confirmActionBtn'),
      
      assignModal: document.getElementById('assignModal'),
      closeAssignModalBtn: document.getElementById('closeAssignModalBtn'),
      cancelAssignBtn: document.getElementById('cancelAssignBtn'),
      confirmAssignBtn: document.getElementById('confirmAssignBtn'),
      assignToUser: document.getElementById('assignToUser'),
      assignNotes: document.getElementById('assignNotes'),
      
      // Tickets Pagination
      ticketsPagination: document.getElementById('ticketsPagination'),
      ticketsPrevPageBtn: document.getElementById('ticketsPrevPageBtn'),
      ticketsNextPageBtn: document.getElementById('ticketsNextPageBtn'),
      ticketsPage1Btn: document.getElementById('ticketsPage1Btn'),
      ticketsPage2Btn: document.getElementById('ticketsPage2Btn'),
      ticketsPage3Btn: document.getElementById('ticketsPage3Btn'),
      ticketsPageInfo: document.getElementById('ticketsPageInfo'),
      
      // Users Pagination
      usersPagination: document.getElementById('usersPagination'),
      usersPrevPageBtn: document.getElementById('usersPrevPageBtn'),
      usersNextPageBtn: document.getElementById('usersNextPageBtn'),
      usersPage1Btn: document.getElementById('usersPage1Btn'),
      usersPage2Btn: document.getElementById('usersPage2Btn'),
      usersPage3Btn: document.getElementById('usersPage3Btn'),
      usersPageInfo: document.getElementById('usersPageInfo'),
      
      // Task Log Pagination
      taskLogPagination: document.getElementById('taskLogPagination'),
      taskLogPrevPageBtn: document.getElementById('taskLogPrevPageBtn'),
      taskLogNextPageBtn: document.getElementById('taskLogNextPageBtn'),
      taskLogPage1Btn: document.getElementById('taskLogPage1Btn'),
      taskLogPage2Btn: document.getElementById('taskLogPage2Btn'),
      taskLogPage3Btn: document.getElementById('taskLogPage3Btn'),
      taskLogPageInfo: document.getElementById('taskLogPageInfo'),
      
      // Last updated
      lastUpdated: document.getElementById('lastUpdated')
    };
    
    // State
    let state = {
      // Tickets state
      allTickets: [],
      filteredTickets: [],
      currentTicketsPage: 1,
      ticketsPerPage: 20,
      totalTicketsPages: 1,
      departments: new Set(),
      currentAdminId: null,
      currentAdminName: 'Admin',
      
      // Users state
      allUsers: [],
      filteredUsers: [],
      currentUsersPage: 1,
      usersPerPage: 15,
      totalUsersPages: 1,
      adminUsers: [],
      
      // Task Log state
      allTasks: [],
      filteredTasks: [],
      currentTaskId: null,
      currentTasksPage: 1,
      tasksPerPage: 15,
      totalTasksPages: 1,
      
      // General state
      lastFetchTime: null,
      isLoadingTickets: false,
      isLoadingUsers: false,
      isLoadingTasks: false,
      currentModalAction: null,
      currentModalData: null,
      ticketToAssign: null
    };
    
    // Admin Secret from URL
    const urlParams = new URLSearchParams(window.location.search);
    const adminSecret = urlParams.get('admin') || '';
    
    // ==================== ENHANCED TICKET MANAGEMENT FUNCTIONS ====================
    
    // Enhanced delete function from first code
   async function deleteTicketFromSystem(ticketId) {
  try {
    console.log(`Deleting ticket #${ticketId} from Supabase...`);

    // 1️⃣ DELETE directly (no pre-check)
    const { data, error, count } = await supabase
      .from('tickets')
      .delete({ count: 'exact' })
      .eq('id', ticketId);

    if (error) {
      console.error('Supabase delete failed:', error);
      throw error;
    }

    if (count === 0) {
      console.warn(`Ticket #${ticketId} was NOT found in Supabase`);
    } else {
      console.log(`Ticket #${ticketId} deleted from Supabase`);
    }

    // 2️⃣ Telegram delete (optional)
    let telegramDeleted = false;
    if (window._admin?.deleteTicket) {
      try {
        const result = await window._admin.deleteTicket(ticketId);
        telegramDeleted = result?.success === true;
      } catch (e) {
        console.warn('Telegram delete failed:', e);
      }
    }

    // 3️⃣ Update local state
    state.allTickets = state.allTickets.filter(t => t.id !== ticketId);

    updateTicketsStats();
    applyTicketsFilters();

    return {
      success: true,
      supabaseDeleted: count > 0,
      telegramDeleted,
      message:
        count > 0
          ? `Ticket #${ticketId} deleted from Supabase`
          : `Ticket #${ticketId} not found in Supabase`
    };

  } catch (err) {
    console.error('Delete ticket error:', err);
    return {
      success: false,
      message: err.message
    };
  }
}

    
    // Enhanced ticket processing from first code
    function processTickets(tickets) {
      // Store all tickets with proper database fields
      state.allTickets = tickets.map(ticket => {
        // Ensure the ticket has a proper ID format for Supabase
        const ticketId = ticket.id || 
                        ticket.ticket_id || 
                        `ticket_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        
        return {
          id: ticketId,
          name: ticket.name || 'Anonymous',
          department: ticket.department || 'General',
          status: (ticket.status || 'open').toLowerCase().replace(/\s+/g, '_'),
          urgency: (ticket.urgency || 'medium').toLowerCase(),
          message: ticket.message || ticket.description || ticket.summary || 'No description provided',
          created_at: ticket.created_at || ticket.createdAt || ticket.timestamp || new Date().toISOString(),
          telegram_id: ticket.telegram_id || ticket.telegramId || null,
          contact: ticket.contact || ticket.email || 'N/A',
          user_id: ticket.user_id || ticket.userId || null,
          assigned_to: ticket.assigned_to || ticket.assignedTo || null,
          assigned_to_name: ticket.assigned_to_name || ticket.assignedToName || null,
          assigned_at: ticket.assigned_at || ticket.assignedAt || null,
          resolved_by: ticket.resolved_by || ticket.resolvedBy || null,
          resolved_by_name: ticket.resolved_by_name || ticket.resolvedByName || null,
          resolved_at: ticket.resolved_at || ticket.resolvedAt || null
        };
      });
      
      // Update tickets count
      elements.ticketsCount.textContent = state.allTickets.length;
      
      // Update tickets stats
      updateTicketsStats();
      
      // Apply initial filters
      applyTicketsFilters();
      
      console.log(`Loaded ${state.allTickets.length} tickets`);
    }
    
    // Load tickets from Supabase (from first code)
    async function loadTicketsFromSupabase() {
      try {
        console.log('Loading tickets from Supabase...');
        
        const { data: tickets, error } = await supabase
          .from('tickets')
          .select('*')
          .order('created_at', { ascending: false });
        
        if (error) {
          throw new Error(`Supabase error: ${error.message}`);
        }
        
        if (tickets && tickets.length > 0) {
          console.log(`Found ${tickets.length} tickets in Supabase`);
          return tickets;
        }
        
        return [];
        
      } catch (error) {
        console.error('Error loading tickets from Supabase:', error);
        return [];
      }
    }
    
    // Enhanced loadAllTickets from first code
    async function loadAllTickets() {
      if (state.isLoadingTickets) return;
      
      state.isLoadingTickets = true;
      showTicketsLoading(true);
      
      try {
        console.log('Fetching tickets from all sources...');
        
        // Try to load from Supabase first
        const supabaseTickets = await loadTicketsFromSupabase();
        
        // Then try to load from Telegram/Admin API
        let telegramTickets = [];
        if (window._admin && typeof window._admin.fetchAllTickets === 'function') {
          const result = await window._admin.fetchAllTickets();
          if (result && result.success) {
            telegramTickets = result.tickets || [];
          }
        } else if (window._admin && typeof window._admin.fetchRecentTickets === 'function') {
          const result = await window._admin.fetchRecentTickets(1000);
          if (result && result.success) {
            telegramTickets = result.tickets || [];
          }
        }
        
        // Merge tickets, prioritizing Supabase tickets (most up-to-date)
        const allTickets = [...supabaseTickets, ...telegramTickets];
        
        // Remove duplicates by ticket ID
        const uniqueTickets = Array.from(
          new Map(allTickets.map(ticket => [ticket.id, ticket])).values()
        );
        
        processTickets(uniqueTickets);
        
        state.lastFetchTime = new Date();
        updateLastUpdated();
        
        console.log(`Loaded ${uniqueTickets.length} unique tickets from all sources`);
        
      } catch (error) {
        console.error('Error loading tickets:', error);
        showTicketsError('Failed to load tickets. Please check your connection and try again.');
      } finally {
        state.isLoadingTickets = false;
        showTicketsLoading(false);
      }
    }
    
    // ==================== ENHANCED MODAL ACTION ====================
    
    // Enhanced executeModalAction from first code
    async function executeModalAction() {
      if (!state.currentModalAction || !state.currentModalData) return;
      
      const { userId, userName, ticketId, ticketName, taskId, taskDescription } = state.currentModalData;
      
      try {
        switch (state.currentModalAction) {
          case 'deleteUser':
            await deleteUser(userId, userName);
            break;
          case 'deleteTicket':
            const result = await deleteTicketFromSystem(ticketId);
            alert(result.message);
            await loadAllTickets(); // Refresh tickets
            break;
          case 'deleteTask':
            await deleteTask(taskId);
            alert('Task log entry has been deleted successfully.');
            loadTaskLog();
            break;
        }
      } catch (error) {
        alert(`Error: ${error.message}`);
        console.error('Modal action error:', error);
      } finally {
        closeModal('confirm');
      }
    }
    
    // ==================== EXISTING DASHBOARD FUNCTIONS (MODIFIED) ====================
    
    // ENHANCED LOGOUT FUNCTION
    async function logoutAdmin() {
      if (confirm('Are you sure you want to logout?')) {
        try {
          // If Supabase is available, sign out from Supabase first
          if (supabase) {
            const { error } = await supabase.auth.signOut();
            if (error) {
              console.error('Supabase logout error:', error);
            } else {
              console.log('Successfully signed out from Supabase');
            }
          }
          
          // Clear all admin-related storage
          localStorage.removeItem('adminToken');
          sessionStorage.removeItem('adminLoggedIn');
          localStorage.removeItem('adminSecret');
          localStorage.removeItem('lastAdminAccess');
          localStorage.removeItem('supabase.auth.token');
          
          // Clear any cookies related to admin
          document.cookie = "adminToken=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
          document.cookie = "adminSecret=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
          document.cookie = "sb-access-token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
          document.cookie = "sb-refresh-token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
          
          // Redirect to main login page
          window.location.href = 'index.html';
          
        } catch (error) {
          console.error('Logout error:', error);
          // Still redirect even if there's an error
          window.location.href = 'index.html';
        }
      }
    }
    
    // Initialize navigation links with admin secret
    function updateNavLinks() {
      const links = [elements.trackLink, elements.ticketsLink, elements.historyLink, elements.userManagementLink];
      links.forEach(link => {
        if (link) {
          const currentHref = link.getAttribute('href');
          if (currentHref.includes('?')) {
            link.href = `${currentHref.split('?')[0]}?admin=${adminSecret}`;
          } else {
            link.href = `${currentHref}?admin=${adminSecret}`;
          }
        }
      });
      
      // Update manager link
      if (elements.managerLink) {
        elements.managerLink.href = `tickets.html?admin=${adminSecret}`;
      }
      
      // Dashboard link is current page
      if (elements.dashboardLink) {
        elements.dashboardLink.href = `dashboard.html?admin=${adminSecret}`;
      }
      
      // Logout functionality - ENHANCED
      if (elements.logoutLink) {
        elements.logoutLink.addEventListener('click', function(e) {
          e.preventDefault();
          logoutAdmin();
        });
      }
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', init);
    
    async function init() {
      console.log('Initializing Tomoca Dashboard with enhanced ticket management...');
      updateNavLinks();
      await loadCurrentAdmin();
      attachEventListeners();
      await loadAllTickets();
      await loadAllUsers();
      await loadTaskLog();
      startAutoRefresh();
    }
    
    // Load current admin info
    async function loadCurrentAdmin() {
      try {
        // Try to get current admin from localStorage
        const adminData = localStorage.getItem('adminData');
        if (adminData) {
          const parsed = JSON.parse(adminData);
          state.currentAdminId = parsed.id || 'admin_001';
          state.currentAdminName = parsed.name || 'Admin';
        } else {
          // Generate a random admin ID for demo
          state.currentAdminId = 'admin_' + Math.random().toString(36).substr(2, 9);
          state.currentAdminName = 'Admin User';
          
          // Save for future use
          localStorage.setItem('adminData', JSON.stringify({
            id: state.currentAdminId,
            name: state.currentAdminName
          }));
        }
      } catch (error) {
        console.error('Error loading admin info:', error);
        state.currentAdminId = 'admin_001';
        state.currentAdminName = 'Admin';
      }
    }
    
    function attachEventListeners() {
      // Tab switching
      elements.ticketsTab.addEventListener('click', () => switchTab('tickets'));
      elements.usersTab.addEventListener('click', () => switchTab('users'));
      elements.taskLogTab.addEventListener('click', () => switchTab('taskLog'));
      
      // Refresh buttons
      elements.refreshBtn.addEventListener('click', () => {
        const activeTab = document.querySelector('.tab-btn.active').dataset.tab;
        if (activeTab === 'tickets') {
          elements.refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
          loadAllTickets().finally(() => {
            elements.refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Data';
          });
        } else if (activeTab === 'users') {
          elements.refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
          loadAllUsers().finally(() => {
            elements.refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Data';
          });
        } else {
          elements.refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
          loadTaskLog().finally(() => {
            elements.refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Data';
          });
        }
      });
      
      elements.refreshUsersBtn.addEventListener('click', () => {
        elements.refreshUsersBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
        loadAllUsers().finally(() => {
          elements.refreshUsersBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Users';
        });
      });
      
      // Export button
      elements.exportBtn.addEventListener('click', exportToCSV);
      elements.exportTaskLogBtn.addEventListener('click', exportTaskLogToCSV);
      
      // Tickets filter changes
      elements.searchInput.addEventListener('input', debounce(applyTicketsFilters, 300));
      elements.statusFilter.addEventListener('change', applyTicketsFilters);
      elements.urgencyFilter.addEventListener('change', applyTicketsFilters);
      elements.assigneeFilter.addEventListener('change', applyTicketsFilters);
      elements.clearFiltersBtn.addEventListener('click', clearTicketsFilters);
      elements.assignToMeBtn.addEventListener('click', assignSelectedToMe);
      
      // Users filter changes
      elements.userSearchInput.addEventListener('input', debounce(applyUsersFilters, 300));
      elements.userStatusFilter.addEventListener('change', applyUsersFilters);
      elements.userRoleFilter.addEventListener('change', applyUsersFilters);
      elements.userSortFilter.addEventListener('change', applyUsersFilters);
      elements.clearUserFiltersBtn.addEventListener('click', clearUsersFilters);
      
      // Task Log form
      elements.taskForm.addEventListener('submit', handleTaskFormSubmit);
      elements.cancelTaskBtn.addEventListener('click', resetTaskForm);
      elements.addTaskBtn.addEventListener('click', () => {
        resetTaskForm();
        // Set default values
        const now = new Date();
        elements.taskDate.value = now.toISOString().split('T')[0];
        elements.taskStartTime.value = '09:00';
        elements.taskEndTime.value = '17:00';
        calculateDuration();
      });
      
      // Auto-calculate duration when times change
      elements.taskStartTime.addEventListener('change', calculateDuration);
      elements.taskEndTime.addEventListener('change', calculateDuration);
      
      // Modals
      elements.closeModalBtn.addEventListener('click', () => closeModal('ticket'));
      elements.ticketModal.addEventListener('click', (e) => {
        if (e.target === elements.ticketModal) closeModal('ticket');
      });
      
      elements.closeUserModalBtn.addEventListener('click', () => closeModal('user'));
      elements.userModal.addEventListener('click', (e) => {
        if (e.target === elements.userModal) closeModal('user');
      });
      
      elements.closeConfirmModalBtn.addEventListener('click', () => closeModal('confirm'));
      elements.cancelConfirmBtn.addEventListener('click', () => closeModal('confirm'));
      elements.confirmActionBtn.addEventListener('click', executeModalAction);
      elements.confirmModal.addEventListener('click', (e) => {
        if (e.target === elements.confirmModal) closeModal('confirm');
      });
      
      // Assign modal
      elements.closeAssignModalBtn.addEventListener('click', () => closeModal('assign'));
      elements.cancelAssignBtn.addEventListener('click', () => closeModal('assign'));
      elements.confirmAssignBtn.addEventListener('click', handleTicketAssignment);
      elements.assignModal.addEventListener('click', (e) => {
        if (e.target === elements.assignModal) closeModal('assign');
      });
      
      // Tickets Pagination
      elements.ticketsPrevPageBtn.addEventListener('click', () => changeTicketsPage(state.currentTicketsPage - 1));
      elements.ticketsNextPageBtn.addEventListener('click', () => changeTicketsPage(state.currentTicketsPage + 1));
      elements.ticketsPage1Btn.addEventListener('click', () => changeTicketsPage(1));
      elements.ticketsPage2Btn.addEventListener('click', () => changeTicketsPage(2));
      elements.ticketsPage3Btn.addEventListener('click', () => changeTicketsPage(3));
      
      // Users Pagination
      elements.usersPrevPageBtn.addEventListener('click', () => changeUsersPage(state.currentUsersPage - 1));
      elements.usersNextPageBtn.addEventListener('click', () => changeUsersPage(state.currentUsersPage + 1));
      elements.usersPage1Btn.addEventListener('click', () => changeUsersPage(1));
      elements.usersPage2Btn.addEventListener('click', () => changeUsersPage(2));
      elements.usersPage3Btn.addEventListener('click', () => changeUsersPage(3));
      
      // Task Log Pagination
      elements.taskLogPrevPageBtn.addEventListener('click', () => changeTasksPage(state.currentTasksPage - 1));
      elements.taskLogNextPageBtn.addEventListener('click', () => changeTasksPage(state.currentTasksPage + 1));
      elements.taskLogPage1Btn.addEventListener('click', () => changeTasksPage(1));
      elements.taskLogPage2Btn.addEventListener('click', () => changeTasksPage(2));
      elements.taskLogPage3Btn.addEventListener('click', () => changeTasksPage(3));
      
      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeModal('ticket');
          closeModal('user');
          closeModal('confirm');
          closeModal('assign');
        }
        if (e.key === 'r' && (e.ctrlKey || e.metaKey)) {
          e.preventDefault();
          const activeTab = document.querySelector('.tab-btn.active').dataset.tab;
          if (activeTab === 'tickets') loadAllTickets();
          else if (activeTab === 'users') loadAllUsers();
          else loadTaskLog();
        }
        if (e.key === 'l' && (e.ctrlKey || e.metaKey) && e.shiftKey) {
          e.preventDefault();
          logoutAdmin();
        }
        if (e.key === '1' && (e.ctrlKey || e.metaKey)) {
          e.preventDefault();
          switchTab('tickets');
        }
        if (e.key === '2' && (e.ctrlKey || e.metaKey)) {
          e.preventDefault();
          switchTab('users');
        }
        if (e.key === '3' && (e.ctrlKey || e.metaKey)) {
          e.preventDefault();
          switchTab('taskLog');
        }
      });
    }
    
    function switchTab(tabName) {
      // Update active tab button
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Hide all tab contents
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      
      // Show selected tab
      if (tabName === 'tickets') {
        elements.ticketsTab.classList.add('active');
        elements.ticketsTabContent.classList.add('active');
      } else if (tabName === 'users') {
        elements.usersTab.classList.add('active');
        elements.usersTabContent.classList.add('active');
      } else if (tabName === 'taskLog') {
        elements.taskLogTab.classList.add('active');
        elements.taskLogTabContent.classList.add('active');
      }
    }
    
    // ==================== TICKETS FUNCTIONS ====================
    
    function applyTicketsFilters() {
      const searchTerm = elements.searchInput.value.toLowerCase();
      const statusFilter = elements.statusFilter.value;
      const urgencyFilter = elements.urgencyFilter.value;
      const assigneeFilter = elements.assigneeFilter.value;
      
      // Filter tickets
      state.filteredTickets = state.allTickets.filter(ticket => {
        // Search filter
        if (searchTerm) {
          const searchable = `${ticket.id} ${ticket.name} ${ticket.department} ${ticket.message}`.toLowerCase();
          if (!searchable.includes(searchTerm)) return false;
        }
        
        // Status filter
        if (statusFilter !== 'all' && ticket.status !== statusFilter) return false;
        
        // Urgency filter
        if (urgencyFilter !== 'all' && ticket.urgency !== urgencyFilter) return false;
        
        // Assignee filter
        if (assigneeFilter === 'unassigned' && ticket.assigned_to) return false;
        if (assigneeFilter === 'me' && (!ticket.assigned_to || ticket.assigned_to !== state.currentAdminId)) return false;
        
        return true;
      });
      
      // Update table info
      elements.tableInfo.textContent = `Showing ${state.filteredTickets.length} of ${state.allTickets.length} tickets`;
      
      // Update pagination
      updateTicketsPagination();
      
      // Render current page
      renderTicketsPage();
    }
    
    async function assignSelectedToMe() {
      // Get selected tickets (you can add checkbox selection to tickets table)
      // For now, assign all filtered tickets to current admin
      const ticketsToAssign = state.filteredTickets.filter(t => t.status === 'open' && !t.assigned_to);
      
      if (ticketsToAssign.length === 0) {
        alert('No open, unassigned tickets to assign.');
        return;
      }
      
      if (confirm(`Assign ${ticketsToAssign.length} tickets to yourself?`)) {
        try {
          for (const ticket of ticketsToAssign) {
            await assignTicketToAdmin(ticket.id, state.currentAdminId, state.currentAdminName);
          }
          alert(`Successfully assigned ${ticketsToAssign.length} tickets to you.`);
          await loadAllTickets(); // Refresh tickets
        } catch (error) {
          console.error('Error assigning tickets:', error);
          alert('Error assigning tickets. Please try again.');
        }
      }
    }
    
    async function assignTicketToAdmin(ticketId, adminId, adminName) {
      try {
        // Update ticket assignment
        const updateData = {
          assigned_to: adminId,
          assigned_to_name: adminName,
          assigned_at: new Date().toISOString(),
          status: 'in_progress'
        };
        
        // Call your backend API to update the ticket
        if (window._admin && typeof window._admin.updateTicket === 'function') {
          await window._admin.updateTicket(ticketId, updateData);
        }
        
        // Update local state
        const ticketIndex = state.allTickets.findIndex(t => t.id === ticketId);
        if (ticketIndex !== -1) {
          state.allTickets[ticketIndex] = {
            ...state.allTickets[ticketIndex],
            ...updateData
          };
        }
        
        // Log the assignment as a task
        await logTask({
          date: new Date().toISOString().split('T')[0],
          priority: 'medium',
          ticketId: ticketId,
          description: `Assigned ticket #${ticketId} to ${adminName}`,
          startTime: '09:00',
          endTime: '09:05',
          duration: 0.08,
          status: 'completed',
          assignedTo: adminName,
          notes: 'Ticket assignment'
        });
        
        return true;
      } catch (error) {
        console.error('Error assigning ticket:', error);
        throw error;
      }
    }
    
    async function resolveTicket(ticketId, resolverId, resolverName) {
      try {
        // Update ticket status
        const updateData = {
          status: 'resolved',
          resolved_by: resolverId,
          resolved_by_name: resolverName,
          resolved_at: new Date().toISOString()
        };
        
        // Call your backend API to update the ticket
        if (window._admin && typeof window._admin.updateTicket === 'function') {
          await window._admin.updateTicket(ticketId, updateData);
        }
        
        // Update local state
        const ticketIndex = state.allTickets.findIndex(t => t.id === ticketId);
        if (ticketIndex !== -1) {
          state.allTickets[ticketIndex] = {
            ...state.allTickets[ticketIndex],
            ...updateData
          };
        }
        
        // Calculate resolution time
        const ticket = state.allTickets[ticketIndex];
        const createdTime = new Date(ticket.created_at);
        const resolvedTime = new Date(updateData.resolved_at);
        const resolutionHours = (resolvedTime - createdTime) / (1000 * 60 * 60);
        
        // Log the resolution as a task
        await logTask({
          date: new Date().toISOString().split('T')[0],
          priority: ticket.urgency || 'medium',
          ticketId: ticketId,
          description: `Resolved ticket #${ticketId}: ${ticket.message.substring(0, 50)}...`,
          startTime: '09:00',
          endTime: '17:00',
          duration: Math.round(resolutionHours * 100) / 100,
          status: 'completed',
          assignedTo: resolverName,
          notes: `Ticket resolved. Resolution time: ${resolutionHours.toFixed(2)} hours.`
        });
        
        return true;
      } catch (error) {
        console.error('Error resolving ticket:', error);
        throw error;
      }
    }
    
    function clearTicketsFilters() {
      elements.searchInput.value = '';
      elements.statusFilter.value = 'all';
      elements.urgencyFilter.value = 'all';
      elements.assigneeFilter.value = 'all';
      applyTicketsFilters();
    }
    
    function updateTicketsStats() {
      const stats = {
        open: 0,
        in_progress: 0,
        resolved: 0,
        total: state.allTickets.length,
        avgResolutionHours: 0
      };
      
      let totalResolutionHours = 0;
      let resolvedCount = 0;
      
      state.allTickets.forEach(ticket => {
        if (stats[ticket.status] !== undefined) {
          stats[ticket.status]++;
        }
        
        // Calculate average resolution time for resolved tickets
        if (ticket.status === 'resolved' && ticket.created_at && ticket.resolved_at) {
          const createdTime = new Date(ticket.created_at);
          const resolvedTime = new Date(ticket.resolved_at);
          const resolutionHours = (resolvedTime - createdTime) / (1000 * 60 * 60);
          totalResolutionHours += resolutionHours;
          resolvedCount++;
        }
      });
      
      if (resolvedCount > 0) {
        stats.avgResolutionHours = totalResolutionHours / resolvedCount;
      }
      
      elements.statOpen.textContent = stats.open;
      elements.statInProgress.textContent = stats.in_progress;
      elements.statResolved.textContent = stats.resolved;
      elements.statAvgResolution.textContent = `${stats.avgResolutionHours.toFixed(1)}h`;
    }
    
    function updateTicketsPagination() {
      state.totalTicketsPages = Math.ceil(state.filteredTickets.length / state.ticketsPerPage);
      state.currentTicketsPage = Math.min(state.currentTicketsPage, state.totalTicketsPages || 1);
      
      // Show/hide pagination
      if (state.totalTicketsPages > 1) {
        elements.ticketsPagination.style.display = 'flex';
      } else {
        elements.ticketsPagination.style.display = 'none';
      }
      
      // Update page info
      const start = (state.currentTicketsPage - 1) * state.ticketsPerPage + 1;
      const end = Math.min(state.currentTicketsPage * state.ticketsPerPage, state.filteredTickets.length);
      elements.ticketsPageInfo.textContent = `Page ${state.currentTicketsPage} of ${state.totalTicketsPages} • Tickets ${start}-${end} of ${state.filteredTickets.length}`;
      
      // Update pagination buttons
      elements.ticketsPrevPageBtn.disabled = state.currentTicketsPage === 1;
      elements.ticketsNextPageBtn.disabled = state.currentTicketsPage === state.totalTicketsPages;
      
      // Update page number buttons
      const pageButtons = [elements.ticketsPage1Btn, elements.ticketsPage2Btn, elements.ticketsPage3Btn];
      pageButtons.forEach((btn, index) => {
        const pageNum = index + 1;
        if (pageNum <= state.totalTicketsPages) {
          btn.style.display = 'flex';
          btn.textContent = pageNum;
          btn.dataset.page = pageNum;
          btn.classList.toggle('active', pageNum === state.currentTicketsPage);
        } else {
          btn.style.display = 'none';
        }
      });
    }
    
    function changeTicketsPage(page) {
      if (page < 1 || page > state.totalTicketsPages) return;
      
      state.currentTicketsPage = page;
      updateTicketsPagination();
      renderTicketsPage();
      
      // Scroll to top of table
      document.querySelector('#ticketsTable').scrollIntoView({ behavior: 'smooth' });
    }
    
    function renderTicketsPage() {
      const start = (state.currentTicketsPage - 1) * state.ticketsPerPage;
      const end = start + state.ticketsPerPage;
      const pageTickets = state.filteredTickets.slice(start, end);
      
      // Show/hide empty state
      if (pageTickets.length === 0) {
        elements.ticketsEmptyState.style.display = 'block';
        elements.ticketsTableBody.innerHTML = '';
      } else {
        elements.ticketsEmptyState.style.display = 'none';
        elements.ticketsTableBody.innerHTML = pageTickets.map(renderTicketRow).join('');
        
        // Attach event listeners to action buttons
        document.querySelectorAll('.view-ticket-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const ticketId = e.currentTarget.dataset.id;
            viewTicketDetails(ticketId);
          });
        });
        
        document.querySelectorAll('.assign-ticket-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const ticketId = e.currentTarget.dataset.id;
            showAssignModal(ticketId);
          });
        });
        
        document.querySelectorAll('.resolve-ticket-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const ticketId = e.currentTarget.dataset.id;
            resolveTicketPrompt(ticketId);
          });
        });
        
        document.querySelectorAll('.delete-ticket-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const ticketId = e.currentTarget.dataset.id;
            const ticketName = e.currentTarget.dataset.name;
            showDeleteTicketConfirmation(ticketId, ticketName);
          });
        });
      }
    }
    
    function renderTicketRow(ticket) {
      const formattedDate = window._utils?.formatDate 
        ? window._utils.formatDate(ticket.created_at)
        : new Date(ticket.created_at).toLocaleString();
      
      const userName = ticket.name || 'Anonymous';
      const userInitials = userName.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
      
      const statusText = {
        open: 'Open',
        in_progress: 'In Progress',
        resolved: 'Resolved'
      }[ticket.status] || 'Open';
      
      const urgencyText = {
        low: 'Low',
        medium: 'Medium',
        high: 'High'
      }[ticket.urgency] || 'Medium';
      
      // Assignee info
      let assigneeHtml = '<span style="color: var(--muted);">Unassigned</span>';
      if (ticket.assigned_to_name) {
        const assigneeInitials = ticket.assigned_to_name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
        assigneeHtml = `
          <div class="assignee-info">
            <div class="assignee-avatar">${escapeHtml(assigneeInitials)}</div>
            <span>${escapeHtml(ticket.assigned_to_name)}</span>
          </div>
        `;
      }
      
      return `
        <tr>
          <td class="ticket-id">#${escapeHtml(ticket.id)}</td>
          <td>
            <div class="ticket-user">
              <div class="user-avatar">${escapeHtml(userInitials)}</div>
              <div class="user-info">
                <h4>${escapeHtml(userName)}</h4>
                <p>${escapeHtml(ticket.contact || 'No contact')}</p>
              </div>
            </div>
          </td>
          <td>${escapeHtml(ticket.department)}</td>
          <td><span class="badge badge-${ticket.status}">${statusText}</span></td>
          <td><span class="urgency urgency-${ticket.urgency}">${urgencyText}</span></td>
          <td>${assigneeHtml}</td>
          <td>${escapeHtml(formattedDate)}</td>
          <td>
            <div class="ticket-actions">
              <button class="action-btn view-ticket-btn" data-id="${escapeHtml(ticket.id)}" title="View Details">
                <i class="fas fa-eye"></i>
              </button>
              ${ticket.status !== 'resolved' ? `
                <button class="action-btn action-btn-success assign-ticket-btn" data-id="${escapeHtml(ticket.id)}" title="Assign Ticket">
                  <i class="fas fa-user-plus"></i>
                </button>
                <button class="action-btn action-btn-success resolve-ticket-btn" data-id="${escapeHtml(ticket.id)}" title="Resolve Ticket">
                  <i class="fas fa-check"></i>
                </button>
              ` : ''}
              <button class="action-btn action-btn-danger delete-ticket-btn" data-id="${escapeHtml(ticket.id)}" data-name="${escapeHtml(userName)}" title="Delete Ticket">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>
      `;
    }
    
    function showAssignModal(ticketId) {
      state.ticketToAssign = ticketId;
      
      // Populate assignee dropdown with admin users
      populateAssigneeDropdown();
      
      // Show modal
      elements.assignModal.style.display = 'flex';
    }
    
    function populateAssigneeDropdown() {
      elements.assignToUser.innerHTML = '<option value="">Select admin...</option>';
      
      // Add current admin as first option
      elements.assignToUser.innerHTML += `<option value="${state.currentAdminId}">${state.currentAdminName} (You)</option>`;
      
      // Add other admin users
      state.adminUsers.forEach(admin => {
        if (admin.id !== state.currentAdminId) {
          elements.assignToUser.innerHTML += `<option value="${admin.id}">${admin.name}</option>`;
        }
      });
    }
    
    async function handleTicketAssignment() {
      const adminId = elements.assignToUser.value;
      const adminName = elements.assignToUser.options[elements.assignToUser.selectedIndex].text.split(' (')[0];
      const notes = elements.assignNotes.value;
      
      if (!adminId) {
        alert('Please select an admin to assign the ticket to.');
        return;
      }
      
      try {
        await assignTicketToAdmin(state.ticketToAssign, adminId, adminName);
        alert(`Ticket assigned to ${adminName} successfully.`);
        closeModal('assign');
        await loadAllTickets(); // Refresh tickets
      } catch (error) {
        alert('Error assigning ticket. Please try again.');
      }
    }
    
    function resolveTicketPrompt(ticketId) {
      if (confirm('Are you sure you want to mark this ticket as resolved?')) {
        resolveTicket(ticketId, state.currentAdminId, state.currentAdminName)
          .then(() => {
            alert('Ticket resolved successfully.');
            loadAllTickets(); // Refresh tickets
          })
          .catch(error => {
            alert('Error resolving ticket. Please try again.');
          });
      }
    }
    
    function showDeleteTicketConfirmation(ticketId, ticketName) {
      state.currentModalAction = 'deleteTicket';
      state.currentModalData = { ticketId, ticketName };
      
      elements.confirmModalTitle.textContent = 'Delete Ticket';
      elements.confirmModalBody.innerHTML = `
        <p>Are you sure you want to delete ticket <strong>#${escapeHtml(ticketId)}</strong> for <strong>${escapeHtml(ticketName)}</strong>?</p>
        <p style="color: var(--danger); font-size: 14px; margin-top: 10px;">
          <i class="fas fa-exclamation-triangle"></i> This action cannot be undone. The ticket will be permanently deleted.
        </p>
      `;
      
      showModal('confirm');
    }
    
    // ==================== USERS FUNCTIONS ====================
    
    async function loadAllUsers() {
      if (state.isLoadingUsers) return;
      
      state.isLoadingUsers = true;
      showUsersLoading(true);
      
      try {
        console.log('Fetching all users from Supabase...');
        
        // Fetch users from Supabase
        const { data: users, error } = await supabase
          .from('users')
          .select('*')
          .order('created_at', { ascending: false });
        
        if (error) {
          throw new Error(`Supabase error: ${error.message}`);
        }
        
        // Process users
        processUsers(users || []);
        
        console.log(`Loaded ${state.allUsers.length} users from Supabase`);
        
      } catch (error) {
        console.error('Error loading users:', error);
        showUsersError('Failed to load users. Please check your connection and try again.');
      } finally {
        state.isLoadingUsers = false;
        showUsersLoading(false);
      }
    }
    
    function processUsers(users) {
      // Store all users
      state.allUsers = users.map(user => ({
        id: user.id || 'N/A',
        email: user.email || 'No email',
        name: user.name || 'Anonymous',
        role: user.role || 'user',
        status: user.status || 'active',
        createdAt: user.created_at || Date.now(),
        lastLogin: user.last_login || null,
        telegramId: user.telegram_id || null,
        phone: user.phone || null,
        ticketCount: 0 // Will be calculated
      }));
      
      // Filter admin users
      state.adminUsers = state.allUsers.filter(user => user.role === 'admin');
      
      // Calculate ticket counts for each user
      state.allUsers.forEach(user => {
        user.ticketCount = state.allTickets.filter(ticket => 
          ticket.user_id === user.id || ticket.telegram_id === user.telegramId
        ).length;
      });
      
      // Update users count
      elements.usersCount.textContent = state.allUsers.length;
      
      // Update users stats
      updateUsersStats();
      
      // Apply initial filters
      applyUsersFilters();
    }
    
    function applyUsersFilters() {
      const searchTerm = elements.userSearchInput.value.toLowerCase();
      const statusFilter = elements.userStatusFilter.value;
      const roleFilter = elements.userRoleFilter.value;
      const sortFilter = elements.userSortFilter.value;
      
      // Filter users
      let filteredUsers = state.allUsers.filter(user => {
        // Search filter
        if (searchTerm) {
          const searchable = `${user.id} ${user.name} ${user.email}`.toLowerCase();
          if (!searchable.includes(searchTerm)) return false;
        }
        
        // Status filter
        if (statusFilter !== 'all' && user.status !== statusFilter) return false;
        
        // Role filter
        if (roleFilter !== 'all' && user.role !== roleFilter) return false;
        
        return true;
      });
      
      // Sort users
      switch (sortFilter) {
        case 'newest':
          filteredUsers.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
          break;
        case 'oldest':
          filteredUsers.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
          break;
        case 'name_asc':
          filteredUsers.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
          break;
        case 'name_desc':
          filteredUsers.sort((a, b) => (b.name || '').localeCompare(a.name || ''));
          break;
        case 'tickets_desc':
          filteredUsers.sort((a, b) => b.ticketCount - a.ticketCount);
          break;
      }
      
      state.filteredUsers = filteredUsers;
      
      // Update table info
      elements.usersTableInfo.textContent = `Showing ${state.filteredUsers.length} of ${state.allUsers.length} users`;
      
      // Update pagination
      updateUsersPagination();
      
      // Render current page
      renderUsersPage();
    }
    
    function clearUsersFilters() {
      elements.userSearchInput.value = '';
      elements.userStatusFilter.value = 'all';
      elements.userRoleFilter.value = 'all';
      elements.userSortFilter.value = 'newest';
      applyUsersFilters();
    }
    
    function updateUsersStats() {
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      
      const stats = {
        total: state.allUsers.length,
        active: state.allUsers.filter(u => u.status === 'active').length,
        newToday: state.allUsers.filter(u => {
          const userDate = new Date(u.createdAt);
          return userDate >= today;
        }).length,
        avgTickets: state.allUsers.length > 0 
          ? (state.allTickets.length / state.allUsers.length).toFixed(1)
          : '0'
      };
      
      elements.statTotalUsers.textContent = stats.total;
      elements.statActiveUsers.textContent = stats.active;
      elements.statNewUsersToday.textContent = stats.newToday;
      elements.statAvgTickets.textContent = stats.avgTickets;
    }
    
    function updateUsersPagination() {
      state.totalUsersPages = Math.ceil(state.filteredUsers.length / state.usersPerPage);
      state.currentUsersPage = Math.min(state.currentUsersPage, state.totalUsersPages || 1);
      
      // Show/hide pagination
      if (state.totalUsersPages > 1) {
        elements.usersPagination.style.display = 'flex';
      } else {
        elements.usersPagination.style.display = 'none';
      }
      
      // Update page info
      const start = (state.currentUsersPage - 1) * state.usersPerPage + 1;
      const end = Math.min(state.currentUsersPage * state.usersPerPage, state.filteredUsers.length);
      elements.usersPageInfo.textContent = `Page ${state.currentUsersPage} of ${state.totalUsersPages} • Users ${start}-${end} of ${state.filteredUsers.length}`;
      
      // Update pagination buttons
      elements.usersPrevPageBtn.disabled = state.currentUsersPage === 1;
      elements.usersNextPageBtn.disabled = state.currentUsersPage === state.totalUsersPages;
      
      // Update page number buttons
      const pageButtons = [elements.usersPage1Btn, elements.usersPage2Btn, elements.usersPage3Btn];
      pageButtons.forEach((btn, index) => {
        const pageNum = index + 1;
        if (pageNum <= state.totalUsersPages) {
          btn.style.display = 'flex';
          btn.textContent = pageNum;
          btn.dataset.page = pageNum;
          btn.classList.toggle('active', pageNum === state.currentUsersPage);
        } else {
          btn.style.display = 'none';
        }
      });
    }
    
    function changeUsersPage(page) {
      if (page < 1 || page > state.totalUsersPages) return;
      
      state.currentUsersPage = page;
      updateUsersPagination();
      renderUsersPage();
      
      // Scroll to top of table
      document.querySelector('#usersTable').scrollIntoView({ behavior: 'smooth' });
    }
    
    function renderUsersPage() {
      const start = (state.currentUsersPage - 1) * state.usersPerPage;
      const end = start + state.usersPerPage;
      const pageUsers = state.filteredUsers.slice(start, end);
      
      // Show/hide empty state
      if (pageUsers.length === 0) {
        elements.usersEmptyState.style.display = 'block';
        elements.usersTableBody.innerHTML = '';
      } else {
        elements.usersEmptyState.style.display = 'none';
        elements.usersTableBody.innerHTML = pageUsers.map(renderUserRow).join('');
        
        // Attach event listeners to action buttons
        document.querySelectorAll('.view-user-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const userId = e.currentTarget.dataset.id;
            viewUserDetails(userId);
          });
        });
        
        document.querySelectorAll('.delete-user-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const userId = e.currentTarget.dataset.id;
            const userName = e.currentTarget.dataset.name;
            showDeleteUserConfirmation(userId, userName);
          });
        });
        
        document.querySelectorAll('.toggle-user-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const userId = e.currentTarget.dataset.id;
            const currentStatus = e.currentTarget.dataset.status;
            const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
            const userName = e.currentTarget.dataset.name;
            toggleUserStatus(userId, userName, newStatus);
          });
        });
      }
    }
    
    function renderUserRow(user) {
      const formattedDate = window._utils?.formatDate 
        ? window._utils.formatDate(user.createdAt)
        : new Date(user.createdAt).toLocaleDateString();
      
      const userName = user.name || 'Anonymous';
      const userInitials = userName.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
      
      const statusText = user.status === 'active' ? 'Active' : 
                        user.status === 'inactive' ? 'Inactive' : 
                        user.status === 'banned' ? 'Banned' : 'Unknown';
      
      const roleText = user.role === 'admin' ? 'Admin' : 'User';
      
      return `
        <tr>
          <td>
            <div class="user-info-cell">
              <div class="user-avatar">${escapeHtml(userInitials)}</div>
              <div class="user-info">
                <h4>${escapeHtml(userName)}</h4>
                <p>ID: ${escapeHtml(user.id.substring(0, 8))}...</p>
              </div>
            </div>
          </td>
          <td>${escapeHtml(user.email)}</td>
          <td><span class="badge badge-${user.role}">${roleText}</span></td>
          <td><strong>${user.ticketCount}</strong> tickets</td>
          <td>${escapeHtml(formattedDate)}</td>
          <td><span class="badge badge-${user.status}">${statusText}</span></td>
          <td>
            <div class="user-actions">
              <button class="action-btn view-user-btn" data-id="${escapeHtml(user.id)}" title="View Details">
                <i class="fas fa-eye"></i>
              </button>
              <button class="action-btn toggle-user-btn" data-id="${escapeHtml(user.id)}" data-status="${escapeHtml(user.status)}" data-name="${escapeHtml(userName)}" title="${user.status === 'active' ? 'Deactivate' : 'Activate'} User">
                <i class="fas ${user.status === 'active' ? 'fa-user-slash' : 'fa-user-check'}"></i>
              </button>
              <button class="action-btn action-btn-danger delete-user-btn" data-id="${escapeHtml(user.id)}" data-name="${escapeHtml(userName)}" title="Delete User">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>
      `;
    }
    
    // ==================== TASK LOG FUNCTIONS ====================
    
    async function loadTaskLog() {
      if (state.isLoadingTasks) return;
      
      state.isLoadingTasks = true;
      showTaskLogLoading(true);
      
      try {
        // Load tasks from localStorage (or API in production)
        const savedTasks = localStorage.getItem('tomocaTaskLog');
        if (savedTasks) {
          state.allTasks = JSON.parse(savedTasks);
        } else {
          state.allTasks = [];
          // Generate some sample tasks for demo
          generateSampleTasks();
        }
        
        // Update task log count
        elements.taskLogCount.textContent = state.allTasks.length;
        
        // Update task stats
        updateTaskLogStats();
        
        // Apply filters
        applyTaskLogFilters();
        
        console.log(`Loaded ${state.allTasks.length} task log entries`);
        
      } catch (error) {
        console.error('Error loading task log:', error);
        showTaskLogError('Failed to load task log entries.');
      } finally {
        state.isLoadingTasks = false;
        showTaskLogLoading(false);
      }
    }
    
    function generateSampleTasks() {
      const sampleTasks = [
        {
          id: 'task_001',
          date: new Date().toISOString().split('T')[0],
          priority: 'high',
          ticketId: 'TKT001',
          description: 'Fixed server downtime issue',
          startTime: '09:00',
          endTime: '12:30',
          duration: 3.5,
          status: 'completed',
          assignedTo: 'John Doe',
          notes: 'Required emergency maintenance',
          createdAt: new Date().toISOString()
        },
        {
          id: 'task_002',
          date: new Date().toISOString().split('T')[0],
          priority: 'medium',
          ticketId: 'TKT002',
          description: 'Updated user permissions',
          startTime: '13:00',
          endTime: '14:00',
          duration: 1.0,
          status: 'completed',
          assignedTo: 'Jane Smith',
          notes: 'Standard permission update',
          createdAt: new Date().toISOString()
        },
        {
          id: 'task_003',
          date: new Date().toISOString().split('T')[0],
          priority: 'low',
          ticketId: 'TKT003',
          description: 'Documentation update',
          startTime: '14:30',
          endTime: '16:00',
          duration: 1.5,
          status: 'in_progress',
          assignedTo: 'Admin User',
          notes: 'Updating API documentation',
          createdAt: new Date().toISOString()
        }
      ];
      
      state.allTasks = sampleTasks;
      saveTasksToStorage();
    }
    
    function calculateDuration() {
      const startTime = elements.taskStartTime.value;
      const endTime = elements.taskEndTime.value;
      
      if (startTime && endTime) {
        const [startHours, startMinutes] = startTime.split(':').map(Number);
        const [endHours, endMinutes] = endTime.split(':').map(Number);
        
        const startTotalMinutes = startHours * 60 + startMinutes;
        const endTotalMinutes = endHours * 60 + endMinutes;
        
        let durationMinutes = endTotalMinutes - startTotalMinutes;
        
        // Handle overnight tasks (if end time is before start time, assume next day)
        if (durationMinutes < 0) {
          durationMinutes += 24 * 60;
        }
        
        const durationHours = durationMinutes / 60;
        elements.taskDuration.value = durationHours.toFixed(2);
      }
    }
    
    async function handleTaskFormSubmit(e) {
      e.preventDefault();
      
      try {
        const taskData = {
          id: state.currentTaskId || 'task_' + Date.now(),
          date: elements.taskDate.value,
          priority: elements.taskPriority.value,
          ticketId: elements.taskTicketId.value,
          description: elements.taskDescription.value,
          startTime: elements.taskStartTime.value,
          endTime: elements.taskEndTime.value,
          duration: parseFloat(elements.taskDuration.value) || 0,
          status: elements.taskStatus.value,
          assignedTo: state.currentAdminName,
          notes: elements.taskNotes.value,
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };
        
        if (state.currentTaskId) {
          // Update existing task
          const taskIndex = state.allTasks.findIndex(t => t.id === state.currentTaskId);
          if (taskIndex !== -1) {
            state.allTasks[taskIndex] = taskData;
          }
        } else {
          // Add new task
          state.allTasks.unshift(taskData);
        }
        
        // Save to storage
        saveTasksToStorage();
        
        // Update UI
        updateTaskLogStats();
        applyTaskLogFilters();
        
        // Reset form
        resetTaskForm();
        
        alert('Task saved successfully!');
        
      } catch (error) {
        console.error('Error saving task:', error);
        alert('Error saving task. Please try again.');
      }
    }
    
    function resetTaskForm() {
      elements.taskForm.reset();
      state.currentTaskId = null;
      
      // Set default date to today
      const today = new Date().toISOString().split('T')[0];
      elements.taskDate.value = today;
      
      // Set default times
      elements.taskStartTime.value = '09:00';
      elements.taskEndTime.value = '17:00';
      calculateDuration();
      
      // Update button text
      elements.saveTaskBtn.innerHTML = '<i class="fas fa-save"></i> Save Task';
    }
    
    function saveTasksToStorage() {
      localStorage.setItem('tomocaTaskLog', JSON.stringify(state.allTasks));
    }
    
    async function logTask(taskData) {
      try {
        const task = {
          id: 'task_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
          date: taskData.date,
          priority: taskData.priority,
          ticketId: taskData.ticketId,
          description: taskData.description,
          startTime: taskData.startTime,
          endTime: taskData.endTime,
          duration: taskData.duration,
          status: taskData.status,
          assignedTo: taskData.assignedTo,
          notes: taskData.notes,
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };
        
        state.allTasks.unshift(task);
        saveTasksToStorage();
        
        // Update UI if we're on the task log tab
        if (document.querySelector('.tab-btn.active').dataset.tab === 'taskLog') {
          updateTaskLogStats();
          applyTaskLogFilters();
        }
        
        return task;
      } catch (error) {
        console.error('Error logging task:', error);
        throw error;
      }
    }
    
    function updateTaskLogStats() {
      const today = new Date().toISOString().split('T')[0];
      
      const stats = {
        total: state.allTasks.length,
        pending: state.allTasks.filter(t => t.status === 'pending').length,
        completedToday: state.allTasks.filter(t => t.status === 'completed' && t.date === today).length,
        avgDuration: 0
      };
      
      // Calculate average duration
      const completedTasks = state.allTasks.filter(t => t.status === 'completed');
      if (completedTasks.length > 0) {
        const totalDuration = completedTasks.reduce((sum, task) => sum + (task.duration || 0), 0);
        stats.avgDuration = totalDuration / completedTasks.length;
      }
      
      elements.statTotalTasks.textContent = stats.total;
      elements.statPendingTasks.textContent = stats.pending;
      elements.statCompletedTasks.textContent = stats.completedToday;
      elements.statAvgTaskDuration.textContent = `${stats.avgDuration.toFixed(1)}h`;
    }
    
    function applyTaskLogFilters() {
      // For now, just show all tasks
      state.filteredTasks = [...state.allTasks].sort((a, b) => 
        new Date(b.date + ' ' + b.startTime) - new Date(a.date + ' ' + a.startTime)
      );
      
      // Update table info
      elements.taskLogTableInfo.textContent = `Showing ${state.filteredTasks.length} task log entries`;
      
      // Update pagination
      updateTaskLogPagination();
      
      // Render current page
      renderTaskLogPage();
    }
    
    function updateTaskLogPagination() {
      state.totalTasksPages = Math.ceil(state.filteredTasks.length / state.tasksPerPage);
      state.currentTasksPage = Math.min(state.currentTasksPage, state.totalTasksPages || 1);
      
      // Show/hide pagination
      if (state.totalTasksPages > 1) {
        elements.taskLogPagination.style.display = 'flex';
      } else {
        elements.taskLogPagination.style.display = 'none';
      }
      
      // Update page info
      const start = (state.currentTasksPage - 1) * state.tasksPerPage + 1;
      const end = Math.min(state.currentTasksPage * state.tasksPerPage, state.filteredTasks.length);
      elements.taskLogPageInfo.textContent = `Page ${state.currentTasksPage} of ${state.totalTasksPages} • Tasks ${start}-${end} of ${state.filteredTasks.length}`;
      
      // Update pagination buttons
      elements.taskLogPrevPageBtn.disabled = state.currentTasksPage === 1;
      elements.taskLogNextPageBtn.disabled = state.currentTasksPage === state.totalTasksPages;
      
      // Update page number buttons
      const pageButtons = [elements.taskLogPage1Btn, elements.taskLogPage2Btn, elements.taskLogPage3Btn];
      pageButtons.forEach((btn, index) => {
        const pageNum = index + 1;
        if (pageNum <= state.totalTasksPages) {
          btn.style.display = 'flex';
          btn.textContent = pageNum;
          btn.dataset.page = pageNum;
          btn.classList.toggle('active', pageNum === state.currentTasksPage);
        } else {
          btn.style.display = 'none';
        }
      });
    }
    
    function changeTasksPage(page) {
      if (page < 1 || page > state.totalTasksPages) return;
      
      state.currentTasksPage = page;
      updateTaskLogPagination();
      renderTaskLogPage();
      
      // Scroll to top of table
      document.querySelector('#taskLogTable').scrollIntoView({ behavior: 'smooth' });
    }
    
    function renderTaskLogPage() {
      const start = (state.currentTasksPage - 1) * state.tasksPerPage;
      const end = start + state.tasksPerPage;
      const pageTasks = state.filteredTasks.slice(start, end);
      
      // Show/hide empty state
      if (pageTasks.length === 0) {
        elements.taskLogEmptyState.style.display = 'block';
        elements.taskLogTableBody.innerHTML = '';
      } else {
        elements.taskLogEmptyState.style.display = 'none';
        elements.taskLogTableBody.innerHTML = pageTasks.map(renderTaskRow).join('');
        
        // Attach event listeners to action buttons
        document.querySelectorAll('.edit-task-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const taskId = e.currentTarget.dataset.id;
            editTask(taskId);
          });
        });
        
        document.querySelectorAll('.delete-task-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const taskId = e.currentTarget.dataset.id;
            const taskDesc = e.currentTarget.dataset.description;
            showDeleteTaskConfirmation(taskId, taskDesc);
          });
        });
      }
    }
    
    function renderTaskRow(task) {
      const statusText = {
        pending: 'Pending',
        in_progress: 'In Progress',
        completed: 'Completed'
      }[task.status] || 'Pending';
      
      const priorityText = {
        high: 'High',
        medium: 'Medium',
        low: 'Low'
      }[task.priority] || 'Medium';
      
      return `
        <tr>
          <td>${escapeHtml(task.date)}</td>
          <td><span class="badge priority-${task.priority}">${priorityText}</span></td>
          <td>${task.ticketId ? `<span class="ticket-id">#${escapeHtml(task.ticketId)}</span>` : 'N/A'}</td>
          <td>${escapeHtml(task.description)}</td>
          <td>${escapeHtml(task.startTime)}</td>
          <td>${escapeHtml(task.endTime)}</td>
          <td><strong>${task.duration.toFixed(2)}h</strong></td>
          <td><span class="badge badge-${task.status}">${statusText}</span></td>
          <td>${escapeHtml(task.assignedTo)}</td>
          <td>${escapeHtml(task.notes || 'No notes')}</td>
          <td>
            <div class="task-actions">
              <button class="action-btn edit-task-btn" data-id="${escapeHtml(task.id)}" title="Edit Task">
                <i class="fas fa-edit"></i>
              </button>
              <button class="action-btn action-btn-danger delete-task-btn" data-id="${escapeHtml(task.id)}" data-description="${escapeHtml(task.description)}" title="Delete Task">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>
      `;
    }
    
    function editTask(taskId) {
      const task = state.allTasks.find(t => t.id === taskId);
      if (!task) return;
      
      state.currentTaskId = taskId;
      
      // Populate form
      elements.taskDate.value = task.date;
      elements.taskPriority.value = task.priority;
      elements.taskTicketId.value = task.ticketId || '';
      elements.taskDescription.value = task.description;
      elements.taskStartTime.value = task.startTime;
      elements.taskEndTime.value = task.endTime;
      elements.taskDuration.value = task.duration.toFixed(2);
      elements.taskStatus.value = task.status;
      elements.taskNotes.value = task.notes || '';
      
      // Update button text
      elements.saveTaskBtn.innerHTML = '<i class="fas fa-save"></i> Update Task';
      
      // Scroll to form
      elements.taskForm.scrollIntoView({ behavior: 'smooth' });
    }
    
    function showDeleteTaskConfirmation(taskId, taskDescription) {
      state.currentModalAction = 'deleteTask';
      state.currentModalData = { taskId, taskDescription };
      
      elements.confirmModalTitle.textContent = 'Delete Task Log Entry';
      elements.confirmModalBody.innerHTML = `
        <p>Are you sure you want to delete the task log entry: <strong>"${escapeHtml(taskDescription)}"</strong>?</p>
        <p style="color: var(--danger); font-size: 14px; margin-top: 10px;">
          <i class="fas fa-exclamation-triangle"></i> This action cannot be undone.
        </p>
      `;
      
      showModal('confirm');
    }
    
    // ==================== MODAL FUNCTIONS ====================
    
    function viewTicketDetails(ticketId) {
      const ticket = state.allTickets.find(t => t.id === ticketId);
      if (!ticket) {
        alert('Ticket not found');
        return;
      }
      
      const formattedDate = window._utils?.formatDate 
        ? window._utils.formatDate(ticket.created_at)
        : new Date(ticket.created_at).toLocaleString();
      
      const resolvedDate = ticket.resolved_at 
        ? (window._utils?.formatDate ? window._utils.formatDate(ticket.resolved_at) : new Date(ticket.resolved_at).toLocaleString())
        : 'Not resolved yet';
      
      const assignedDate = ticket.assigned_at 
        ? (window._utils?.formatDate ? window._utils.formatDate(ticket.assigned_at) : new Date(ticket.assigned_at).toLocaleString())
        : 'Not assigned';
      
      const statusText = {
        open: 'Open',
        in_progress: 'In Progress',
        resolved: 'Resolved'
      }[ticket.status] || 'Open';
      
      const urgencyText = {
        low: 'Low',
        medium: 'Medium',
        high: 'High'
      }[ticket.urgency] || 'Medium';
      
      elements.modalTitle.textContent = `Ticket #${ticket.id}`;
      elements.modalBody.innerHTML = `
        <div class="ticket-details-grid">
          <div class="detail-group">
            <label>Customer Name</label>
            <div class="value">${escapeHtml(ticket.name)}</div>
          </div>
          <div class="detail-group">
            <label>Contact Info</label>
            <div class="value">${escapeHtml(ticket.contact || 'Not provided')}</div>
          </div>
          <div class="detail-group">
            <label>Department</label>
            <div class="value">${escapeHtml(ticket.department)}</div>
          </div>
          <div class="detail-group">
            <label>Status</label>
            <div class="value"><span class="badge badge-${ticket.status}">${statusText}</span></div>
          </div>
          <div class="detail-group">
            <label>Urgency</label>
            <div class="value"><span class="urgency urgency-${ticket.urgency}">${urgencyText}</span></div>
          </div>
          <div class="detail-group">
            <label>Created</label>
            <div class="value">${escapeHtml(formattedDate)}</div>
          </div>
          <div class="detail-group">
            <label>Assigned To</label>
            <div class="value">${ticket.assigned_to_name ? escapeHtml(ticket.assigned_to_name) : '<span style="color: var(--muted);">Unassigned</span>'}</div>
          </div>
          <div class="detail-group">
            <label>Assigned At</label>
            <div class="value">${escapeHtml(assignedDate)}</div>
          </div>
          ${ticket.resolved_by_name ? `
            <div class="detail-group">
              <label>Resolved By</label>
              <div class="value">${escapeHtml(ticket.resolved_by_name)}</div>
            </div>
            <div class="detail-group">
              <label>Resolved At</label>
              <div class="value">${escapeHtml(resolvedDate)}</div>
            </div>
          ` : ''}
          <div class="detail-group">
            <label>Telegram ID</label>
            <div class="value">${escapeHtml(ticket.telegram_id || 'N/A')}</div>
          </div>
          <div class="detail-group">
            <label>Ticket ID</label>
            <div class="value">${escapeHtml(ticket.id)}</div>
          </div>
        </div>
        
        <div class="detail-group" style="grid-column: 1 / -1; margin-top: 20px;">
          <label>Message</label>
          <div class="message-box">
            <p>${escapeHtml(ticket.message).replace(/\n/g, '<br>')}</p>
          </div>
        </div>
        
        <div style="display: flex; gap: 12px; margin-top: 30px;">
          ${ticket.status !== 'resolved' ? `
            <button class="btn btn-primary" onclick="assignTicket('${escapeHtml(ticket.id)}')">
              <i class="fas fa-user-plus"></i> Assign Ticket
            </button>
            <button class="btn btn-success" onclick="resolveTicket('${escapeHtml(ticket.id)}')">
              <i class="fas fa-check-circle"></i> Resolve Ticket
            </button>
          ` : ''}
          <button class="btn btn-danger" onclick="deleteTicket('${escapeHtml(ticket.id)}')">
            <i class="fas fa-trash"></i> Delete Ticket
          </button>
        </div>
      `;
      
      showModal('ticket');
    }
    
    function viewUserDetails(userId) {
      const user = state.allUsers.find(u => u.id === userId);
      if (!user) {
        alert('User not found');
        return;
      }
      
      const formattedDate = window._utils?.formatDate 
        ? window._utils.formatDate(user.createdAt)
        : new Date(user.createdAt).toLocaleString();
      
      const lastLoginDate = user.lastLogin 
        ? (window._utils?.formatDate ? window._utils.formatDate(user.lastLogin) : new Date(user.lastLogin).toLocaleString())
        : 'Never';
      
      const statusText = user.status === 'active' ? 'Active' : 
                        user.status === 'inactive' ? 'Inactive' : 
                        user.status === 'banned' ? 'Banned' : 'Unknown';
      
      const roleText = user.role === 'admin' ? 'Admin' : 'User';
      
      const userName = user.name || 'Anonymous';
      const userInitials = userName.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
      
      // Get user's tickets
      const userTickets = state.allTickets.filter(ticket => 
        ticket.user_id === user.id || ticket.telegram_id === user.telegramId
      );
      
      const openTickets = userTickets.filter(t => t.status === 'open').length;
      const inProgressTickets = userTickets.filter(t => t.status === 'in_progress').length;
      const resolvedTickets = userTickets.filter(t => t.status === 'resolved').length;
      
      elements.userModalTitle.textContent = `User: ${escapeHtml(userName)}`;
      elements.userModalBody.innerHTML = `
        <div style="text-align: center; margin-bottom: 30px;">
          <div class="user-avatar-large">${escapeHtml(userInitials)}</div>
          <h3 style="color: var(--primary); margin-bottom: 8px;">${escapeHtml(userName)}</h3>
          <p style="color: var(--muted);">${escapeHtml(user.email)}</p>
        </div>
        
        <div class="user-details-grid">
          <div class="detail-group">
            <label>User ID</label>
            <div class="value">${escapeHtml(user.id.substring(0, 24))}...</div>
          </div>
          <div class="detail-group">
            <label>Role</label>
            <div class="value"><span class="badge badge-${user.role}">${roleText}</span></div>
          </div>
          <div class="detail-group">
            <label>Status</label>
            <div class="value"><span class="badge badge-${user.status}">${statusText}</span></div>
          </div>
          <div class="detail-group">
            <label>Joined Date</label>
            <div class="value">${escapeHtml(formattedDate)}</div>
          </div>
          <div class="detail-group">
            <label>Last Login</label>
            <div class="value">${escapeHtml(lastLoginDate)}</div>
          </div>
          <div class="detail-group">
            <label>Telegram ID</label>
            <div class="value">${escapeHtml(user.telegramId || 'Not linked')}</div>
          </div>
          <div class="detail-group">
            <label>Phone</label>
            <div class="value">${escapeHtml(user.phone || 'Not provided')}</div>
          </div>
          <div class="detail-group">
            <label>Total Tickets</label>
            <div class="value"><strong>${userTickets.length}</strong></div>
          </div>
        </div>
        
        <div class="detail-group" style="grid-column: 1 / -1; margin-top: 20px;">
          <label>Ticket Statistics</label>
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 10px;">
            <div style="text-align: center; padding: 15px; background: #ffedd5; border-radius: 10px;">
              <div style="font-size: 24px; font-weight: bold; color: #c2410c;">${openTickets}</div>
              <div style="font-size: 12px; color: #c2410c;">Open</div>
            </div>
            <div style="text-align: center; padding: 15px; background: #dbeafe; border-radius: 10px;">
              <div style="font-size: 24px; font-weight: bold; color: #1d4ed8;">${inProgressTickets}</div>
              <div style="font-size: 12px; color: #1d4ed8;">In Progress</div>
            </div>
            <div style="text-align: center; padding: 15px; background: #d1fae5; border-radius: 10px;">
              <div style="font-size: 24px; font-weight: bold; color: #065f46;">${resolvedTickets}</div>
              <div style="font-size: 12px; color: #065f46;">Resolved</div>
            </div>
          </div>
        </div>
        
        <div style="display: flex; gap: 12px; margin-top: 30px;">
          <button class="btn ${user.status === 'active' ? 'btn-warning' : 'btn-success'}" onclick="toggleUserStatus('${escapeHtml(user.id)}', '${escapeHtml(userName)}', '${user.status === 'active' ? 'inactive' : 'active'}')">
            <i class="fas ${user.status === 'active' ? 'fa-user-slash' : 'fa-user-check'}"></i>
            ${user.status === 'active' ? 'Deactivate User' : 'Activate User'}
          </button>
          <button class="btn btn-info" onclick="promoteToAdmin('${escapeHtml(user.id)}', '${escapeHtml(userName)}')" ${user.role === 'admin' ? 'disabled' : ''}>
            <i class="fas fa-user-shield"></i>
            Promote to Admin
          </button>
          <button class="btn btn-danger" onclick="showDeleteUserConfirmation('${escapeHtml(user.id)}', '${escapeHtml(userName)}')">
            <i class="fas fa-trash"></i>
            Delete User
          </button>
        </div>
      `;
      
      showModal('user');
    }
    
    async function deleteUser(userId, userName) {
      try {
        // Delete user from Supabase
        const { error } = await supabase
          .from('users')
          .delete()
          .eq('id', userId);
        
        if (error) {
          throw new Error(`Supabase error: ${error.message}`);
        }
        
        // Remove from local state
        state.allUsers = state.allUsers.filter(u => u.id !== userId);
        
        // Update UI
        updateUsersStats();
        applyUsersFilters();
        
        // Show success message
        alert(`User "${userName}" has been deleted successfully.`);
        
        console.log(`Deleted user: ${userName} (${userId})`);
        
      } catch (error) {
        console.error('Error deleting user:', error);
        alert(`Failed to delete user: ${error.message}`);
      }
    }
    
    async function deleteTask(taskId) {
      try {
        // Remove from local state
        state.allTasks = state.allTasks.filter(t => t.id !== taskId);
        
        // Save to storage
        saveTasksToStorage();
        
        return true;
      } catch (error) {
        console.error('Error deleting task:', error);
        throw error;
      }
    }
    
    async function toggleUserStatus(userId, userName, newStatus) {
      try {
        // Update user in Supabase
        const { error } = await supabase
          .from('users')
          .update({ 
            status: newStatus,
            updated_at: new Date().toISOString()
          })
          .eq('id', userId);
        
        if (error) {
          throw new Error(`Supabase error: ${error.message}`);
        }
        
        // Update local state
        const userIndex = state.allUsers.findIndex(u => u.id === userId);
        if (userIndex !== -1) {
          state.allUsers[userIndex].status = newStatus;
        }
        
        // Update UI
        updateUsersStats();
        applyUsersFilters();
        
        // Close user modal if open
        closeModal('user');
        
        // Show success message
        alert(`User "${userName}" has been ${newStatus === 'active' ? 'activated' : 'deactivated'} successfully.`);
        
        console.log(`Updated user status: ${userName} -> ${newStatus}`);
        
      } catch (error) {
        console.error('Error updating user status:', error);
        alert(`Failed to update user status: ${error.message}`);
      }
    }
    
    async function promoteToAdmin(userId, userName) {
      try {
        // Update user role in Supabase
        const { error } = await supabase
          .from('users')
          .update({ 
            role: 'admin',
            updated_at: new Date().toISOString()
          })
          .eq('id', userId);
        
        if (error) {
          throw new Error(`Supabase error: ${error.message}`);
        }
        
        // Update local state
        const userIndex = state.allUsers.findIndex(u => u.id === userId);
        if (userIndex !== -1) {
          state.allUsers[userIndex].role = 'admin';
        }
        
        // Update UI
        applyUsersFilters();
        
        // Close user modal if open
        closeModal('user');
        
        // Show success message
        alert(`User "${userName}" has been promoted to admin successfully.`);
        
        console.log(`Promoted user to admin: ${userName}`);
        
      } catch (error) {
        console.error('Error promoting user:', error);
        alert(`Failed to promote user: ${error.message}`);
      }
    }
    
    function showModal(modalType) {
      if (modalType === 'ticket') {
        elements.ticketModal.style.display = 'flex';
      } else if (modalType === 'user') {
        elements.userModal.style.display = 'flex';
      } else if (modalType === 'confirm') {
        elements.confirmModal.style.display = 'flex';
      } else if (modalType === 'assign') {
        elements.assignModal.style.display = 'flex';
      }
    }
    
    function closeModal(modalType) {
      if (modalType === 'ticket') {
        elements.ticketModal.style.display = 'none';
      } else if (modalType === 'user') {
        elements.userModal.style.display = 'none';
      } else if (modalType === 'confirm') {
        elements.confirmModal.style.display = 'none';
        state.currentModalAction = null;
        state.currentModalData = null;
      } else if (modalType === 'assign') {
        elements.assignModal.style.display = 'none';
        state.ticketToAssign = null;
        elements.assignNotes.value = '';
      }
    }
    
    // ==================== UTILITY FUNCTIONS ====================
    
    function updateLastUpdated() {
      if (!state.lastFetchTime) return;
      
      const now = new Date();
      const diffMs = now - state.lastFetchTime;
      const diffSec = Math.floor(diffMs / 1000);
      const diffMin = Math.floor(diffSec / 60);
      
      let text = 'Last updated: ';
      if (diffSec < 60) {
        text += `${diffSec} second${diffSec !== 1 ? 's' : ''} ago`;
      } else if (diffMin < 60) {
        text += `${diffMin} minute${diffMin !== 1 ? 's' : ''} ago`;
      } else {
        text += state.lastFetchTime.toLocaleTimeString();
      }
      
      elements.lastUpdated.textContent = text;
    }
    
    function startAutoRefresh() {
      // Auto-refresh tickets every 2 minutes
      setInterval(() => {
        if (!state.isLoadingTickets && document.visibilityState === 'visible') {
          loadAllTickets();
        }
      }, 120000);
      
      // Auto-refresh users every 5 minutes
      setInterval(() => {
        if (!state.isLoadingUsers && document.visibilityState === 'visible') {
          loadAllUsers();
        }
      }, 300000);
      
      // Update "last updated" every minute
      setInterval(updateLastUpdated, 60000);
    }
    
    function showTicketsLoading(show) {
      elements.ticketsLoading.style.display = show ? 'block' : 'none';
      if (!show) {
        elements.ticketsTableBody.innerHTML = '';
      }
    }
    
    function showUsersLoading(show) {
      elements.usersLoading.style.display = show ? 'block' : 'none';
      if (!show) {
        elements.usersTableBody.innerHTML = '';
      }
    }
    
    function showTaskLogLoading(show) {
      elements.taskLogLoading.style.display = show ? 'block' : 'none';
      if (!show) {
        elements.taskLogTableBody.innerHTML = '';
      }
    }
    
    function showTicketsError(message) {
      elements.ticketsTableBody.innerHTML = `
        <tr>
          <td colspan="8" style="text-align: center; padding: 40px; color: var(--danger);">
            <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 16px;"></i>
            <h3>Error Loading Tickets</h3>
            <p>${escapeHtml(message)}</p>
            <button class="btn btn-primary" onclick="loadAllTickets()" style="margin-top: 16px;">
              <i class="fas fa-redo"></i> Try Again
            </button>
          </td>
        </tr>
      `;
    }
    
    function showUsersError(message) {
      elements.usersTableBody.innerHTML = `
        <tr>
          <td colspan="7" style="text-align: center; padding: 40px; color: var(--danger);">
            <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 16px;"></i>
            <h3>Error Loading Users</h3>
            <p>${escapeHtml(message)}</p>
            <button class="btn btn-primary" onclick="loadAllUsers()" style="margin-top: 16px;">
              <i class="fas fa-redo"></i> Try Again
            </button>
          </td>
        </tr>
      `;
    }
    
    function showTaskLogError(message) {
      elements.taskLogTableBody.innerHTML = `
        <tr>
          <td colspan="11" style="text-align: center; padding: 40px; color: var(--danger);">
            <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 16px;"></i>
            <h3>Error Loading Task Log</h3>
            <p>${escapeHtml(message)}</p>
            <button class="btn btn-primary" onclick="loadTaskLog()" style="margin-top: 16px;">
              <i class="fas fa-redo"></i> Try Again
            </button>
          </td>
        </tr>
      `;
    }
    
    function exportToCSV() {
      const activeTab = document.querySelector('.tab-btn.active').dataset.tab;
      
      if (activeTab === 'tickets') {
        if (state.filteredTickets.length === 0) {
          alert('No tickets to export');
          return;
        }
        
        // Create CSV content
        const headers = ['ID', 'Name', 'Department', 'Status', 'Urgency', 'Message', 'Created', 'Contact', 'Assigned To', 'Resolved By', 'Resolved At'];
        const csvRows = [];
        
        // Add headers
        csvRows.push(headers.join(','));
        
        // Add data rows
        state.filteredTickets.forEach(ticket => {
          const row = [
            `"${ticket.id}"`,
            `"${ticket.name}"`,
            `"${ticket.department}"`,
            `"${ticket.status}"`,
            `"${ticket.urgency}"`,
            `"${ticket.message.replace(/"/g, '""')}"`,
            `"${new Date(ticket.created_at).toISOString()}"`,
            `"${ticket.contact || ''}"`,
            `"${ticket.assigned_to_name || ''}"`,
            `"${ticket.resolved_by_name || ''}"`,
            `"${ticket.resolved_at ? new Date(ticket.resolved_at).toISOString() : ''}"`
          ];
          csvRows.push(row.join(','));
        });
        
        const csvContent = csvRows.join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.setAttribute('href', url);
        link.setAttribute('download', `tomoca_tickets_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        alert(`Exported ${state.filteredTickets.length} tickets to CSV`);
      } else if (activeTab === 'users') {
        if (state.filteredUsers.length === 0) {
          alert('No users to export');
          return;
        }
        
        // Create CSV content
        const headers = ['ID', 'Name', 'Email', 'Role', 'Status', 'Tickets', 'Joined', 'Last Login', 'Telegram ID'];
        const csvRows = [];
        
        // Add headers
        csvRows.push(headers.join(','));
        
        // Add data rows
        state.filteredUsers.forEach(user => {
          const row = [
            `"${user.id}"`,
            `"${user.name}"`,
            `"${user.email}"`,
            `"${user.role}"`,
            `"${user.status}"`,
            `"${user.ticketCount}"`,
            `"${new Date(user.createdAt).toISOString()}"`,
            `"${user.lastLogin ? new Date(user.lastLogin).toISOString() : ''}"`,
            `"${user.telegramId || ''}"`
          ];
          csvRows.push(row.join(','));
        });
        
        const csvContent = csvRows.join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.setAttribute('href', url);
        link.setAttribute('download', `tomoca_users_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        alert(`Exported ${state.filteredUsers.length} users to CSV`);
      }
    }
    
    function exportTaskLogToCSV() {
      if (state.filteredTasks.length === 0) {
        alert('No task log entries to export');
        return;
      }
      
      // Create CSV content
      const headers = ['Date', 'Priority', 'Ticket ID', 'Task Description', 'Start Time', 'End Time', 'Duration (hours)', 'Status', 'Assigned To', 'Notes/Comments'];
      const csvRows = [];
      
      // Add headers
      csvRows.push(headers.join(','));
      
      // Add data rows
      state.filteredTasks.forEach(task => {
        const row = [
          `"${task.date}"`,
          `"${task.priority}"`,
          `"${task.ticketId || ''}"`,
          `"${task.description.replace(/"/g, '""')}"`,
          `"${task.startTime}"`,
          `"${task.endTime}"`,
          `"${task.duration}"`,
          `"${task.status}"`,
          `"${task.assignedTo}"`,
          `"${(task.notes || '').replace(/"/g, '""')}"`
        ];
        csvRows.push(row.join(','));
      });
      
      const csvContent = csvRows.join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.setAttribute('href', url);
      link.setAttribute('download', `tomoca_task_log_${new Date().toISOString().split('T')[0]}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      alert(`Exported ${state.filteredTasks.length} task log entries to CSV`);
    }
    
    // Utility functions
    function escapeHtml(str) {
      return String(str || '').replace(/[&<>"']/g, s => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
      })[s]);
    }
    
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
    
    // Make functions available globally
    window.updateTicketStatus = updateTicketStatus;
    window.deleteTicket = deleteTicketFromSystem;
    window.assignTicket = showAssignModal;
    window.resolveTicket = resolveTicketPrompt;
    window.editTicket = editTicket;
    window.loadAllTickets = loadAllTickets;
    window.loadAllUsers = loadAllUsers;
    window.loadTaskLog = loadTaskLog;
    window.logoutAdmin = logoutAdmin;
    window.toggleUserStatus = toggleUserStatus;
    window.promoteToAdmin = promoteToAdmin;
    window.showDeleteUserConfirmation = showDeleteUserConfirmation;
    window.deleteTicket = deleteTicketFromSystem;
    window.editTask = editTask;
    
    // Toggle mobile menu
    if (elements.mobileMenuBtn) {
      elements.mobileMenuBtn.addEventListener('click', () => {
        elements.navLinks.classList.toggle('active');
        const icon = elements.mobileMenuBtn.querySelector('i');
        if (elements.navLinks.classList.contains('active')) {
          icon.classList.remove('fa-bars');
          icon.classList.add('fa-times');
        } else {
          icon.classList.remove('fa-times');
          icon.classList.add('fa-bars');
        }
      });
    }
    
    // Close mobile menu when clicking outside
    document.addEventListener('click', (e) => {
      if (elements.navLinks && elements.navLinks.classList.contains('active') &&
          !e.target.closest('.nav-container') && 
          !e.target.closest('.mobile-menu-btn')) {
        elements.navLinks.classList.remove('active');
        const icon = elements.mobileMenuBtn.querySelector('i');
        icon.classList.remove('fa-times');
        icon.classList.add('fa-bars');
      }
    });
    
  })();
</script>
</body>
</html>

<!-- BEGIN PATCH: Ensure delete & resolve functions work without changing UI -->
<script>
(async function(){
  try {
    // Create a Supabase client (same credentials as original file)
    const SUPABASE_URL = 'https://zdxjvqmwblcpewogcxmd.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpkeGp2cW13YmxjcGV3b2djeG1kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5NjU0MjIsImV4cCI6MjA4MTU0MTQyMn0.JKvDcX9MTUESD1e3fAWN_SeUzojUaaez5ZXOwPU8psM';
    const supabaseClient = supabase ? (supabase) : (window.supabase ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null);
    // helper to safely call loadAllTickets if present
    const refresh = async () => { if (typeof window.loadAllTickets === 'function') { try { await window.loadAllTickets(); } catch(e){ console.warn('refresh failed', e); } } };

    window.deleteTicketFromSystem = async function(ticketId){
      if(!ticketId) return { success:false, message:'No ticket id' };
      // confirm if called directly from UI not via modal
      try {
        // delete from supabase if exists
        if (supabaseClient) {
          const { data, error } = await supabaseClient.from('tickets').select('id').eq('id', ticketId).limit(1).single();
          if (error && error.code && error.code !== 'PGRST116') {
            console.warn('Supabase check error', error);
          } else if (data) {
            const { error: delErr } = await supabaseClient.from('tickets').delete().eq('id', ticketId);
            if (delErr) console.warn('Supabase delete error', delErr);
          }
        }
        // attempt to call admin API if present
        if (window._admin && typeof window._admin.deleteTicket === 'function') {
          try {
            await window._admin.deleteTicket(ticketId);
          } catch(e){ console.warn('admin delete failed', e); }
        }
        // remove from local arrays if present
        if (window.state && Array.isArray(window.state.allTickets)) {
          window.state.allTickets = window.state.allTickets.filter(t => String(t.id) !== String(ticketId));
        }
        await refresh();
        return { success:true, message:'Ticket deleted' };
      } catch(err){
        console.error('deleteTicketFromSystem error', err);
        throw err;
      }
    };

    window.deleteTicket = async function(ticketId){
      if(!ticketId) return;
      if (!confirm(`Are you sure you want to permanently delete ticket #${ticketId}?`)) return;
      try {
        const res = await window.deleteTicketFromSystem(ticketId);
        alert(res.message || 'Deleted');
      } catch(err){
        alert('Failed to delete ticket: ' + (err.message || err));
      }
    };

    window.resolveTicket = async function(ticketId, resolverId, resolverName){
      if(!ticketId) return { success:false, message:'No ticket id' };
      try {
        const updateData = {
          status: 'resolved',
          resolved_by: resolverId || (window.state && window.state.currentAdminId) || null,
          resolved_by_name: resolverName || (window.state && window.state.currentAdminName) || 'Admin',
          resolved_at: new Date().toISOString()
        };
        // admin API
        if (window._admin && typeof window._admin.updateTicket === 'function') {
          try { await window._admin.updateTicket(ticketId, updateData); } catch(e){ console.warn('admin.updateTicket failed', e); }
        }
        // supabase update
        if (supabaseClient) {
          const { error } = await supabaseClient.from('tickets').update(updateData).eq('id', ticketId);
          if (error) console.warn('Supabase resolve error', error);
        }
        // update local state
        if (window.state && Array.isArray(window.state.allTickets)) {
          const idx = window.state.allTickets.findIndex(t => String(t.id) === String(ticketId));
          if (idx !== -1) {
            window.state.allTickets[idx] = { ...window.state.allTickets[idx], ...updateData };
          }
        }
        await refresh();
        return { success:true };
      } catch(err){
        console.error('resolveTicket error', err);
        throw err;
      }
    };

    window.resolveTicketPrompt = async function(ticketId){
      if(!ticketId) return;
      if (!confirm('Are you sure you want to mark this ticket as resolved?')) return;
      try {
        const res = await window.resolveTicket(ticketId);
        alert('Ticket resolved.');
      } catch(err){
        alert('Failed to resolve: ' + (err.message || err));
      }
    };

    console.log('Patch script loaded: delete & resolve overrides installed.');
  } catch(e){
    console.error('Patch init error', e);
  }
})();
</script>
<!-- END PATCH -->
