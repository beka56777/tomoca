[file name]: user-management.html
[file content begin]
<!-- frontend/user-management.html -->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<meta name="description" content="Tomoca User Management - Manage all registered users"/>
<title>User Management — Tomoca Coffee Support</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  :root {
    --primary: #4e2b18;
    --secondary: #d4a373;
    --light: #f8f5f2;
    --dark: #2c1810;
    --card: #ffffff;
    --muted: #7d7d7d;
    --accent: #8B4513;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
    --info: #3b82f6;
    --border: #e5e7eb;
    --radius: 16px;
    --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    --shadow-hover: 0 8px 30px rgba(0, 0, 0, 0.12);
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  html, body {
    height: 100%;
    font-family: 'Poppins', sans-serif;
    color: var(--dark);
    background: linear-gradient(135deg, var(--light) 0%, #f0ebe6 100%);
    overflow-x: hidden;
  }

  body {
    min-height: 100vh;
    padding: 24px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  /* Navigation Bar */
  .admin-nav {
    background: var(--card);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 0;
    width: 100%;
    max-width: 1400px;
    margin-bottom: 24px;
    border-left: 4px solid var(--primary);
  }

  .nav-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 24px;
    height: 70px;
  }

  .nav-brand {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .nav-brand h2 {
    font-size: 20px;
    font-weight: 600;
    color: var(--primary);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .nav-brand h2 i {
    color: var(--secondary);
  }

  .nav-links {
    display: flex;
    list-style: none;
    gap: 8px;
    margin: 0;
    padding: 0;
  }

  .nav-links li {
    position: relative;
  }

  .nav-links a {
    color: var(--dark);
    text-decoration: none;
    font-weight: 500;
    font-size: 14px;
    padding: 12px 20px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: all 0.3s ease;
    white-space: nowrap;
  }

  .nav-links a i {
    font-size: 16px;
    width: 20px;
    text-align: center;
  }

  .nav-links a:hover {
    background: var(--light);
    color: var(--primary);
    transform: translateY(-2px);
  }

  .nav-links a.active {
    background: linear-gradient(135deg, var(--primary), #6b3920);
    color: white;
    box-shadow: 0 4px 15px rgba(78, 43, 24, 0.2);
  }

  .nav-links a.active:hover {
    background: linear-gradient(135deg, #6b3920, var(--primary));
  }

  .nav-links a.logout {
    background: var(--light);
    color: var(--danger);
    border: 1px solid var(--border);
  }

  .nav-links a.logout:hover {
    background: var(--danger);
    color: white;
    transform: translateY(-2px);
  }

  .nav-links a.logout i {
    color: var(--danger);
  }

  .nav-links a.logout:hover i {
    color: white;
  }

  .mobile-menu-btn {
    display: none;
    background: none;
    border: none;
    font-size: 24px;
    color: var(--primary);
    cursor: pointer;
    padding: 8px;
  }

  /* Main Container */
  .container {
    width: 100%;
    max-width: 1400px;
    display: flex;
    flex-direction: column;
    gap: 24px;
  }

  /* Header */
  .header {
    background: var(--card);
    border-radius: var(--radius);
    padding: 28px 32px;
    box-shadow: var(--shadow);
    border-left: 6px solid var(--primary);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 20px;
  }

  .header-content h1 {
    font-size: 28px;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .header-content h1 i {
    color: var(--secondary);
  }

  .header-content p {
    color: var(--muted);
    font-size: 15px;
    max-width: 700px;
  }

  .header-actions {
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
  }

  /* Button Styles */
  .btn {
    padding: 12px 24px;
    border-radius: 12px;
    border: none;
    font-family: 'Poppins', sans-serif;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    white-space: nowrap;
  }

  .btn-primary {
    background: linear-gradient(135deg, var(--primary), #6b3920);
    color: white;
  }

  .btn-primary:hover {
    background: linear-gradient(135deg, #6b3920, var(--primary));
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(78, 43, 24, 0.25);
  }

  .btn-secondary {
    background: var(--light);
    color: var(--dark);
    border: 1px solid var(--border);
  }

  .btn-secondary:hover {
    background: white;
    transform: translateY(-2px);
    box-shadow: var(--shadow);
  }

  .btn-success {
    background: var(--success);
    color: white;
  }

  .btn-danger {
    background: var(--danger);
    color: white;
  }

  .btn-warning {
    background: var(--warning);
    color: white;
  }

  .btn-info {
    background: var(--info);
    color: white;
  }

  .btn-small {
    padding: 8px 16px;
    font-size: 13px;
  }

  /* Stats Grid */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 20px;
  }

  .stat-card {
    background: var(--card);
    border-radius: var(--radius);
    padding: 24px;
    box-shadow: var(--shadow);
    display: flex;
    align-items: center;
    gap: 20px;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .stat-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-hover);
  }

  .stat-icon {
    width: 60px;
    height: 60px;
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: white;
  }

  .stat-icon.users { background: linear-gradient(135deg, #ec4899, #f472b6); }
  .stat-icon.active-users { background: linear-gradient(135deg, #10b981, #34d399); }
  .stat-icon.new-users { background: linear-gradient(135deg, #3b82f6, #60a5fa); }
  .stat-icon.admins { background: linear-gradient(135deg, #8b5cf6, #a78bfa); }
  .stat-icon.inactive-users { background: linear-gradient(135deg, #f59e0b, #fbbf24); }
  .stat-icon.today-logins { background: linear-gradient(135deg, #06b6d4, #22d3ee); }

  .stat-info h3 {
    font-size: 32px;
    font-weight: 700;
    color: var(--dark);
    line-height: 1;
    margin-bottom: 4px;
  }

  .stat-info p {
    color: var(--muted);
    font-size: 14px;
    font-weight: 500;
  }

  /* Controls Card */
  .controls-card {
    background: var(--card);
    border-radius: var(--radius);
    padding: 24px;
    box-shadow: var(--shadow);
  }

  .controls-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 16px;
  }

  .controls-header h2 {
    font-size: 20px;
    color: var(--primary);
    display: flex;
    align-items: center;
    gap: 10px;
  }

  /* Filters */
  .filters-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 20px;
  }

  .filter-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .filter-group label {
    font-size: 14px;
    font-weight: 600;
    color: var(--dark);
  }

  .form-control {
    padding: 12px 16px;
    border-radius: 10px;
    border: 2px solid var(--border);
    font-family: 'Poppins', sans-serif;
    font-size: 14px;
    background: white;
    color: var(--dark);
    transition: all 0.3s ease;
  }

  .form-control:focus {
    outline: none;
    border-color: var(--secondary);
    box-shadow: 0 0 0 3px rgba(212, 163, 115, 0.2);
  }

  /* Search Box */
  .search-container {
    position: relative;
    width: 100%;
  }

  .search-box {
    width: 100%;
    padding: 14px 20px 14px 48px;
    border-radius: 12px;
    border: 2px solid var(--border);
    font-size: 15px;
    background: white;
    transition: all 0.3s ease;
  }

  .search-box:focus {
    border-color: var(--secondary);
    box-shadow: 0 0 0 3px rgba(212, 163, 115, 0.2);
  }

  .search-icon {
    position: absolute;
    left: 16px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--muted);
  }

  /* Users Table */
  .users-table-container {
    background: var(--card);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow: hidden;
  }

  .table-header {
    padding: 24px;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 16px;
  }

  .table-header h2 {
    font-size: 20px;
    color: var(--primary);
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .table-tools {
    display: flex;
    gap: 12px;
    align-items: center;
  }

  .table-wrapper {
    overflow-x: auto;
  }

  .users-table {
    width: 100%;
    border-collapse: collapse;
    min-width: 1000px;
  }

  .users-table thead {
    background: linear-gradient(135deg, var(--primary), #5a3315);
    color: white;
  }

  .users-table th {
    padding: 18px 20px;
    text-align: left;
    font-weight: 600;
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .users-table th i {
    margin-right: 8px;
  }

  .users-table tbody tr {
    border-bottom: 1px solid var(--border);
    transition: background-color 0.2s ease;
  }

  .users-table tbody tr:hover {
    background-color: rgba(248, 245, 242, 0.6);
  }

  .users-table td {
    padding: 20px;
    vertical-align: middle;
  }

  .user-info-cell {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .user-avatar {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--secondary), var(--primary));
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 16px;
    flex-shrink: 0;
  }

  .user-info h4 {
    font-size: 15px;
    font-weight: 600;
    color: var(--dark);
  }

  .user-info p {
    font-size: 13px;
    color: var(--muted);
  }

  /* Status Badges */
  .badge {
    padding: 8px 14px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  .badge-active {
    background-color: #d1fae5;
    color: #065f46;
  }

  .badge-inactive {
    background-color: #f3f4f6;
    color: #6b7280;
  }

  .badge-banned {
    background-color: #fee2e2;
    color: #991b1b;
  }

  .badge-admin {
    background-color: #e0e7ff;
    color: #3730a3;
  }

  .badge-user {
    background-color: #f3f4f6;
    color: #4b5563;
  }

  /* User Actions */
  .user-actions {
    display: flex;
    gap: 8px;
  }

  .action-btn {
    width: 36px;
    height: 36px;
    border-radius: 10px;
    border: none;
    background: var(--light);
    color: var(--muted);
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .action-btn:hover {
    background: var(--secondary);
    color: white;
    transform: translateY(-2px);
  }

  .action-btn-danger:hover {
    background: var(--danger);
  }

  .action-btn-warning:hover {
    background: var(--warning);
  }

  .action-btn-info:hover {
    background: var(--info);
  }

  .action-btn-success:hover {
    background: var(--success);
  }

  /* Pagination */
  .pagination {
    padding: 24px;
    border-top: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 16px;
  }

  .pagination-info {
    color: var(--muted);
    font-size: 14px;
  }

  .pagination-controls {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .page-btn {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    border: 1px solid var(--border);
    background: white;
    color: var(--dark);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .page-btn:hover:not(:disabled) {
    background: var(--light);
    border-color: var(--secondary);
  }

  .page-btn.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
  }

  .page-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* Loading States */
  .loading {
    padding: 40px;
    text-align: center;
    color: var(--muted);
  }

  .loading-spinner {
    width: 50px;
    height: 50px;
    border: 4px solid var(--border);
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Modal */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 20px;
  }

  .modal-content {
    background: white;
    border-radius: var(--radius);
    width: 100%;
    max-width: 800px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  }

  .modal-header {
    padding: 24px;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .modal-header h3 {
    color: var(--primary);
    font-size: 22px;
  }

  .modal-close {
    background: none;
    border: none;
    font-size: 24px;
    color: var(--muted);
    cursor: pointer;
    transition: color 0.3s ease;
  }

  .modal-close:hover {
    color: var(--danger);
  }

  .modal-body {
    padding: 24px;
  }

  .user-details-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }

  .detail-group label {
    display: block;
    font-size: 13px;
    color: var(--muted);
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
  }

  .detail-group .value {
    font-size: 16px;
    color: var(--dark);
    font-weight: 500;
  }

  /* User Details Specific */
  .user-avatar-large {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--secondary), var(--primary));
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 32px;
    margin: 0 auto 20px;
  }

  /* Create User Form */
  .create-user-form {
    display: none;
    background: var(--card);
    border-radius: var(--radius);
    padding: 24px;
    box-shadow: var(--shadow);
    margin-bottom: 24px;
  }

  .create-user-form.active {
    display: block;
  }

  .form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 16px;
  }

  .form-actions {
    display: flex;
    gap: 12px;
    margin-top: 24px;
    padding-top: 24px;
    border-top: 1px solid var(--border);
  }

  /* Footer */
  .footer {
    text-align: center;
    padding: 20px;
    color: var(--muted);
    font-size: 14px;
    width: 100%;
  }

  /* Responsive */
  @media (max-width: 1200px) {
    .container {
      max-width: 100%;
    }
  }

  @media (max-width: 992px) {
    .mobile-menu-btn {
      display: block;
    }
    
    .nav-links {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow-hover);
      flex-direction: column;
      padding: 16px;
      gap: 8px;
      display: none;
      z-index: 100;
      margin-top: 10px;
    }
    
    .nav-links.active {
      display: flex;
    }
    
    .nav-links a {
      justify-content: space-between;
      padding: 16px 20px;
    }
    
    .nav-container {
      padding: 0 16px;
    }
  }

  @media (max-width: 768px) {
    body {
      padding: 16px;
    }
    
    .header {
      padding: 20px;
    }
    
    .header-content h1 {
      font-size: 24px;
    }
    
    .stats-grid {
      grid-template-columns: repeat(2, 1fr);
    }
    
    .users-table th,
    .users-table td {
      padding: 12px;
    }
    
    .nav-brand h2 {
      font-size: 18px;
    }
  }

  @media (max-width: 576px) {
    .stats-grid {
      grid-template-columns: 1fr;
    }
    
    .filters-grid {
      grid-template-columns: 1fr;
    }
    
    .header-actions {
      flex-direction: column;
      width: 100%;
    }
    
    .header-actions .btn {
      width: 100%;
      justify-content: center;
    }
    
    .pagination {
      flex-direction: column;
      text-align: center;
    }
    
    .nav-container {
      height: 60px;
    }
    
    .nav-brand h2 {
      font-size: 16px;
    }
    
    .form-row {
      grid-template-columns: 1fr;
    }
  }

  /* Empty State */
  .empty-state {
    padding: 60px 20px;
    text-align: center;
    color: var(--muted);
  }

  .empty-state i {
    font-size: 60px;
    margin-bottom: 20px;
    color: var(--border);
  }

  .empty-state h3 {
    font-size: 20px;
    margin-bottom: 10px;
    color: var(--dark);
  }

  /* Toast Notification */
  .toast {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 16px 24px;
    border-radius: var(--radius);
    background: white;
    box-shadow: var(--shadow-hover);
    display: flex;
    align-items: center;
    gap: 12px;
    z-index: 2000;
    transform: translateX(150%);
    transition: transform 0.3s ease;
  }

  .toast.show {
    transform: translateX(0);
  }

  .toast-success {
    border-left: 4px solid var(--success);
  }

  .toast-error {
    border-left: 4px solid var(--danger);
  }

  .toast-warning {
    border-left: 4px solid var(--warning);
  }

  .toast-info {
    border-left: 4px solid var(--info);
  }
</style>
</head>
<body>
  <!-- Navigation Bar -->
  <nav class="admin-nav">
    <div class="nav-container">
      <div class="nav-brand">
        <h2><i class="fas fa-coffee"></i> Tomoca Admin</h2>
      </div>
      
      <button class="mobile-menu-btn" id="mobileMenuBtn">
        <i class="fas fa-bars"></i>
      </button>
      
      <ul class="nav-links" id="navLinks">
        <li>
          <a href="track.html" id="trackLink">
            <i class="fas fa-search"></i>
            <span>Track Ticket</span>
          </a>
        </li>
        <li>
          <a href="tickets.html" id="ticketsLink">
            <i class="fas fa-ticket-alt"></i>
            <span>All Tickets</span>
          </a>
        </li>
        <li>
          <a href="dashboard.html" id="dashboardLink">
            <i class="fas fa-chart-line"></i>
            <span>Dashboard</span>
          </a>
        </li>
        <li>
          <a href="history.html" id="historyLink">
            <i class="fas fa-history"></i>
            <span>History</span>
          </a>
        </li>
        <li>
          <a href="user-management.html" class="active" id="userManagementLink">
            <i class="fas fa-users"></i>
            <span>User Management</span>
          </a>
        </li>
        <li>
          <a href="#" class="logout" id="logoutLink">
            <i class="fas fa-sign-out-alt"></i>
            <span>Logout</span>
          </a>
        </li>
      </ul>
    </div>
  </nav>

  <!-- Main Container -->
  <div class="container">
    <!-- Header -->
    <header class="header">
      <div class="header-content">
        <h1><i class="fas fa-users"></i> User Management</h1>
        <p>Manage all registered users. View, edit, activate, deactivate, or delete user accounts.</p>
      </div>
      <div class="header-actions">
        <button class="btn btn-primary" id="refreshBtn">
          <i class="fas fa-sync-alt"></i> Refresh Users
        </button>
        <button class="btn btn-success" id="createUserBtn">
          <i class="fas fa-user-plus"></i> Create User
        </button>
        <button class="btn btn-info" id="exportUsersBtn">
          <i class="fas fa-download"></i> Export CSV
        </button>
      </div>
    </header>

    <!-- Create User Form (Hidden by default) -->
    <div class="create-user-form" id="createUserForm">
      <div class="controls-header">
        <h2><i class="fas fa-user-plus"></i> Create New User</h2>
        <button class="btn btn-secondary" id="closeCreateFormBtn">
          <i class="fas fa-times"></i> Cancel
        </button>
      </div>
      
      <div class="filters-grid">
        <div class="filter-group">
          <label for="newUserName"><i class="fas fa-user"></i> Full Name *</label>
          <input type="text" id="newUserName" class="form-control" placeholder="Enter full name" required>
        </div>
        
        <div class="filter-group">
          <label for="newUserEmail"><i class="fas fa-envelope"></i> Email Address *</label>
          <input type="email" id="newUserEmail" class="form-control" placeholder="Enter email address" required>
        </div>
        
        <div class="filter-group">
          <label for="newUserPhone"><i class="fas fa-phone"></i> Phone Number</label>
          <input type="tel" id="newUserPhone" class="form-control" placeholder="Enter phone number">
        </div>
        
        <div class="filter-group">
          <label for="newUserRole"><i class="fas fa-user-shield"></i> Role</label>
          <select id="newUserRole" class="form-control">
            <option value="user">User</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label for="newUserStatus"><i class="fas fa-user-tag"></i> Status</label>
          <select id="newUserStatus" class="form-control">
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label for="newUserPassword"><i class="fas fa-lock"></i> Password *</label>
          <input type="password" id="newUserPassword" class="form-control" placeholder="Enter password" required>
        </div>
        
        <div class="filter-group">
          <label for="newUserConfirmPassword"><i class="fas fa-lock"></i> Confirm Password *</label>
          <input type="password" id="newUserConfirmPassword" class="form-control" placeholder="Confirm password" required>
        </div>
      </div>
      
      <div class="form-actions">
        <button class="btn btn-secondary" id="resetFormBtn">
          <i class="fas fa-redo"></i> Reset Form
        </button>
        <button class="btn btn-success" id="submitCreateUserBtn">
          <i class="fas fa-check"></i> Create User
        </button>
      </div>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon users">
          <i class="fas fa-users"></i>
        </div>
        <div class="stat-info">
          <h3 id="stat-total-users">0</h3>
          <p>Total Users</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon active-users">
          <i class="fas fa-user-check"></i>
        </div>
        <div class="stat-info">
          <h3 id="stat-active-users">0</h3>
          <p>Active Users</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon admins">
          <i class="fas fa-user-shield"></i>
        </div>
        <div class="stat-info">
          <h3 id="stat-admin-users">0</h3>
          <p>Admin Users</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon new-users">
          <i class="fas fa-user-plus"></i>
        </div>
        <div class="stat-info">
          <h3 id="stat-new-users-week">0</h3>
          <p>New This Week</p>
        </div>
      </div>
    </div>

    <!-- User Filters -->
    <div class="controls-card">
      <div class="controls-header">
        <h2><i class="fas fa-filter"></i> User Filters & Search</h2>
        <div class="table-tools">
          <button class="btn btn-secondary" id="clearFiltersBtn">
            <i class="fas fa-times"></i> Clear Filters
          </button>
          <button class="btn btn-primary" id="bulkActionBtn" style="display: none;" data-action="activate">
            <i class="fas fa-check"></i> Activate Selected
          </button>
        </div>
      </div>
      
      <div class="filters-grid">
        <div class="filter-group">
          <label for="searchInput"><i class="fas fa-search"></i> Search Users</label>
          <div class="search-container">
            <input type="text" id="searchInput" class="search-box" placeholder="Search by name, email, or ID...">
            <i class="fas fa-search search-icon"></i>
          </div>
        </div>
        
        <div class="filter-group">
          <label for="statusFilter"><i class="fas fa-user-tag"></i> Status</label>
          <select id="statusFilter" class="form-control">
            <option value="all">All Statuses</option>
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
            <option value="banned">Banned</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label for="roleFilter"><i class="fas fa-user-shield"></i> Role</label>
          <select id="roleFilter" class="form-control">
            <option value="all">All Roles</option>
            <option value="user">User</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label for="sortFilter"><i class="fas fa-sort"></i> Sort By</label>
          <select id="sortFilter" class="form-control">
            <option value="newest">Newest First</option>
            <option value="oldest">Oldest First</option>
            <option value="name_asc">Name (A-Z)</option>
            <option value="name_desc">Name (Z-A)</option>
            <option value="email_asc">Email (A-Z)</option>
            <option value="last_login">Last Login</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Users Table -->
    <div class="users-table-container">
      <div class="table-header">
        <h2><i class="fas fa-users"></i> All Users</h2>
        <div class="table-tools">
          <span class="pagination-info" id="tableInfo">Loading users...</span>
          <div class="form-control" style="padding: 0; border: none; background: none;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="selectAllCheckbox" style="width: 18px; height: 18px;">
              <span style="font-size: 13px; font-weight: 600;">Select All</span>
            </label>
          </div>
        </div>
      </div>
      
      <div class="table-wrapper">
        <table class="users-table" id="usersTable">
          <thead>
            <tr>
              <th style="width: 40px;"></th>
              <th><i class="fas fa-user"></i> User</th>
              <th><i class="fas fa-envelope"></i> Email</th>
              <th><i class="fas fa-shield-alt"></i> Role</th>
              <th><i class="fas fa-ticket-alt"></i> Tickets</th>
              <th><i class="fas fa-calendar"></i> Joined</th>
              <th><i class="fas fa-signal"></i> Status</th>
              <th><i class="fas fa-ellipsis-h"></i> Actions</th>
            </tr>
          </thead>
          <tbody id="usersTableBody">
            <!-- Users will be loaded here -->
          </tbody>
        </table>
      </div>
      
      <div class="loading" id="loadingIndicator">
        <div class="loading-spinner"></div>
        <p>Loading users from database...</p>
      </div>
      
      <div class="empty-state" id="emptyState" style="display: none;">
        <i class="fas fa-users-slash"></i>
        <h3>No Users Found</h3>
        <p>No users match your current filters. Try changing your search criteria.</p>
      </div>
      
      <div class="pagination" id="paginationControls" style="display: none;">
        <div class="pagination-info" id="pageInfo"></div>
        <div class="pagination-controls">
          <button class="page-btn" id="prevPageBtn" disabled>
            <i class="fas fa-chevron-left"></i>
          </button>
          <button class="page-btn" id="page1Btn" data-page="1">1</button>
          <button class="page-btn" id="page2Btn" data-page="2">2</button>
          <button class="page-btn" id="page3Btn" data-page="3">3</button>
          <span>...</span>
          <button class="page-btn" id="nextPageBtn">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
      <p>Tomoca Coffee User Management • <span id="lastUpdated">Last updated: --:--:--</span></p>
      <p class="small" style="font-size: 12px; margin-top: 5px;">
        Connected to Supabase • All user data is managed in real-time
      </p>
    </footer>
  </div>

  <!-- User Details Modal -->
  <div class="modal-overlay" id="userModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="userModalTitle">User Details</h3>
        <button class="modal-close" id="closeUserModalBtn">&times;</button>
      </div>
      <div class="modal-body" id="userModalBody">
        <!-- User details will be loaded here -->
      </div>
    </div>
  </div>

  <!-- Edit User Modal -->
  <div class="modal-overlay" id="editUserModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="editUserModalTitle">Edit User</h3>
        <button class="modal-close" id="closeEditUserModalBtn">&times;</button>
      </div>
      <div class="modal-body" id="editUserModalBody">
        <!-- Edit user form will be loaded here -->
      </div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div class="modal-overlay" id="confirmModal">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h3 id="confirmModalTitle">Confirm Action</h3>
        <button class="modal-close" id="closeConfirmModalBtn">&times;</button>
      </div>
      <div class="modal-body" id="confirmModalBody">
        <!-- Confirmation message will be loaded here -->
      </div>
      <div class="modal-footer" style="padding: 20px; display: flex; gap: 12px; justify-content: flex-end; border-top: 1px solid var(--border);">
        <button class="btn btn-secondary" id="cancelConfirmBtn">Cancel</button>
        <button class="btn btn-danger" id="confirmActionBtn">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div class="toast" id="toast">
    <i class="fas fa-check-circle" id="toastIcon"></i>
    <span id="toastMessage">Operation completed successfully!</span>
  </div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  (function() {
    // IMPORTANT: These should match the credentials in index.html
    const SUPABASE_URL = 'https://zdxjvqmwblcpewogcxmd.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpkeGp2cW13YmxjcGV3b2djeG1kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5NjU0MjIsImV4cCI6MjA4MTU0MTQyMn0.JKvDcX9MTUESD1e3fAWN_SeUzojUaaez5ZXOwPU8psM';
    
    // Initialize Supabase
    let supabase;
    try {
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      console.log('Supabase initialized successfully for user management');
    } catch (error) {
      console.error('Failed to initialize Supabase:', error);
    }
    
    // DOM Elements
    const elements = {
      // Navigation
      mobileMenuBtn: document.getElementById('mobileMenuBtn'),
      navLinks: document.getElementById('navLinks'),
      trackLink: document.getElementById('trackLink'),
      ticketsLink: document.getElementById('ticketsLink'),
      dashboardLink: document.getElementById('dashboardLink'),
      historyLink: document.getElementById('historyLink'),
      userManagementLink: document.getElementById('userManagementLink'),
      logoutLink: document.getElementById('logoutLink'),
      
      // Stats
      statTotalUsers: document.getElementById('stat-total-users'),
      statActiveUsers: document.getElementById('stat-active-users'),
      statAdminUsers: document.getElementById('stat-admin-users'),
      statNewUsersWeek: document.getElementById('stat-new-users-week'),
      
      // Table
      usersTableBody: document.getElementById('usersTableBody'),
      loadingIndicator: document.getElementById('loadingIndicator'),
      emptyState: document.getElementById('emptyState'),
      tableInfo: document.getElementById('tableInfo'),
      selectAllCheckbox: document.getElementById('selectAllCheckbox'),
      
      // Filters
      searchInput: document.getElementById('searchInput'),
      statusFilter: document.getElementById('statusFilter'),
      roleFilter: document.getElementById('roleFilter'),
      sortFilter: document.getElementById('sortFilter'),
      clearFiltersBtn: document.getElementById('clearFiltersBtn'),
      bulkActionBtn: document.getElementById('bulkActionBtn'),
      
      // Create User Form
      createUserForm: document.getElementById('createUserForm'),
      createUserBtn: document.getElementById('createUserBtn'),
      closeCreateFormBtn: document.getElementById('closeCreateFormBtn'),
      resetFormBtn: document.getElementById('resetFormBtn'),
      submitCreateUserBtn: document.getElementById('submitCreateUserBtn'),
      newUserName: document.getElementById('newUserName'),
      newUserEmail: document.getElementById('newUserEmail'),
      newUserPhone: document.getElementById('newUserPhone'),
      newUserRole: document.getElementById('newUserRole'),
      newUserStatus: document.getElementById('newUserStatus'),
      newUserPassword: document.getElementById('newUserPassword'),
      newUserConfirmPassword: document.getElementById('newUserConfirmPassword'),
      
      // Buttons
      refreshBtn: document.getElementById('refreshBtn'),
      exportUsersBtn: document.getElementById('exportUsersBtn'),
      
      // Modals
      userModal: document.getElementById('userModal'),
      closeUserModalBtn: document.getElementById('closeUserModalBtn'),
      userModalTitle: document.getElementById('userModalTitle'),
      userModalBody: document.getElementById('userModalBody'),
      
      editUserModal: document.getElementById('editUserModal'),
      closeEditUserModalBtn: document.getElementById('closeEditUserModalBtn'),
      editUserModalTitle: document.getElementById('editUserModalTitle'),
      editUserModalBody: document.getElementById('editUserModalBody'),
      
      confirmModal: document.getElementById('confirmModal'),
      closeConfirmModalBtn: document.getElementById('closeConfirmModalBtn'),
      confirmModalTitle: document.getElementById('confirmModalTitle'),
      confirmModalBody: document.getElementById('confirmModalBody'),
      cancelConfirmBtn: document.getElementById('cancelConfirmBtn'),
      confirmActionBtn: document.getElementById('confirmActionBtn'),
      
      // Pagination
      paginationControls: document.getElementById('paginationControls'),
      prevPageBtn: document.getElementById('prevPageBtn'),
      nextPageBtn: document.getElementById('nextPageBtn'),
      page1Btn: document.getElementById('page1Btn'),
      page2Btn: document.getElementById('page2Btn'),
      page3Btn: document.getElementById('page3Btn'),
      pageInfo: document.getElementById('pageInfo'),
      
      // Toast
      toast: document.getElementById('toast'),
      toastIcon: document.getElementById('toastIcon'),
      toastMessage: document.getElementById('toastMessage'),
      
      // Last updated
      lastUpdated: document.getElementById('lastUpdated')
    };
    
    // State
    let state = {
      allUsers: [],
      filteredUsers: [],
      selectedUsers: new Set(),
      currentPage: 1,
      usersPerPage: 15,
      totalPages: 1,
      lastFetchTime: null,
      isLoading: false,
      currentModalAction: null,
      currentModalData: null,
      ticketsData: [] // We'll fetch tickets to calculate user ticket counts
    };
    
    // Admin Secret from URL (if used)
    const urlParams = new URLSearchParams(window.location.search);
    const adminSecret = urlParams.get('admin') || '';
    
    // Logout Function
    async function logoutAdmin() {
      if (confirm('Are you sure you want to logout?')) {
        try {
          // If Supabase is available, sign out from Supabase first
          if (supabase) {
            const { error } = await supabase.auth.signOut();
            if (error) {
              console.error('Supabase logout error:', error);
            } else {
              console.log('Successfully signed out from Supabase');
            }
          }
          
          // Clear all admin-related storage
          localStorage.removeItem('adminToken');
          sessionStorage.removeItem('adminLoggedIn');
          localStorage.removeItem('adminSecret');
          localStorage.removeItem('lastAdminAccess');
          localStorage.removeItem('supabase.auth.token');
          
          // Clear any cookies related to admin
          document.cookie = "adminToken=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
          document.cookie = "adminSecret=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
          document.cookie = "sb-access-token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
          document.cookie = "sb-refresh-token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
          
          // Redirect to main login page
          window.location.href = 'index.html';
          
        } catch (error) {
          console.error('Logout error:', error);
          // Still redirect even if there's an error
          window.location.href = 'index.html';
        }
      }
    }
    
    // Initialize navigation links with admin secret
    function updateNavLinks() {
      const links = [elements.trackLink, elements.ticketsLink, elements.dashboardLink, elements.historyLink];
      links.forEach(link => {
        if (link) {
          const currentHref = link.getAttribute('href');
          if (currentHref.includes('?')) {
            link.href = `${currentHref.split('?')[0]}?admin=${adminSecret}`;
          } else {
            link.href = `${currentHref}?admin=${adminSecret}`;
          }
        }
      });
      
      // Current page link
      if (elements.userManagementLink) {
        elements.userManagementLink.href = `user-management.html?admin=${adminSecret}`;
      }
      
      // Logout functionality
      if (elements.logoutLink) {
        elements.logoutLink.addEventListener('click', function(e) {
          e.preventDefault();
          logoutAdmin();
        });
      }
    }
    
    // Toggle mobile menu
    if (elements.mobileMenuBtn) {
      elements.mobileMenuBtn.addEventListener('click', () => {
        elements.navLinks.classList.toggle('active');
        const icon = elements.mobileMenuBtn.querySelector('i');
        if (elements.navLinks.classList.contains('active')) {
          icon.classList.remove('fa-bars');
          icon.classList.add('fa-times');
        } else {
          icon.classList.remove('fa-times');
          icon.classList.add('fa-bars');
        }
      });
    }
    
    // Close mobile menu when clicking outside
    document.addEventListener('click', (e) => {
      if (elements.navLinks && elements.navLinks.classList.contains('active') &&
          !e.target.closest('.nav-container') && 
          !e.target.closest('.mobile-menu-btn')) {
        elements.navLinks.classList.remove('active');
        const icon = elements.mobileMenuBtn.querySelector('i');
        icon.classList.remove('fa-times');
        icon.classList.add('fa-bars');
      }
    });
    
    // Initialize
    document.addEventListener('DOMContentLoaded', init);
    
    async function init() {
      console.log('Initializing User Management...');
      updateNavLinks();
      attachEventListeners();
      await loadAllUsers();
      startAutoRefresh();
    }
    
    function attachEventListeners() {
      // Refresh button
      elements.refreshBtn.addEventListener('click', () => {
        elements.refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
        loadAllUsers().finally(() => {
          elements.refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Users';
        });
      });
      
      // Export button
      elements.exportUsersBtn.addEventListener('click', exportUsersToCSV);
      
      // Create User form
      elements.createUserBtn.addEventListener('click', () => {
        elements.createUserForm.classList.add('active');
        elements.createUserBtn.style.display = 'none';
      });
      
      elements.closeCreateFormBtn.addEventListener('click', () => {
        elements.createUserForm.classList.remove('active');
        elements.createUserBtn.style.display = 'flex';
        resetCreateUserForm();
      });
      
      elements.resetFormBtn.addEventListener('click', resetCreateUserForm);
      elements.submitCreateUserBtn.addEventListener('click', createNewUser);
      
      // Filter changes
      elements.searchInput.addEventListener('input', debounce(applyFilters, 300));
      elements.statusFilter.addEventListener('change', applyFilters);
      elements.roleFilter.addEventListener('change', applyFilters);
      elements.sortFilter.addEventListener('change', applyFilters);
      elements.clearFiltersBtn.addEventListener('click', clearFilters);
      
      // Select All checkbox
      elements.selectAllCheckbox.addEventListener('change', toggleSelectAllUsers);
      elements.bulkActionBtn.addEventListener('click', handleBulkAction);
      
      // Modals
      elements.closeUserModalBtn.addEventListener('click', () => closeModal('user'));
      elements.userModal.addEventListener('click', (e) => {
        if (e.target === elements.userModal) closeModal('user');
      });
      
      elements.closeEditUserModalBtn.addEventListener('click', () => closeModal('editUser'));
      elements.editUserModal.addEventListener('click', (e) => {
        if (e.target === elements.editUserModal) closeModal('editUser');
      });
      
      elements.closeConfirmModalBtn.addEventListener('click', () => closeModal('confirm'));
      elements.cancelConfirmBtn.addEventListener('click', () => closeModal('confirm'));
      elements.confirmActionBtn.addEventListener('click', executeModalAction);
      elements.confirmModal.addEventListener('click', (e) => {
        if (e.target === elements.confirmModal) closeModal('confirm');
      });
      
      // Pagination
      elements.prevPageBtn.addEventListener('click', () => changePage(state.currentPage - 1));
      elements.nextPageBtn.addEventListener('click', () => changePage(state.currentPage + 1));
      elements.page1Btn.addEventListener('click', () => changePage(1));
      elements.page2Btn.addEventListener('click', () => changePage(2));
      elements.page3Btn.addEventListener('click', () => changePage(3));
      
      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeModal('user');
          closeModal('editUser');
          closeModal('confirm');
        }
        if (e.key === 'r' && (e.ctrlKey || e.metaKey)) {
          e.preventDefault();
          loadAllUsers();
        }
        if (e.key === 'n' && (e.ctrlKey || e.metaKey)) {
          e.preventDefault();
          if (!elements.createUserForm.classList.contains('active')) {
            elements.createUserForm.classList.add('active');
            elements.createUserBtn.style.display = 'none';
          }
        }
        if (e.key === 'l' && (e.ctrlKey || e.metaKey) && e.shiftKey) {
          e.preventDefault();
          logoutAdmin();
        }
      });
    }
    
    async function loadAllUsers() {
      if (state.isLoading) return;
      
      state.isLoading = true;
      showLoading(true);
      
      try {
        console.log('Fetching all users from Supabase...');
        
        // Fetch users from Supabase
        const { data: users, error } = await supabase
          .from('users')
          .select('*')
          .order('created_at', { ascending: false });
        
        if (error) {
          throw new Error(`Supabase error: ${error.message}`);
        }
        
        // Fetch tickets to calculate ticket counts
        await fetchTicketsData();
        
        // Process users
        processUsers(users || []);
        
        state.lastFetchTime = new Date();
        updateLastUpdated();
        
        showToast('Users loaded successfully!', 'success');
        
      } catch (error) {
        console.error('Error loading users:', error);
        showError('Failed to load users. Please check your connection and try again.');
        showToast('Failed to load users: ' + error.message, 'error');
      } finally {
        state.isLoading = false;
        showLoading(false);
      }
    }
    
    async function fetchTicketsData() {
      try {
        // Try to fetch tickets if the function exists
        if (window._admin && typeof window._admin.fetchAllTickets === 'function') {
          const result = await window._admin.fetchAllTickets();
          if (result && result.success) {
            state.ticketsData = result.tickets || [];
          }
        } else if (window._admin && typeof window._admin.fetchRecentTickets === 'function') {
          // Fallback to fetchRecentTickets
          const result = await window._admin.fetchRecentTickets(1000);
          if (result && result.success) {
            state.ticketsData = result.tickets || [];
          }
        }
      } catch (error) {
        console.warn('Could not fetch tickets data:', error);
        state.ticketsData = [];
      }
    }
    
    function processUsers(users) {
      // Store all users
      state.allUsers = users.map(user => ({
        id: user.id || 'N/A',
        email: user.email || 'No email',
        name: user.name || 'Anonymous',
        role: user.role || 'user',
        status: user.status || 'active',
        createdAt: user.created_at || Date.now(),
        lastLogin: user.last_login || null,
        telegramId: user.telegram_id || null,
        phone: user.phone || null,
        ticketCount: calculateUserTicketCount(user.id, user.telegram_id)
      }));
      
      // Update stats
      updateStats();
      
      // Apply initial filters
      applyFilters();
      
      console.log(`Loaded ${state.allUsers.length} users from Supabase`);
    }
    
    function calculateUserTicketCount(userId, telegramId) {
      if (!state.ticketsData || state.ticketsData.length === 0) return 0;
      
      return state.ticketsData.filter(ticket => {
        return ticket.userId === userId || 
               ticket.telegramId === telegramId ||
               (ticket.email && ticket.email === userId); // If tickets have email field
      }).length;
    }
    
    function applyFilters() {
      const searchTerm = elements.searchInput.value.toLowerCase();
      const statusFilter = elements.statusFilter.value;
      const roleFilter = elements.roleFilter.value;
      const sortFilter = elements.sortFilter.value;
      
      // Filter users
      let filteredUsers = state.allUsers.filter(user => {
        // Search filter
        if (searchTerm) {
          const searchable = `${user.id} ${user.name} ${user.email} ${user.phone || ''}`.toLowerCase();
          if (!searchable.includes(searchTerm)) return false;
        }
        
        // Status filter
        if (statusFilter !== 'all' && user.status !== statusFilter) return false;
        
        // Role filter
        if (roleFilter !== 'all' && user.role !== roleFilter) return false;
        
        return true;
      });
      
      // Sort users
      switch (sortFilter) {
        case 'newest':
          filteredUsers.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
          break;
        case 'oldest':
          filteredUsers.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
          break;
        case 'name_asc':
          filteredUsers.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
          break;
        case 'name_desc':
          filteredUsers.sort((a, b) => (b.name || '').localeCompare(a.name || ''));
          break;
        case 'email_asc':
          filteredUsers.sort((a, b) => (a.email || '').localeCompare(b.email || ''));
          break;
        case 'last_login':
          filteredUsers.sort((a, b) => {
            const dateA = a.lastLogin ? new Date(a.lastLogin) : new Date(0);
            const dateB = b.lastLogin ? new Date(b.lastLogin) : new Date(0);
            return dateB - dateA;
          });
          break;
      }
      
      state.filteredUsers = filteredUsers;
      
      // Update table info
      elements.tableInfo.textContent = `Showing ${state.filteredUsers.length} of ${state.allUsers.length} users`;
      
      // Update pagination
      updatePagination();
      
      // Render current page
      renderCurrentPage();
      
      // Update bulk action button
      updateBulkActionButton();
    }
    
    function clearFilters() {
      elements.searchInput.value = '';
      elements.statusFilter.value = 'all';
      elements.roleFilter.value = 'all';
      elements.sortFilter.value = 'newest';
      applyFilters();
    }
    
    function updateStats() {
      const now = new Date();
      const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
      
      const stats = {
        total: state.allUsers.length,
        active: state.allUsers.filter(u => u.status === 'active').length,
        admins: state.allUsers.filter(u => u.role === 'admin').length,
        newThisWeek: state.allUsers.filter(u => {
          const userDate = new Date(u.createdAt);
          return userDate >= oneWeekAgo;
        }).length
      };
      
      elements.statTotalUsers.textContent = stats.total;
      elements.statActiveUsers.textContent = stats.active;
      elements.statAdminUsers.textContent = stats.admins;
      elements.statNewUsersWeek.textContent = stats.newThisWeek;
    }
    
    function updatePagination() {
      state.totalPages = Math.ceil(state.filteredUsers.length / state.usersPerPage);
      state.currentPage = Math.min(state.currentPage, state.totalPages || 1);
      
      // Show/hide pagination
      if (state.totalPages > 1) {
        elements.paginationControls.style.display = 'flex';
      } else {
        elements.paginationControls.style.display = 'none';
      }
      
      // Update page info
      const start = (state.currentPage - 1) * state.usersPerPage + 1;
      const end = Math.min(state.currentPage * state.usersPerPage, state.filteredUsers.length);
      elements.pageInfo.textContent = `Page ${state.currentPage} of ${state.totalPages} • Users ${start}-${end} of ${state.filteredUsers.length}`;
      
      // Update pagination buttons
      elements.prevPageBtn.disabled = state.currentPage === 1;
      elements.nextPageBtn.disabled = state.currentPage === state.totalPages;
      
      // Update page number buttons
      const pageButtons = [elements.page1Btn, elements.page2Btn, elements.page3Btn];
      pageButtons.forEach((btn, index) => {
        const pageNum = index + 1;
        if (pageNum <= state.totalPages) {
          btn.style.display = 'flex';
          btn.textContent = pageNum;
          btn.dataset.page = pageNum;
          btn.classList.toggle('active', pageNum === state.currentPage);
        } else {
          btn.style.display = 'none';
        }
      });
    }
    
    function changePage(page) {
      if (page < 1 || page > state.totalPages) return;
      
      state.currentPage = page;
      updatePagination();
      renderCurrentPage();
      
      // Scroll to top of table
      document.querySelector('#usersTable').scrollIntoView({ behavior: 'smooth' });
    }
    
    function renderCurrentPage() {
      const start = (state.currentPage - 1) * state.usersPerPage;
      const end = start + state.usersPerPage;
      const pageUsers = state.filteredUsers.slice(start, end);
      
      // Show/hide empty state
      if (pageUsers.length === 0) {
        elements.emptyState.style.display = 'block';
        elements.usersTableBody.innerHTML = '';
      } else {
        elements.emptyState.style.display = 'none';
        elements.usersTableBody.innerHTML = pageUsers.map(renderUserRow).join('');
        
        // Attach event listeners
        attachUserRowEventListeners();
      }
    }
    
    function renderUserRow(user) {
      const formattedDate = formatDate(user.createdAt);
      const userName = user.name || 'Anonymous';
      const userInitials = getUserInitials(userName);
      
      const statusText = user.status === 'active' ? 'Active' : 
                        user.status === 'inactive' ? 'Inactive' : 
                        user.status === 'banned' ? 'Banned' : 'Unknown';
      
      const roleText = user.role === 'admin' ? 'Admin' : 'User';
      const isSelected = state.selectedUsers.has(user.id);
      
      return `
        <tr data-user-id="${escapeHtml(user.id)}">
          <td>
            <input type="checkbox" class="user-checkbox" data-user-id="${escapeHtml(user.id)}" ${isSelected ? 'checked' : ''}>
          </td>
          <td>
            <div class="user-info-cell">
              <div class="user-avatar">${escapeHtml(userInitials)}</div>
              <div class="user-info">
                <h4>${escapeHtml(userName)}</h4>
                <p>ID: ${escapeHtml(user.id.substring(0, 8))}...</p>
              </div>
            </div>
          </td>
          <td>${escapeHtml(user.email)}</td>
          <td><span class="badge badge-${user.role}">${roleText}</span></td>
          <td><strong>${user.ticketCount}</strong> tickets</td>
          <td>${escapeHtml(formattedDate)}</td>
          <td><span class="badge badge-${user.status}">${statusText}</span></td>
          <td>
            <div class="user-actions">
              <button class="action-btn view-user-btn" data-user-id="${escapeHtml(user.id)}" title="View Details">
                <i class="fas fa-eye"></i>
              </button>
              <button class="action-btn edit-user-btn" data-user-id="${escapeHtml(user.id)}" title="Edit User">
                <i class="fas fa-edit"></i>
              </button>
              <button class="action-btn ${user.status === 'active' ? 'action-btn-warning' : 'action-btn-success'} toggle-user-btn" data-user-id="${escapeHtml(user.id)}" data-user-name="${escapeHtml(userName)}" data-current-status="${escapeHtml(user.status)}" title="${user.status === 'active' ? 'Deactivate' : 'Activate'}">
                <i class="fas ${user.status === 'active' ? 'fa-user-slash' : 'fa-user-check'}"></i>
              </button>
              <button class="action-btn action-btn-danger delete-user-btn" data-user-id="${escapeHtml(user.id)}" data-user-name="${escapeHtml(userName)}" title="Delete User">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>
      `;
    }
    
    function attachUserRowEventListeners() {
      // User checkbox selection
      document.querySelectorAll('.user-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', (e) => {
          const userId = e.target.dataset.userId;
          if (e.target.checked) {
            state.selectedUsers.add(userId);
          } else {
            state.selectedUsers.delete(userId);
          }
          updateBulkActionButton();
          updateSelectAllCheckbox();
        });
      });
      
      // View user details
      document.querySelectorAll('.view-user-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const userId = e.currentTarget.dataset.userId;
          viewUserDetails(userId);
        });
      });
      
      // Edit user
      document.querySelectorAll('.edit-user-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const userId = e.currentTarget.dataset.userId;
          editUser(userId);
        });
      });
      
      // Toggle user status
      document.querySelectorAll('.toggle-user-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const userId = e.currentTarget.dataset.userId;
          const userName = e.currentTarget.dataset.userName;
          const currentStatus = e.currentTarget.dataset.currentStatus;
          const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
          showToggleStatusConfirmation(userId, userName, newStatus);
        });
      });
      
      // Delete user
      document.querySelectorAll('.delete-user-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const userId = e.currentTarget.dataset.userId;
          const userName = e.currentTarget.dataset.userName;
          showDeleteUserConfirmation(userId, userName);
        });
      });
    }
    
    function toggleSelectAllUsers() {
      const isChecked = elements.selectAllCheckbox.checked;
      const pageUsers = getCurrentPageUsers();
      
      if (isChecked) {
        // Select all users on current page
        pageUsers.forEach(user => {
          state.selectedUsers.add(user.id);
        });
      } else {
        // Deselect all users on current page
        pageUsers.forEach(user => {
          state.selectedUsers.delete(user.id);
        });
      }
      
      // Update checkboxes
      document.querySelectorAll('.user-checkbox').forEach(checkbox => {
        checkbox.checked = isChecked;
      });
      
      updateBulkActionButton();
    }
    
    function updateSelectAllCheckbox() {
      const pageUsers = getCurrentPageUsers();
      const selectedCount = pageUsers.filter(user => state.selectedUsers.has(user.id)).length;
      
      if (selectedCount === 0) {
        elements.selectAllCheckbox.checked = false;
        elements.selectAllCheckbox.indeterminate = false;
      } else if (selectedCount === pageUsers.length) {
        elements.selectAllCheckbox.checked = true;
        elements.selectAllCheckbox.indeterminate = false;
      } else {
        elements.selectAllCheckbox.checked = false;
        elements.selectAllCheckbox.indeterminate = true;
      }
    }
    
    function getCurrentPageUsers() {
      const start = (state.currentPage - 1) * state.usersPerPage;
      const end = start + state.usersPerPage;
      return state.filteredUsers.slice(start, end);
    }
    
    function updateBulkActionButton() {
      if (state.selectedUsers.size > 0) {
        elements.bulkActionBtn.style.display = 'flex';
        
        // Check if all selected users are inactive
        const selectedUsersData = state.allUsers.filter(user => state.selectedUsers.has(user.id));
        const allInactive = selectedUsersData.every(user => user.status === 'inactive');
        const allActive = selectedUsersData.every(user => user.status === 'active');
        
        if (allInactive) {
          elements.bulkActionBtn.innerHTML = '<i class="fas fa-check"></i> Activate Selected';
          elements.bulkActionBtn.dataset.action = 'activate';
        } else if (allActive) {
          elements.bulkActionBtn.innerHTML = '<i class="fas fa-user-slash"></i> Deactivate Selected';
          elements.bulkActionBtn.dataset.action = 'deactivate';
        } else {
          elements.bulkActionBtn.innerHTML = '<i class="fas fa-check"></i> Activate Selected';
          elements.bulkActionBtn.dataset.action = 'activate';
        }
      } else {
        elements.bulkActionBtn.style.display = 'none';
      }
    }
    
    function handleBulkAction() {
      const action = elements.bulkActionBtn.dataset.action;
      const selectedCount = state.selectedUsers.size;
      
      if (selectedCount === 0) return;
      
      const selectedUsersData = state.allUsers.filter(user => state.selectedUsers.has(user.id));
      const userNames = selectedUsersData.map(u => u.name || 'Anonymous').join(', ');
      const newStatus = action === 'activate' ? 'active' : 'inactive';
      
      state.currentModalAction = 'bulkStatusUpdate';
      state.currentModalData = {
        userIds: Array.from(state.selectedUsers),
        userNames: userNames,
        newStatus: newStatus,
        action: action
      };
      
      elements.confirmModalTitle.textContent = `${action === 'activate' ? 'Activate' : 'Deactivate'} Users`;
      elements.confirmModalBody.innerHTML = `
        <p>Are you sure you want to ${action} <strong>${selectedCount}</strong> user(s)?</p>
        <p style="margin-top: 10px; font-size: 14px; color: var(--muted);">
          Users: ${escapeHtml(userNames.substring(0, 100))}${userNames.length > 100 ? '...' : ''}
        </p>
        <p style="color: ${action === 'activate' ? 'var(--success)' : 'var(--warning)'}; font-size: 14px; margin-top: 10px;">
          <i class="fas fa-exclamation-circle"></i> This action will ${action === 'activate' ? 'allow' : 'prevent'} these users from accessing the system.
        </p>
      `;
      
      showModal('confirm');
    }
    
    // ==================== USER DETAILS MODAL ====================
    
    function viewUserDetails(userId) {
      const user = state.allUsers.find(u => u.id === userId);
      if (!user) {
        showToast('User not found!', 'error');
        return;
      }
      
      const formattedDate = formatDate(user.createdAt);
      const lastLoginDate = user.lastLogin ? formatDate(user.lastLogin) : 'Never';
      
      const statusText = user.status === 'active' ? 'Active' : 
                        user.status === 'inactive' ? 'Inactive' : 
                        user.status === 'banned' ? 'Banned' : 'Unknown';
      
      const roleText = user.role === 'admin' ? 'Admin' : 'User';
      
      const userName = user.name || 'Anonymous';
      const userInitials = getUserInitials(userName);
      
      // Get user's tickets
      const userTickets = state.ticketsData.filter(ticket => 
        ticket.userId === user.id || ticket.telegramId === user.telegramId
      );
      
      const openTickets = userTickets.filter(t => t.status === 'open').length;
      const inProgressTickets = userTickets.filter(t => t.status === 'in_progress').length;
      const resolvedTickets = userTickets.filter(t => t.status === 'resolved').length;
      
      elements.userModalTitle.textContent = `User: ${escapeHtml(userName)}`;
      elements.userModalBody.innerHTML = `
        <div style="text-align: center; margin-bottom: 30px;">
          <div class="user-avatar-large">${escapeHtml(userInitials)}</div>
          <h3 style="color: var(--primary); margin-bottom: 8px;">${escapeHtml(userName)}</h3>
          <p style="color: var(--muted);">${escapeHtml(user.email)}</p>
        </div>
        
        <div class="user-details-grid">
          <div class="detail-group">
            <label>User ID</label>
            <div class="value" style="font-family: monospace; font-size: 14px;">${escapeHtml(user.id)}</div>
          </div>
          <div class="detail-group">
            <label>Role</label>
            <div class="value"><span class="badge badge-${user.role}">${roleText}</span></div>
          </div>
          <div class="detail-group">
            <label>Status</label>
            <div class="value"><span class="badge badge-${user.status}">${statusText}</span></div>
          </div>
          <div class="detail-group">
            <label>Joined Date</label>
            <div class="value">${escapeHtml(formattedDate)}</div>
          </div>
          <div class="detail-group">
            <label>Last Login</label>
            <div class="value">${escapeHtml(lastLoginDate)}</div>
          </div>
          <div class="detail-group">
            <label>Telegram ID</label>
            <div class="value">${escapeHtml(user.telegramId || 'Not linked')}</div>
          </div>
          <div class="detail-group">
            <label>Phone</label>
            <div class="value">${escapeHtml(user.phone || 'Not provided')}</div>
          </div>
          <div class="detail-group">
            <label>Total Tickets</label>
            <div class="value"><strong>${user.ticketCount}</strong></div>
          </div>
        </div>
        
        <div class="detail-group" style="grid-column: 1 / -1; margin-top: 20px;">
          <label>Ticket Statistics</label>
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 10px;">
            <div style="text-align: center; padding: 15px; background: #ffedd5; border-radius: 10px;">
              <div style="font-size: 24px; font-weight: bold; color: #c2410c;">${openTickets}</div>
              <div style="font-size: 12px; color: #c2410c;">Open</div>
            </div>
            <div style="text-align: center; padding: 15px; background: #dbeafe; border-radius: 10px;">
              <div style="font-size: 24px; font-weight: bold; color: #1d4ed8;">${inProgressTickets}</div>
              <div style="font-size: 12px; color: #1d4ed8;">In Progress</div>
            </div>
            <div style="text-align: center; padding: 15px; background: #d1fae5; border-radius: 10px;">
              <div style="font-size: 24px; font-weight: bold; color: #065f46;">${resolvedTickets}</div>
              <div style="font-size: 12px; color: #065f46;">Resolved</div>
            </div>
          </div>
        </div>
        
        <div style="display: flex; gap: 12px; margin-top: 30px; flex-wrap: wrap;">
          <button class="btn ${user.status === 'active' ? 'btn-warning' : 'btn-success'}" onclick="toggleUserStatus('${escapeHtml(user.id)}', '${escapeHtml(userName)}', '${user.status === 'active' ? 'inactive' : 'active'}')">
            <i class="fas ${user.status === 'active' ? 'fa-user-slash' : 'fa-user-check'}"></i>
            ${user.status === 'active' ? 'Deactivate User' : 'Activate User'}
          </button>
          <button class="btn btn-info" onclick="promoteToAdmin('${escapeHtml(user.id)}', '${escapeHtml(userName)}')" ${user.role === 'admin' ? 'disabled' : ''}>
            <i class="fas fa-user-shield"></i>
            Promote to Admin
          </button>
          <button class="btn btn-danger" onclick="showDeleteUserConfirmation('${escapeHtml(user.id)}', '${escapeHtml(userName)}')">
            <i class="fas fa-trash"></i>
            Delete User
          </button>
        </div>
      `;
      
      showModal('user');
    }
    
    // ==================== EDIT USER MODAL ====================
    
    function editUser(userId) {
      const user = state.allUsers.find(u => u.id === userId);
      if (!user) {
        showToast('User not found!', 'error');
        return;
      }
      
      elements.editUserModalTitle.textContent = `Edit User: ${escapeHtml(user.name || 'Anonymous')}`;
      elements.editUserModalBody.innerHTML = `
        <div class="filters-grid">
          <div class="filter-group">
            <label for="editUserName"><i class="fas fa-user"></i> Full Name</label>
            <input type="text" id="editUserName" class="form-control" value="${escapeHtml(user.name || '')}" placeholder="Enter full name">
          </div>
          
          <div class="filter-group">
            <label for="editUserEmail"><i class="fas fa-envelope"></i> Email Address</label>
            <input type="email" id="editUserEmail" class="form-control" value="${escapeHtml(user.email || '')}" placeholder="Enter email address">
          </div>
          
          <div class="filter-group">
            <label for="editUserPhone"><i class="fas fa-phone"></i> Phone Number</label>
            <input type="tel" id="editUserPhone" class="form-control" value="${escapeHtml(user.phone || '')}" placeholder="Enter phone number">
          </div>
          
          <div class="filter-group">
            <label for="editUserTelegramId"><i class="fab fa-telegram"></i> Telegram ID</label>
            <input type="text" id="editUserTelegramId" class="form-control" value="${escapeHtml(user.telegramId || '')}" placeholder="Enter Telegram ID">
          </div>
          
          <div class="filter-group">
            <label for="editUserRole"><i class="fas fa-user-shield"></i> Role</label>
            <select id="editUserRole" class="form-control">
              <option value="user" ${user.role === 'user' ? 'selected' : ''}>User</option>
              <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label for="editUserStatus"><i class="fas fa-user-tag"></i> Status</label>
            <select id="editUserStatus" class="form-control">
              <option value="active" ${user.status === 'active' ? 'selected' : ''}>Active</option>
              <option value="inactive" ${user.status === 'inactive' ? 'selected' : ''}>Inactive</option>
              <option value="banned" ${user.status === 'banned' ? 'selected' : ''}>Banned</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label for="editUserPassword"><i class="fas fa-lock"></i> New Password (Leave blank to keep current)</label>
            <input type="password" id="editUserPassword" class="form-control" placeholder="Enter new password">
          </div>
          
          <div class="filter-group">
            <label for="editUserConfirmPassword"><i class="fas fa-lock"></i> Confirm New Password</label>
            <input type="password" id="editUserConfirmPassword" class="form-control" placeholder="Confirm new password">
          </div>
        </div>
        
        <div style="display: flex; gap: 12px; margin-top: 30px;">
          <button class="btn btn-secondary" onclick="closeModal('editUser')">
            <i class="fas fa-times"></i> Cancel
          </button>
          <button class="btn btn-primary" onclick="saveUserChanges('${escapeHtml(user.id)}')">
            <i class="fas fa-save"></i> Save Changes
          </button>
        </div>
      `;
      
      showModal('editUser');
    }
    
    async function saveUserChanges(userId) {
      const user = state.allUsers.find(u => u.id === userId);
      if (!user) return;
      
      const name = document.getElementById('editUserName').value.trim();
      const email = document.getElementById('editUserEmail').value.trim();
      const phone = document.getElementById('editUserPhone').value.trim();
      const telegramId = document.getElementById('editUserTelegramId').value.trim();
      const role = document.getElementById('editUserRole').value;
      const status = document.getElementById('editUserStatus').value;
      const password = document.getElementById('editUserPassword').value;
      const confirmPassword = document.getElementById('editUserConfirmPassword').value;
      
      // Basic validation
      if (!name) {
        showToast('Name is required!', 'error');
        return;
      }
      
      if (!email) {
        showToast('Email is required!', 'error');
        return;
      }
      
      if (password && password !== confirmPassword) {
        showToast('Passwords do not match!', 'error');
        return;
      }
      
      try {
        // Prepare update data
        const updateData = {
          name: name,
          email: email,
          phone: phone || null,
          telegram_id: telegramId || null,
          role: role,
          status: status,
          updated_at: new Date().toISOString()
        };
        
        // If password is provided, we need to update it through Supabase Auth
        if (password) {
          // Note: This requires proper authentication. You might need to handle this differently
          // For now, we'll just update the user record without changing password
          showToast('Password update requires admin authentication.', 'warning');
        }
        
        // Update user in Supabase
        const { data, error } = await supabase
          .from('users')
          .update(updateData)
          .eq('id', userId);
        
        if (error) {
          throw new Error(`Supabase error: ${error.message}`);
        }
        
        // Update local state
        const userIndex = state.allUsers.findIndex(u => u.id === userId);
        if (userIndex !== -1) {
          state.allUsers[userIndex] = { ...state.allUsers[userIndex], ...updateData };
        }
        
        // Update UI
        updateStats();
        applyFilters();
        
        // Close modal
        closeModal('editUser');
        
        // Show success message
        showToast('User updated successfully!', 'success');
        
        console.log(`Updated user: ${name} (${userId})`);
        
      } catch (error) {
        console.error('Error updating user:', error);
        showToast('Failed to update user: ' + error.message, 'error');
      }
    }
    
    // ==================== CREATE USER ====================
    
    function resetCreateUserForm() {
      elements.newUserName.value = '';
      elements.newUserEmail.value = '';
      elements.newUserPhone.value = '';
      elements.newUserRole.value = 'user';
      elements.newUserStatus.value = 'active';
      elements.newUserPassword.value = '';
      elements.newUserConfirmPassword.value = '';
    }
    
    async function createNewUser() {
      const name = elements.newUserName.value.trim();
      const email = elements.newUserEmail.value.trim();
      const phone = elements.newUserPhone.value.trim();
      const role = elements.newUserRole.value;
      const status = elements.newUserStatus.value;
      const password = elements.newUserPassword.value;
      const confirmPassword = elements.newUserConfirmPassword.value;
      
      // Validation
      if (!name) {
        showToast('Name is required!', 'error');
        elements.newUserName.focus();
        return;
      }
      
      if (!email) {
        showToast('Email is required!', 'error');
        elements.newUserEmail.focus();
        return;
      }
      
      if (!password) {
        showToast('Password is required!', 'error');
        elements.newUserPassword.focus();
        return;
      }
      
      if (password !== confirmPassword) {
        showToast('Passwords do not match!', 'error');
        elements.newUserConfirmPassword.focus();
        return;
      }
      
      try {
        // Note: Creating a user with password requires proper Supabase Auth setup
        // This is a simplified version. In production, you should use proper auth flows
        
        // Check if user already exists
        const { data: existingUser } = await supabase
          .from('users')
          .select('id')
          .eq('email', email)
          .single();
        
        if (existingUser) {
          showToast('User with this email already exists!', 'error');
          return;
        }
        
        // Create user in Supabase (using your existing user table structure)
        const newUser = {
          email: email,
          name: name,
          phone: phone || null,
          role: role,
          status: status,
          created_at: new Date().toISOString(),
          updated_at: new Date().toISOString()
        };
        
        const { data, error } = await supabase
          .from('users')
          .insert([newUser])
          .select()
          .single();
        
        if (error) {
          throw new Error(`Supabase error: ${error.message}`);
        }
        
        // Add to local state
        const userWithId = {
          ...newUser,
          id: data.id,
          ticketCount: 0,
          lastLogin: null,
          telegramId: null
        };
        
        state.allUsers.unshift(userWithId);
        
        // Update UI
        updateStats();
        applyFilters();
        
        // Reset form and hide it
        resetCreateUserForm();
        elements.createUserForm.classList.remove('active');
        elements.createUserBtn.style.display = 'flex';
        
        // Show success message
        showToast(`User "${name}" created successfully!`, 'success');
        
        console.log(`Created new user: ${name} (${data.id})`);
        
      } catch (error) {
        console.error('Error creating user:', error);
        showToast('Failed to create user: ' + error.message, 'error');
      }
    }
    
    // ==================== USER ACTIONS ====================
    
    function showDeleteUserConfirmation(userId, userName) {
      state.currentModalAction = 'deleteUser';
      state.currentModalData = { userId, userName };
      
      elements.confirmModalTitle.textContent = 'Delete User';
      elements.confirmModalBody.innerHTML = `
        <p>Are you sure you want to delete the user <strong>${escapeHtml(userName)}</strong>?</p>
        <p style="color: var(--danger); font-size: 14px; margin-top: 10px;">
          <i class="fas fa-exclamation-triangle"></i> This action cannot be undone. All user data including tickets will be permanently deleted.
        </p>
        <p style="font-size: 13px; color: var(--muted); margin-top: 10px;">
          <strong>Note:</strong> This only deletes the user record. The user's authentication account may still exist.
        </p>
      `;
      
      showModal('confirm');
    }
    
    function showToggleStatusConfirmation(userId, userName, newStatus) {
      state.currentModalAction = 'toggleUserStatus';
      state.currentModalData = { userId, userName, newStatus };
      
      const action = newStatus === 'active' ? 'activate' : 'deactivate';
      elements.confirmModalTitle.textContent = `${action === 'activate' ? 'Activate' : 'Deactivate'} User`;
      elements.confirmModalBody.innerHTML = `
        <p>Are you sure you want to ${action} the user <strong>${escapeHtml(userName)}</strong>?</p>
        <p style="color: ${action === 'activate' ? 'var(--success)' : 'var(--warning)'}; font-size: 14px; margin-top: 10px;">
          <i class="fas fa-exclamation-circle"></i> This action will ${action === 'activate' ? 'allow' : 'prevent'} this user from accessing the system.
        </p>
      `;
      
      showModal('confirm');
    }
    
    async function executeModalAction() {
      if (!state.currentModalAction || !state.currentModalData) return;
      
      const { userId, userName, newStatus, userIds, action } = state.currentModalData;
      
      switch (state.currentModalAction) {
        case 'deleteUser':
          await deleteUser(userId, userName);
          break;
        case 'toggleUserStatus':
          await toggleUserStatus(userId, userName, newStatus);
          break;
        case 'bulkStatusUpdate':
          await bulkUpdateUserStatus(userIds, newStatus, action);
          break;
      }
      
      closeModal('confirm');
    }
    
    async function deleteUser(userId, userName) {
      try {
        // Delete user from Supabase
        const { error } = await supabase
          .from('users')
          .delete()
          .eq('id', userId);
        
        if (error) {
          throw new Error(`Supabase error: ${error.message}`);
        }
        
        // Remove from selected users
        state.selectedUsers.delete(userId);
        
        // Remove from local state
        state.allUsers = state.allUsers.filter(u => u.id !== userId);
        
        // Update UI
        updateStats();
        applyFilters();
        updateBulkActionButton();
        updateSelectAllCheckbox();
        
        // Show success message
        showToast(`User "${userName}" has been deleted successfully.`, 'success');
        
        console.log(`Deleted user: ${userName} (${userId})`);
        
      } catch (error) {
        console.error('Error deleting user:', error);
        showToast(`Failed to delete user: ${error.message}`, 'error');
      }
    }
    
    async function toggleUserStatus(userId, userName, newStatus) {
      try {
        // Update user in Supabase
        const { error } = await supabase
          .from('users')
          .update({ 
            status: newStatus,
            updated_at: new Date().toISOString()
          })
          .eq('id', userId);
        
        if (error) {
          throw new Error(`Supabase error: ${error.message}`);
        }
        
        // Update local state
        const userIndex = state.allUsers.findIndex(u => u.id === userId);
        if (userIndex !== -1) {
          state.allUsers[userIndex].status = newStatus;
        }
        
        // Update UI
        updateStats();
        applyFilters();
        
        // Close user modal if open
        closeModal('user');
        
        // Show success message
        const action = newStatus === 'active' ? 'activated' : 'deactivated';
        showToast(`User "${userName}" has been ${action} successfully.`, 'success');
        
        console.log(`Updated user status: ${userName} -> ${newStatus}`);
        
      } catch (error) {
        console.error('Error updating user status:', error);
        showToast(`Failed to update user status: ${error.message}`, 'error');
      }
    }
    
    async function bulkUpdateUserStatus(userIds, newStatus, action) {
      try {
        // Update users in Supabase
        const { error } = await supabase
          .from('users')
          .update({ 
            status: newStatus,
            updated_at: new Date().toISOString()
          })
          .in('id', userIds);
        
        if (error) {
          throw new Error(`Supabase error: ${error.message}`);
        }
        
        // Update local state
        state.allUsers.forEach(user => {
          if (userIds.includes(user.id)) {
            user.status = newStatus;
          }
        });
        
        // Clear selection
        state.selectedUsers.clear();
        
        // Update UI
        updateStats();
        applyFilters();
        updateBulkActionButton();
        updateSelectAllCheckbox();
        
        // Show success message
        const actionText = action === 'activate' ? 'activated' : 'deactivated';
        showToast(`${userIds.length} user(s) ${actionText} successfully.`, 'success');
        
        console.log(`Bulk updated ${userIds.length} users to ${newStatus}`);
        
      } catch (error) {
        console.error('Error bulk updating user status:', error);
        showToast(`Failed to update users: ${error.message}`, 'error');
      }
    }
    
    async function promoteToAdmin(userId, userName) {
      try {
        // Update user role in Supabase
        const { error } = await supabase
          .from('users')
          .update({ 
            role: 'admin',
            updated_at: new Date().toISOString()
          })
          .eq('id', userId);
        
        if (error) {
          throw new Error(`Supabase error: ${error.message}`);
        }
        
        // Update local state
        const userIndex = state.allUsers.findIndex(u => u.id === userId);
        if (userIndex !== -1) {
          state.allUsers[userIndex].role = 'admin';
        }
        
        // Update UI
        updateStats();
        applyFilters();
        
        // Close user modal if open
        closeModal('user');
        
        // Show success message
        showToast(`User "${userName}" has been promoted to admin successfully.`, 'success');
        
        console.log(`Promoted user to admin: ${userName}`);
        
      } catch (error) {
        console.error('Error promoting user:', error);
        showToast(`Failed to promote user: ${error.message}`, 'error');
      }
    }
    
    // ==================== UTILITY FUNCTIONS ====================
    
    function exportUsersToCSV() {
      if (state.filteredUsers.length === 0) {
        showToast('No users to export', 'warning');
        return;
      }
      
      // Create CSV content
      const headers = ['ID', 'Name', 'Email', 'Role', 'Status', 'Tickets', 'Joined', 'Last Login', 'Phone', 'Telegram ID'];
      const csvRows = [];
      
      // Add headers
      csvRows.push(headers.join(','));
      
      // Add data rows
      state.filteredUsers.forEach(user => {
        const row = [
          `"${user.id}"`,
          `"${user.name}"`,
          `"${user.email}"`,
          `"${user.role}"`,
          `"${user.status}"`,
          `"${user.ticketCount}"`,
          `"${new Date(user.createdAt).toISOString()}"`,
          `"${user.lastLogin ? new Date(user.lastLogin).toISOString() : ''}"`,
          `"${user.phone || ''}"`,
          `"${user.telegramId || ''}"`
        ];
        csvRows.push(row.join(','));
      });
      
      const csvContent = csvRows.join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.setAttribute('href', url);
      link.setAttribute('download', `tomoca_users_${new Date().toISOString().split('T')[0]}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showToast(`Exported ${state.filteredUsers.length} users to CSV`, 'success');
    }
    
    function updateLastUpdated() {
      if (!state.lastFetchTime) return;
      
      const now = new Date();
      const diffMs = now - state.lastFetchTime;
      const diffSec = Math.floor(diffMs / 1000);
      const diffMin = Math.floor(diffSec / 60);
      
      let text = 'Last updated: ';
      if (diffSec < 60) {
        text += `${diffSec} second${diffSec !== 1 ? 's' : ''} ago`;
      } else if (diffMin < 60) {
        text += `${diffMin} minute${diffMin !== 1 ? 's' : ''} ago`;
      } else {
        text += state.lastFetchTime.toLocaleTimeString();
      }
      
      elements.lastUpdated.textContent = text;
    }
    
    function startAutoRefresh() {
      // Auto-refresh every 5 minutes
      setInterval(() => {
        if (!state.isLoading && document.visibilityState === 'visible') {
          loadAllUsers();
        }
      }, 300000);
      
      // Update "last updated" every minute
      setInterval(updateLastUpdated, 60000);
    }
    
    function showLoading(show) {
      elements.loadingIndicator.style.display = show ? 'block' : 'none';
      if (!show) {
        elements.usersTableBody.innerHTML = '';
      }
    }
    
    function showError(message) {
      elements.usersTableBody.innerHTML = `
        <tr>
          <td colspan="9" style="text-align: center; padding: 40px; color: var(--danger);">
            <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 16px;"></i>
            <h3>Error Loading Users</h3>
            <p>${escapeHtml(message)}</p>
            <button class="btn btn-primary" onclick="loadAllUsers()" style="margin-top: 16px;">
              <i class="fas fa-redo"></i> Try Again
            </button>
          </td>
        </tr>
      `;
    }
    
    function showModal(modalType) {
      if (modalType === 'user') {
        elements.userModal.style.display = 'flex';
      } else if (modalType === 'editUser') {
        elements.editUserModal.style.display = 'flex';
      } else if (modalType === 'confirm') {
        elements.confirmModal.style.display = 'flex';
      }
    }
    
    function closeModal(modalType) {
      if (modalType === 'user') {
        elements.userModal.style.display = 'none';
      } else if (modalType === 'editUser') {
        elements.editUserModal.style.display = 'none';
      } else if (modalType === 'confirm') {
        elements.confirmModal.style.display = 'none';
        state.currentModalAction = null;
        state.currentModalData = null;
      }
    }
    
    function showToast(message, type = 'info') {
      const toast = elements.toast;
      const icon = elements.toastIcon;
      const messageEl = elements.toastMessage;
      
      // Set icon and color based on type
      switch (type) {
        case 'success':
          icon.className = 'fas fa-check-circle';
          toast.className = 'toast toast-success';
          break;
        case 'error':
          icon.className = 'fas fa-exclamation-circle';
          toast.className = 'toast toast-error';
          break;
        case 'warning':
          icon.className = 'fas fa-exclamation-triangle';
          toast.className = 'toast toast-warning';
          break;
        case 'info':
          icon.className = 'fas fa-info-circle';
          toast.className = 'toast toast-info';
          break;
      }
      
      messageEl.textContent = message;
      toast.classList.add('show');
      
      // Auto hide after 5 seconds
      setTimeout(() => {
        toast.classList.remove('show');
      }, 5000);
    }
    
    // Utility functions
    function escapeHtml(str) {
      return String(str || '').replace(/[&<>"']/g, s => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
      })[s]);
    }
    
    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      
      try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return 'Invalid Date';
        
        return date.toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      } catch (error) {
        console.error('Error formatting date:', error);
        return 'Invalid Date';
      }
    }
    
    function getUserInitials(name) {
      if (!name) return '?';
      return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
    }
    
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
    
    // Make functions available globally
    window.toggleUserStatus = toggleUserStatus;
    window.promoteToAdmin = promoteToAdmin;
    window.showDeleteUserConfirmation = showDeleteUserConfirmation;
    window.loadAllUsers = loadAllUsers;
    window.logoutAdmin = logoutAdmin;
    
  })();
</script>
</body>
</html>
[file content end]