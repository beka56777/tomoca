<!-- frontend/ticket.html -->
<!doctype html>
<html>
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ticket — Tomoca Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<style>
  body{font-family:'Poppins',sans-serif;background:linear-gradient(135deg,#4e2b18,#d4a373);min-height:100vh;display:flex;align-items:flex-start;justify-content:center;padding:28px}
  .card{background:#fff;padding:18px;border-radius:12px;max-width:900px;width:100%;box-shadow:0 12px 30px rgba(0,0,0,0.18)}
  .controls{display:flex;gap:8px;margin-top:10px}
  textarea{min-height:100px}
</style>
</head>
<body>
  <div class="card">
    <h3>Ticket Details</h3>
    <div id="ticketBox">Loading...</div>

    <div class="controls" style="margin-top:12px">
      <select id="statusSelect" style="padding:8px;border-radius:8px;border:1px solid #eee">
        <option value="open">Open</option>
        <option value="in_progress">In Progress</option>
        <option value="resolved">Resolved</option>
      </select>
      <button id="updateStatusBtn" style="padding:8px;background:#8B4513;color:#fff;border:none;border-radius:8px">Update Status</button>
      <button id="copyId" style="padding:8px;background:#6c757d;color:#fff;border:none;border-radius:8px">Copy ID</button>
    </div>

    <div id="notesBox" style="margin-top:12px"></div>
    <div id="msg" style="margin-top:12px"></div>
  </div>

<script src="js/utils.js"></script>
<script src="js/admin.js"></script>
<script>
  (function(){
    const params = new URLSearchParams(location.search);
    const id = params.get('id');

    const ticketBox = document.getElementById('ticketBox');
    const statusSelect = document.getElementById('statusSelect');
    const updateBtn = document.getElementById('updateStatusBtn');
    const copyBtn = document.getElementById('copyId');
    const msg = document.getElementById('msg');
    const notesBox = document.getElementById('notesBox');

    async function load() {
      if (!id) { ticketBox.innerHTML = '<div class="response-message error">No ticket id specified.</div>'; return; }
      ticketBox.innerHTML = 'Loading...';
      const r = await window._admin.fetchTicketById(id);
      if (r && r.success && r.ticket) {
        const t = r.ticket;
        ticketBox.innerHTML = `
          <div style="padding:12px;border:1px solid #f0f0f0;border-radius:8px">
            <div style="font-weight:800;font-size:1.08rem">${t.name} <small style="color:#666">(${t.department})</small></div>
            <div style="margin-top:8px;color:#444">${(t.issue||'').replace(/\n/g,'<br>')}</div>
            <div style="margin-top:10px;font-size:0.9rem;color:#666">
              <span class="ticket-id">${t.id}</span> • ${window._utils.formatDate(t.createdAt||t.timestamp)} • <strong>${t.urgency}</strong>
            </div>
            ${t.attachments && t.attachments.length ? `<div style="margin-top:10px;">Attachments: ${t.attachments.map(a=>`<div><a href="${a}" target="_blank">View</a></div>`).join('')}</div>` : ''}
          </div>
        `;
        statusSelect.value = t.status || 'open';
        renderNotes(t.notes || []);
      } else {
        ticketBox.innerHTML = '<div class="response-message error">Ticket not found.</div>';
      }
    }

    function renderNotes(notes = []) {
      if (!notes.length) { notesBox.innerHTML = '<div style="color:#666">No admin notes yet.</div>'; return; }
      notesBox.innerHTML = notes.map(n => `<div style="padding:8px;border-bottom:1px solid #f3f3f3">${n.when} • ${n.by||'admin'} • ${n.text}</div>`).join('');
    }

    updateBtn.addEventListener('click', async ()=> {
      updateBtn.disabled = true;
      updateBtn.textContent = 'Updating...';
      const newStatus = statusSelect.value;
      const r = await window._admin.updateTicket(id, { status: newStatus });
      if (r && r.success) {
        msg.innerHTML = '<div class="response-message success">Status updated.</div>';
        setTimeout(()=> msg.innerHTML = '', 3000);
      } else {
        msg.innerHTML = `<div class="response-message error">${r?.message || 'Update failed'}</div>`;
      }
      updateBtn.disabled = false;
      updateBtn.textContent = 'Update Status';
    });

    copyBtn.addEventListener('click', async ()=> {
      await window._utils.copyToClipboard(id);
      copyBtn.textContent = 'Copied';
      setTimeout(()=> copyBtn.textContent='Copy ID',1200);
    });

    load();
  })();
</script>
</body>
</html>
