<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ticket History — Tomoca IT (Enhanced)</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#f6f4f2;--card:#fff;--accent:#8B4513;--muted:#6b6b6b;--danger:#d04545;--radius:12px}
    *{box-sizing:border-box}
    body{font-family:'Poppins',system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);margin:0;padding:28px;color:#222}
    .container{max-width:920px;margin:0 auto}
    .card{background:var(--card);padding:18px;border-radius:var(--radius);box-shadow:0 8px 24px rgba(0,0,0,.06)}

    h1{margin:0;font-size:20px}
    .hint{color:var(--muted);font-size:13px;margin-top:6px}

    textarea{width:100%;min-height:110px;padding:12px;border-radius:10px;border:1px solid #eaeaea;font-size:14px}

    .row{display:flex;gap:10px;align-items:center;margin-top:12px}
    .row .btn{padding:10px 12px;border-radius:10px;border:0;background:var(--accent);color:#fff;cursor:pointer}
    .row .btn.ghost{background:transparent;border:1px solid #eee;color:inherit}
    .row .small{font-size:13px;color:var(--muted)}

    .list{margin-top:14px;display:grid;grid-template-columns:1fr;gap:10px}
    .item{padding:12px;border-radius:10px;border:1px solid #f0f0f0;background:#fafafa}
    .item h3{margin:0;font-size:15px}
    .meta{color:var(--muted);font-size:13px;margin-top:6px}
    .kbd{background:#fff;padding:4px 8px;border-radius:6px;border:1px solid #eee;font-weight:700}

    .controls{display:flex;gap:8px;align-items:center}
    .progress-wrap{height:8px;background:#f2f2f2;border-radius:999px;overflow:hidden;flex:1}
    .progress-bar{height:100%;width:0;background:linear-gradient(90deg,#8B4513,#d4a373)}

    .actions{display:flex;gap:8px;margin-top:8px}
    .actions .link{background:transparent;border:0;color:var(--accent);cursor:pointer}

    pre{white-space:pre-wrap;background:#fff;padding:10px;border-radius:8px;border:1px solid #f3f3f3}

    /* modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.38);display:none;align-items:center;justify-content:center;padding:18px;z-index:60}
    .modal{background:#fff;padding:16px;border-radius:10px;max-width:820px;width:100%;max-height:85vh;overflow:auto}

    .empty{padding:14px;border-radius:10px;background:#fff;border:1px dashed #eee;color:var(--muted)}

    @media (max-width:760px){ .row{flex-direction:column;align-items:stretch} .controls{flex-direction:column} }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>Ticket Lookup (multiple)</h1>
      <div class="hint">Paste one Ticket ID per line (e.g. <span class="kbd">TOM-176</span>), or upload a text/CSV file. Results will show history, status and quick actions.</div>

      <div style="margin-top:12px">
        <textarea id="ids" placeholder="TOM-176\nTOM-42"></textarea>
      </div>

      <div class="row">
        <div style="display:flex;gap:8px;align-items:center">
          <button id="btnLookup" class="btn">Lookup tickets</button>
          <button id="btnClear" class="btn ghost">Clear</button>
          <label for="fileInput" class="btn ghost" style="cursor:pointer">Upload file</label>
          <input id="fileInput" type="file" accept=".txt,.csv" style="display:none">
        </div>

        <div style="margin-left:auto;display:flex;align-items:center;gap:8px">
          <div class="small">Progress</div>
          <div class="progress-wrap" aria-hidden="false"><div id="progressBar" class="progress-bar"></div></div>
          <div id="stats" class="small" style="min-width:140px;text-align:right">0 / 0</div>
        </div>
      </div>

      <div class="actions" style="margin-top:8px">
        <button id="btnExportJson" class="btn ghost">Export JSON</button>
        <button id="btnExportCsv" class="btn ghost">Export CSV</button>
        <button id="btnCopyAll" class="btn ghost">Copy All</button>
      </div>

      <div id="list" class="list">
        <div class="empty">No lookups yet. Paste ticket IDs above and click <strong>Lookup tickets</strong>.</div>
      </div>
    </div>
  </div>

  <!-- modal -->
  <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" id="modal">
      <div style="display:flex;justify-content:space-between;align-items:center"><h3 id="modalTitle">Ticket</h3><button id="closeModal" class="btn ghost">Close</button></div>
      <div id="modalBody" style="margin-top:10px"></div>
    </div>
  </div>

<script>
  // Keep backend route same — only frontend enhancements
  const BACKEND_BASE = 'https://tomoca.onrender.com';

  const ta = document.getElementById('ids');
  const btnLookup = document.getElementById('btnLookup');
  const btnClear = document.getElementById('btnClear');
  const list = document.getElementById('list');
  const progressBar = document.getElementById('progressBar');
  const stats = document.getElementById('stats');
  const fileInput = document.getElementById('fileInput');
  const btnExportJson = document.getElementById('btnExportJson');
  const btnExportCsv = document.getElementById('btnExportCsv');
  const btnCopyAll = document.getElementById('btnCopyAll');

  const modalBackdrop = document.getElementById('modalBackdrop');
  const modalBody = document.getElementById('modalBody');
  const modalTitle = document.getElementById('modalTitle');
  const closeModal = document.getElementById('closeModal');

  // internal state
  let results = []; // { id, status: 'ok'|'error', ticket?, error }

  function setProgress(done, total){
    const p = total === 0 ? 0 : Math.round((done/total)*100);
    progressBar.style.width = p + '%';
    stats.textContent = `${done} / ${total}`;
  }

  function renderEmpty(){ list.innerHTML = '<div class="empty">No lookups yet. Paste ticket IDs above and click <strong>Lookup tickets</strong>.</div>'; }

  function sanitizeIds(raw){
    return raw.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  }

  // concurrency-limited fetch to avoid blasting the backend
  async function fetchWithConcurrency(ids, concurrency = 4){
    const out = [];
    let i = 0;
    let done = 0;
    setProgress(0, ids.length);

    async function worker(){
      while(i < ids.length){
        const idx = i++; const id = ids[idx];
        try{
          const res = await fetch(`${BACKEND_BASE}/ticket?id=${encodeURIComponent(id)}`);
          if(!res.ok){
            let errMsg = res.statusText;
            try{ const j = await res.json(); if(j && j.message) errMsg = j.message; }catch(e){}
            out[idx] = { id, status: 'error', error: errMsg };
          } else {
            const json = await res.json();
            if(!json || !json.success){ out[idx] = { id, status: 'error', error: (json && json.message) || 'Not found' }; }
            else { out[idx] = { id, status: 'ok', ticket: json.ticket }; }
          }
        }catch(err){
          console.error(err);
          out[idx] = { id, status: 'error', error: 'Network error' };
        }
        done++; setProgress(done, ids.length);
      }
    }

    const workers = Array.from({length: Math.min(concurrency, ids.length)}).map(()=>worker());
    await Promise.all(workers);
    return out;
  }

  function renderResults(){
    if(results.length === 0){ renderEmpty(); return; }
    list.innerHTML = '';
    results.forEach(r => {
      const wrapper = document.createElement('div'); wrapper.className = 'item';
      if(r.status === 'error'){
        wrapper.innerHTML = `<h3 style="color:var(--danger)">${escapeHtml(r.id)} <small style="color:var(--muted)">— error</small></h3><div class="meta">${escapeHtml(r.error)}</div>`;
      } else {
        const t = r.ticket;
        const created = t.createdAt ? new Date(t.createdAt).toLocaleString() : (t.created_at? new Date(t.created_at).toLocaleString(): '—');
        wrapper.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h3>${escapeHtml(t.id || t.ticketId || r.id)} <small style="color:var(--muted)">— ${escapeHtml(t.status||'open')}</small></h3>
            <div style="text-align:right"><div class="small">${escapeHtml(t.department||'—')}</div><div class="small">${escapeHtml(t.urgency||'—')}</div></div>
          </div>
          <div class="meta">Created: ${escapeHtml(created)}</div>
          <div style="margin-top:8px">${escapeHtml((t.issue || t.message || t.summary || 'No description').slice(0,400))}${(t.issue||t.message||'').length>400?'…':''}</div>
          <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
            <button class="btn ghost" data-id="${escapeHtml(r.id)}" data-action="view">View</button>
            <button class="btn ghost" data-id="${escapeHtml(r.id)}" data-action="history">History</button>
            <button class="btn ghost" data-id="${escapeHtml(r.id)}" data-action="copy">Copy JSON</button>
          </div>
        `;
      }
      list.appendChild(wrapper);
    });

    // attach handlers
    list.querySelectorAll('button[data-action]').forEach(b => {
      b.onclick = (e) => {
        const id = b.dataset.id;
        const action = b.dataset.action;
        const record = results.find(x=>x.id===id);
        if(!record) return;
        if(action === 'view'){ openModal(record.ticket || null); }
        if(action === 'history'){ openModal(record.ticket || null, true); }
        if(action === 'copy'){ copyToClipboard(JSON.stringify(record.ticket || {})); }
      };
    });
  }

  function openModal(ticket, showHistory=false){
    if(!ticket){ alert('No ticket data'); return; }
    modalTitle.textContent = `${ticket.id || ticket.ticketId || 'Ticket'}`;
    let html = `<div class="meta"><strong>Status:</strong> ${escapeHtml(ticket.status||'—')} • <strong>Dept:</strong> ${escapeHtml(ticket.department||'—')} • <strong>Urgency:</strong> ${escapeHtml(ticket.urgency||'—')}</div>`;
    html += `<h4 style="margin-top:10px">Description</h4><pre>${escapeHtml(ticket.issue || ticket.message || ticket.summary || 'No description')}</pre>`;
    if(Array.isArray(ticket.history) && ticket.history.length>0){
      html += `<h4 style="margin-top:10px">History</h4>`;
      html += ticket.history.map(h => `<div style="margin-bottom:6px"><strong>${escapeHtml(h.actor||h.user||'System')}</strong> <span style="color:var(--muted)">(${escapeHtml(h.action||h.type||'')})</span><div style="color:var(--muted);font-size:13px">${escapeHtml(h.at || h.timestamp || '')}</div><div style="margin-top:4px">${escapeHtml(h.note||h.message||'')}</div></div>`).join('');
    } else if(showHistory){
      html += '<div class="small">No history available</div>';
    }

    modalBody.innerHTML = html;
    modalBackdrop.style.display = 'flex'; modalBackdrop.setAttribute('aria-hidden','false');
  }

  function closeModalFn(){ modalBackdrop.style.display='none'; modalBackdrop.setAttribute('aria-hidden','true'); }
  closeModal.onclick = closeModalFn;
  modalBackdrop.onclick = (e)=>{ if(e.target === modalBackdrop) closeModalFn(); };

  function copyToClipboard(text){ navigator.clipboard && navigator.clipboard.writeText ? navigator.clipboard.writeText(text).then(()=> alert('Copied')) : (prompt('Copy', text)); }

  function escapeHtml(str){ return String(str||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[c]); }

  function toCSV(records){
    const keys = ['id','status','department','urgency','createdAt','issue'];
    const rows = records.map(r => {
      const t = r.ticket || {};
      return keys.map(k => '"'+String(t[k]||'').replace(/"/g,'""')+'"').join(',');
    });
    return [keys.join(',')].concat(rows).join('\n');
  }

  // Exports
  btnExportJson.onclick = ()=>{
    if(results.length===0) return alert('No results to export');
    const data = JSON.stringify(results.map(r=>r.ticket||{ id: r.id }), null, 2);
    const blob = new Blob([data], {type:'application/json'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='tickets.json'; a.click(); URL.revokeObjectURL(url);
  };

  btnExportCsv.onclick = ()=>{
    if(results.length===0) return alert('No results to export');
    const csv = toCSV(results);
    const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='tickets.csv'; a.click(); URL.revokeObjectURL(url);
  };

  btnCopyAll.onclick = ()=>{
    if(results.length===0) return alert('Nothing to copy'); copyToClipboard(JSON.stringify(results.map(r=>r.ticket||{ id: r.id }), null, 2)); };

  btnClear.onclick = ()=>{ ta.value=''; results = []; setProgress(0,0); renderEmpty(); };

  fileInput.onchange = async (e)=>{
    const f = e.target.files && e.target.files[0]; if(!f) return;
    const text = await f.text(); ta.value = (ta.value ? ta.value + '\n' : '') + text;
  };

  // Main lookup handler
  btnLookup.addEventListener('click', async ()=>{
    const raw = ta.value.trim();
    list.innerHTML = '';
    results = [];
    if(!raw){ renderEmpty(); return; }

    const ids = sanitizeIds(raw);
    // show skeletons
    list.innerHTML = ids.map(id=>`<div class="item"><h3>${escapeHtml(id)} <small style="color:var(--muted)">— loading</small></h3><div class="meta">Loading…</div></div>`).join('');

    // fetch with concurrency
    results = await fetchWithConcurrency(ids, 4);
    renderResults();
  });

  // utility: sanitize ids with commas too
  function sanitizeIds(raw){
    // split on newlines and commas
    return raw.split(/[\n,]+/).map(s=>s.trim()).filter(Boolean);
  }

  // init
  renderEmpty(); setProgress(0,0);

</script>
</body>
</html>
