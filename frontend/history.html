<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ticket History — Tomoca IT</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f6f4f2;padding:28px}
    .card{max-width:820px;margin:0 auto;background:#fff;padding:18px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    h1{margin:0 0 8px;font-size:20px}
    textarea{width:100%;min-height:90px;padding:10px;border-radius:8px;border:1px solid #ddd}
    button{margin-top:10px;padding:10px 14px;border-radius:8px;border:0;background:#8b4513;color:#fff;font-weight:700;cursor:pointer}
    .list{margin-top:12px}
    .item{padding:10px;border-radius:8px;border:1px solid #eee;background:#fafafa;margin-bottom:8px}
    .small{font-size:0.9rem;color:#444}
  </style>
</head>
<body>
  <div class="card">
    <h1>Ticket Lookup (multiple)</h1>
    <p class="small">Paste one Ticket ID per line, then click "Lookup".</p>

    <textarea id="ids" placeholder="TOM-176..."></textarea>
    <button id="btnLookup">Lookup tickets</button>

    <div id="list" class="list"></div>
  </div>

<script>
  const BACKEND_BASE = 'https://tomoca.onrender.com';
  const btn = document.getElementById('btnLookup');
  const ta = document.getElementById('ids');
  const list = document.getElementById('list');

  btn.addEventListener('click', async () => {
    const raw = ta.value.trim();
    list.innerHTML = '';
    if (!raw) { 
      list.innerHTML = '<div class="small">Please paste at least one Ticket ID.</div>'; 
      return; 
    }

    const ids = raw.split(/\r?\n/).map(s => s.trim()).filter(Boolean);

    for (const id of ids) {
      const wrapper = document.createElement('div');
      wrapper.className = 'item';
      wrapper.innerHTML = `<strong>${id}</strong> — loading...`;
      list.appendChild(wrapper);

      try {
        // FIXED ROUTE
        const res = await fetch(`${BACKEND_BASE}/ticket?id=${encodeURIComponent(id)}`);

        if (!res.ok) {
          const err = await res.json().catch(()=>null);
          wrapper.innerHTML = `<strong>${id}</strong> — <span style="color:#b33">${err?.message || res.statusText}</span>`;
          continue;
        }

        const data = await res.json();

        if (!data.success) {
          wrapper.innerHTML = `<strong>${id}</strong> — <span style="color:#b33">${data.message || 'Not found'}</span>`;
          continue;
        }

        const t = data.ticket;

        wrapper.innerHTML = `
          <div><strong>ID:</strong> ${t.id}</div>
          <div><strong>Status:</strong> ${t.status}</div>
          <div><strong>Dept:</strong> ${t.department}</div>
          <div><strong>Urgency:</strong> ${t.urgency}</div>
          <div class="small"><strong>Created:</strong> ${new Date(t.createdAt).toLocaleString()}</div>
        `;
      } catch (err) {
        console.error(err);
        wrapper.innerHTML = `<strong>${id}</strong> — <span style="color:#b33">Network error</span>`;
      }
    }
  });
</script>
</body>
</html>
